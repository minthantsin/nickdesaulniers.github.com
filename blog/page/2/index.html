
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nick Desaulniers</title>
  <meta name="author" content="Nick Desaulniers">

  
  <meta name="description" content="ECMAScript 5&rsquo;s
Function.prototype.bind
is a great tool that&rsquo;s implemented in all
modern browser JavaScript engines.
It allows you to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nickdesaulniers.github.io/blog/page/2">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nick Desaulniers" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36993986-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Nick Desaulniers</a></h1>
  
    <h2>The enemy's gate is down</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:nickdesaulniers.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/publications">Publications</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/26/function-dot-prototype-dot-bind-edge-cases/">Function.prototype.bind Edge Cases</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-26T21:00:00-07:00" pubdate data-updated="true">Sep 26<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/26/function-dot-prototype-dot-bind-edge-cases/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ECMAScript 5&rsquo;s
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">Function.prototype.bind</a>
is a great tool that&rsquo;s implemented in all
<a href="http://kangax.github.io/es5-compat-table/#Function.prototype.bind">modern browser JavaScript engines</a>.
It allows you to modify the context,
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">this</a>,
of a function when it is evaluated in the future.  Knowing what <code>this</code> refers to
in various contexts is key to being a professional JavaScript developer; don&rsquo;t
show up to an interview without knowing all about it.</p>

<p>Here&rsquo;s a common use case that developers need to watch for.  Can you spot the
mistake?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="s2">&quot;Bill&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">hi</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hi &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hi</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ooops!!! Turns out that since we added the event listener to the window object,
<code>this</code> in the event handler or callback refers to <code>window</code>.  So this code prints
<code>"Hi Bill"</code> instead of <code>"Hi Nick"</code>.  We could wrap <code>obj.hi</code> in an anonymous function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">obj</span><span class="p">.</span><span class="nx">hi</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>But that is so needlessly verbose and what we were trying to avoid in the first
place.  The three functions you should know for modifying <code>this</code> (a question I
ask all
my interview candidates) are
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call">Function.prototype.call</a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/apply">Function.prototype.apply</a>,
and
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">Function.prototype.bind</a>.
<code>call</code> is variadic, while <code>apply</code> takes an array of
arguments, but the two both immediately invoke the function.  We don&rsquo;t want to
do that just yet.  The fix we need is <code>Function.prototype.bind</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hi</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>There, now isn&rsquo;t that nice and short?  Instead of saving <code>this</code> as another
variable then closing over it, you can instead use <code>bind</code>!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">wait</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">person</span> <span class="o">+</span> <span class="s2">&quot; clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>becomes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">wait</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span> <span class="o">+</span> <span class="s2">&quot; clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>No need to store <code>this</code> into <code>self</code>, then close over it.  One great shortcut I
use all the time is creating an alias for <code>document.getElementById</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;someElementsId&#39;</span><span class="p">).</span><span class="nx">doSomething</span><span class="p">();</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;anotherElement&#39;</span><span class="p">).</span><span class="nx">doSomethingElse</span><span class="p">();</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;aThirdElement&#39;</span><span class="p">).</span><span class="nx">doSomethingDifferent</span><span class="p">();</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;theFifthElementOops&#39;</span><span class="p">).</span><span class="nx">doSomethingFun</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why did I bind <code>getElementById</code> back to <code>document</code>?  Try it without the call to
bind.  Any luck?</p>

<p><code>bind</code> can also be great for partially applying functions, too.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">add</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;a: &quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;b: &quot;</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="nx">add</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>will print</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">a</span><span class="o">:</span> <span class="mi">4</span>
</span><span class='line'><span class="nx">b</span><span class="o">:</span> <span class="mi">7</span>
</span><span class='line'><span class="mi">11</span>
</span></code></pre></td></tr></table></div></figure>


<p>What <code>Function.prototype.bind</code> is essentially doing is wrapping <code>add</code> in a
function that essentially looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">add</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The array has the captured arguments (just <code>4</code>), and is converting <code>todo</code>&rsquo;s
<code>arguments</code> into an array (a common idiom for converting &ldquo;Array-like&rdquo; objects
into
Arrays), then joining (<code>concat</code>) them and invoking the bound function (<code>apply</code>)
with
the value for <code>this</code> (in this case, <code>null</code>).</p>

<p>In fact, if you look at
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind#Compatibility">the compatibility section of the MDN page for bind</a>,
you&rsquo;ll see a function that returns a function that is essentially the above.
One caveat is that this approach only allows you to partially apply variables in
order.</p>

<p>So <code>bind</code> is a great addition to the language.  Now to the point I wanted to
make;
there are edge cases when <code>bind</code> doesn&rsquo;t work or might trip you up.  The first
is that <code>bind</code>
evaluates
its <code>arguments</code> when bound, not when invoked.  The other is that <code>bind</code> returns
a new
function, always.  And the final is to be careful binding to variadic functions
when you don&rsquo;t intend to use all of the passed in variables.  Um, duh right?
Well, let me show you three examples that have bitten me (recently).  The first
is with ajax calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">crunch</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// operate on data</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
</span><span class='line'><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;data.json&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">crunch</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
</span><span class='line'><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oops, while I do want to operate on <code>this.result</code> within <code>crunch</code> with <code>this</code>
referring to <code>xhr</code>, <code>this</code> at the time of binding was referring to <code>window</code>!
Let&rsquo;s
hope <code>window.results</code> is <code>undefined</code>!  What if we changed <code>this.result</code> with
<code>xhr.result</code>?  Well, we&rsquo;re no longer referring to the <code>window</code> object, but
<code>xhr.result</code> is evaluated at bind time (and for an unsent <code>XMLHttpRequest</code>
object,
is <code>null</code>), so we&rsquo;ve bound <code>null</code> as the first argument.  We must delay the
handling
of <code>xhr.onload</code>; either use an anonymous function inline or named function to
control nesting depth.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">crunch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next is that <code>bind</code> always returns a new function.  Dude, it says that in
the docs,
<a href="http://xkcd.com/293/">RTFM</a>.
Yeah I know, but this case still caught me.  When removing an event
listener, you need to supply the <strong>same</strong> handler function.  Example, a <code>once</code>
function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">todo</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;myCustomEvent&quot;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;myCustomEvent&quot;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span> <span class="p">}));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try firing <code>myCustomEvent</code> twice, see what happens!  <code>"Nick"</code> is logged twice.
A <code>once</code> function that handles two separate events is not very good.  In fact,
it will continue
to handle events, since <code>document</code> does not have <code>todo</code> as an event handler for
<code>myCustomEvent</code>
events.  The event listener you bound was a new function; <code>bind</code> always returns
a new function.  The solution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">);</span>
</span><span class='line'>  <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;myCustomEvent&quot;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">);</span>
</span><span class='line'><span class="p">}.</span><span class="nx">bind</span><span class="p">({</span> <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span> <span class="p">});</span>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;myCustomEvent&quot;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>That would be a good interview question.  The final gotcha is with functions
that are variadic.  Extending one of my earlier examples:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">wait</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">someButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span> <span class="o">+</span> <span class="s2">&quot; clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say I thought I could use bind to simplify the <code>onclick</code> using the trick I
did with <code>document.getElementById</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">person</span><span class="o">:</span> <span class="s2">&quot;Nick&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">wait</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">someButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">person</span> <span class="o">+</span> <span class="s2">&quot; clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">someButton</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Can you guess what this prints?  It does prints the expected, but with an
unexpected addition.  Think about what I said about variadic functions.  What
might be wrong here?</p>

<p>Turns out this prints
<code>"Nick clicked! [object MouseEvent]"</code>  This one took me a while to think
through, but luckily I had other experiences with <code>bind</code> that helped me understand
why this occurred.</p>

<p><code>console.log</code> is variadic, so it prints all of its arguments.  When we called
<code>bind</code>
on <code>console.log</code>, we set the <code>onclick</code> handler to be a new function that applied
that expected output with any additional arguments.  Well, <code>onclick</code> handlers are
passed a <code>MouseEvent</code> object (think <code>e.target</code>), which winds up being passed as
the second
argument to <code>console.log</code>.  If this was the example with <code>add</code> from earlier,
<code>this.person + " clicked!"</code> would be the <code>4</code> and the <code>MouseEvent</code> would be the
<code>7</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">someButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Nick clicked!&quot;</span><span class="p">].</span><span class="nx">concat</span><span class="p">([</span><span class="nx">e</span><span class="p">]));</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>I love <code>bind</code>, but sometimes, it will get you.  What are some examples of times
when you&rsquo;ve been bitten by <code>bind</code>?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/28/making-great-node-dot-js-modules-with-coffeescript/">Making Great Node.js Modules With CoffeeScript</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-28T10:51:00-07:00" pubdate data-updated="true">Aug 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/08/28/making-great-node-dot-js-modules-with-coffeescript/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://nodejs.org/">Node.js</a>
is a great runtime for writing applications in JavaScript, the language
I primarily develop in.
<a href="http://coffeescript.org/">CoffeeScript</a>
is a programming language that compiles
to JavaScript.  Why would we write a reusable piece of code, a
<a href="http://nodejs.org/api/modules.html">module</a>
, in
CoffeeScript?  CoffeeScript is a very high level language and
<a href="http://railscasts.com/episodes/267-coffeescript-basics">beautifully brings together</a>
my favorite aspects of JavaScript,
Ruby, and Python.  In this tutorial, I&rsquo;ll show you how I create reusable open
source modules for Node.js from CoffeeScript, which is something I recently
discovered while creating a
<a href="https://github.com/nickdesaulniers/javascript-playlist-parser">playlist parser module</a>.
The point is to focus on how to turn a quick hack into a nicely laid
out Node.js module.</p>

<p>The steps are as follows:</p>

<ol>
<li>Turn an idea into a git repo.</li>
<li>Add directory structure.</li>
<li>Split library functions from testing.</li>
<li>Add a Build script.</li>
<li>Create node module.</li>
<li>Add LICENSE and README.</li>
<li>Publish.</li>
</ol>


<p>First thing&rsquo;s first, we have to have an idea.  It doesn&rsquo;t have to be
revolutionary, just do one thing and do it well.  That is the first rule of
<a href="http://www.faqs.org/docs/artu/ch01s06.html">UNIX <del>fightclub</del> philosophy</a>,
which resonates well within
<a href="http://blog.izs.me/post/48281998870/unix-philosophy-and-node-js">the Node.js community</a>.
When I&rsquo;m hacking on
something, I start out with a single file to test something out.  Then I
progressively refine the example until it&rsquo;s something reusable.  That way, I
can reuse it, others can reuse it, others can learn from it, and the world can
be a better place.</p>

<p>For this tutorial, I&rsquo;ll show you my process for creating a binding for
<a href="http://nanomsg.org/index.html">nanomsg</a>,
the latest scalability protocol library from the creator of
<a href="http://zeromq.org/">ZeroMQ</a>,
<a href="http://250bpm.com/">Martin Sústrik</a>.
I had played with ZeroMQ in the past and thought that it was really
awesome, and I was excited to see a new library from it&rsquo;s creator, based on C,
since I also really enjoyed his post on why he
<a href="http://250bpm.com/blog:4">shouldn&rsquo;t have written it in C++</a>.</p>

<p>So messing around real quick, let&rsquo;s make sure we have node up to date.  I like
to use
<a href="https://github.com/creationix/nvm">nvm</a>
and the latest stable minor version of node (stable versions have
even minor patch numbers where versions are in the format <code>major.minor.patch</code>,
so v0.11.0 is unstable).  <code>node -v</code> &ndash;> v0.10.17</p>

<p>Then I need to download and install the library that I&rsquo;ll be dynamically
linking to, build, and install it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>curl -O http://download.nanomsg.org/nanomsg-0.1-alpha.zip &amp;&amp; \
</span><span class='line'>unzip nanomsg-0.1-alpha.zip &amp;&amp; \
</span><span class='line'>cd nanomsg-0.1-alpha &amp;&amp; \
</span><span class='line'>mkdir build &amp;&amp; \
</span><span class='line'>cd build &amp;&amp; \
</span><span class='line'>../configure &amp;&amp; \
</span><span class='line'>make &amp;&amp; \
</span><span class='line'>make install
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll use
<a href="https://github.com/rbranson/node-ffi">node&rsquo;s FFI module</a>
to interface with the dynamically linked library,
because it&rsquo;s easier to write bindings than using
<a href="http://nodejs.org/api/addons.html">native addons</a>,
and
<a href="https://github.com/rvagg/node-addon-examples/blob/master/README.md#compatibility-notes">v8&rsquo;s API has recently changed causing some headaches for native extensions</a>.</p>

<p><code>npm install ffi</code></p>

<p>We&rsquo;ll be writing the example in CoffeeScript.</p>

<p><code>npm install -g coffee-script</code></p>

<p>Now to mess around we can create main.coffee based on
<a href="https://github.com/250bpm/cppnanomsg/blob/9becc3d5116ab33a7d2c5f06d68a8fea1b781194/binding.cpp#L29">the C++ binding&rsquo;s example</a>:</p>

<figure class='code'><figcaption><span>main.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">ffi = </span><span class="nx">require</span> <span class="s">&#39;ffi&#39;</span>
</span><span class='line'><span class="nv">assert = </span><span class="nx">require</span> <span class="s">&#39;assert&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">AF_SP = </span><span class="mi">1</span>
</span><span class='line'><span class="nv">NN_PAIR = </span><span class="mi">16</span>
</span><span class='line'>
</span><span class='line'><span class="nv">nanomsg = </span><span class="nx">ffi</span><span class="p">.</span><span class="nx">Library</span> <span class="s">&#39;libnanomsg&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">nn_socket: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_bind: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_connect: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_send: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;pointer&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_recv: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;pointer&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_errno: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[]]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># test</span>
</span><span class='line'><span class="nv">s1 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">s1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;s1: &#39;</span> <span class="o">+</span> <span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_errno</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_bind</span> <span class="nx">s1</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;bind&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">s2 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">s2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;s2: &#39;</span> <span class="o">+</span> <span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_errno</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_connect</span> <span class="nx">s2</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;connect&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">msg = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="s">&#39;hello&#39;</span>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_send</span> <span class="nx">s2</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;send&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">recv = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_recv</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">recv</span><span class="p">,</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;recv&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s">&#39;received message did not match sent&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>coffee main.coffee</code> &ndash;> hello</p>

<p>This quick example shows that we have something working.  Currently our working
directory should look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2
</span><span class='line'>.
</span><span class='line'>├── main.coffee
</span><span class='line'>└── node_modules
</span><span class='line'>    └── ffi
</span><span class='line'>
</span><span class='line'>2 directories, 1 file
</span></code></pre></td></tr></table></div></figure>


<h2>Turn an idea into a git repo</h2>

<p>Next up is to create a repository using a version control system like
<a href="http://git-scm.com/">git</a> and
start saving our work.
<a href="http://www.codinghorror.com/blog/2008/08/check-in-early-check-in-often.html">Check in early, check in often</a>.</p>

<p>Let&rsquo;s add a .gitignore so that were not adding files that really don&rsquo;t need to
be committed.  The node_modules folder is unnecessary because when this node
module is installed, its dependencies will be recursively installed, so
there&rsquo;s no need to commit them to source control.  The swap files are because I
use
<a href="http://www.vim.org/">vim</a>
and I accidentally commit the swap files from open buffers all the time
like a noob.</p>

<figure class='code'><figcaption><span>.gitignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>node_modules/
</span><span class='line'>*.swp
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s turn this into a git repo:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>git init &amp;&amp; \
</span><span class='line'>git add . &amp;&amp; \
</span><span class='line'>git commit -am “initial commit”
</span></code></pre></td></tr></table></div></figure>


<p>Up on github, let&rsquo;s <a href="https://github.com/new">create an uninitialized repo</a>
and push to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>git remote add origin git@github.com:nickdesaulniers/node-nanomsg.git &amp;&amp; \
</span><span class='line'>git push -u origin master
</span></code></pre></td></tr></table></div></figure>


<p>So we
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/19211e7520de9384a0d5b0ce4c08a623c4f2e0b9">have</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -a
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── main.coffee
</span><span class='line'>└── node_modules
</span><span class='line'>    └── ffi
</span><span class='line'>
</span><span class='line'>2 directories, 2 files
</span></code></pre></td></tr></table></div></figure>


<h2>Add directory structure</h2>

<p>Now that we have our repo under version control, let&rsquo;s start adding some
structure. Let&rsquo;s create
<code>src/</code>, <code>lib/</code>, and <code>test/</code> directories.  Our CoffeeScript will live in
<code>src/</code>, compiled JavaScript will be in <code>lib/</code>, and our test code will be in
<code>test/</code>.</p>

<p><code>mkdir src lib test</code></p>

<h2>Split library functions from testing</h2>

<p>Now let&rsquo;s move a copy of <code>main.coffee</code> into <code>src/</code> and one into <code>test/</code>.  We
are going to split the library definition away from the testing logic.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>cp main.coffee test/test.coffee &amp;&amp; \
</span><span class='line'>git add test/test.coffee &amp;&amp; \
</span><span class='line'>git mv main.coffee src/nanomsg.coffee
</span></code></pre></td></tr></table></div></figure>


<p>This way <code>git status</code> tells us:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># On branch master
</span><span class='line'># Changes to be committed:
</span><span class='line'>#   (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)
</span><span class='line'>#
</span><span class='line'># renamed:    main.coffee -&gt; src/nanomsg.coffee
</span><span class='line'># new file:   test/test.coffee
</span><span class='line'>#
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s edit src/main.coffee to look like:</p>

<figure class='code'><figcaption><span>src/main.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">ffi = </span><span class="nx">require</span> <span class="s">&#39;ffi&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">exports = module.exports = </span><span class="nx">ffi</span><span class="p">.</span><span class="nx">Library</span> <span class="s">&#39;libnanomsg&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">nn_socket: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_bind: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_connect: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span> <span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_send: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;pointer&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_recv: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;pointer&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">]]</span>
</span><span class='line'>  <span class="nv">nn_errno: </span><span class="p">[</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="p">[]]</span>
</span><span class='line'>
</span><span class='line'><span class="nv">exports.AF_SP = </span><span class="mi">1</span>
</span><span class='line'><span class="nv">exports.NN_PAIR = </span><span class="mi">16</span>
</span></code></pre></td></tr></table></div></figure>


<p>and edit the tests to:</p>

<figure class='code'><figcaption><span>test/test.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">assert = </span><span class="nx">require</span> <span class="s">&#39;assert&#39;</span>
</span><span class='line'><span class="nv">nanomsg = </span><span class="nx">require</span> <span class="s">&#39;../lib/nanomsg.js&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">nanomsg</span>
</span><span class='line'>
</span><span class='line'><span class="nv">s1 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">s1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;s1: &#39;</span> <span class="o">+</span> <span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_errno</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_bind</span> <span class="nx">s1</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;bind&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">s2 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">s2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;s2: &#39;</span> <span class="o">+</span> <span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_errno</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_connect</span> <span class="nx">s2</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;connect&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">msg = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="s">&#39;hello&#39;</span>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_send</span> <span class="nx">s2</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;send&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">recv = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span>
</span><span class='line'><span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_recv</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">recv</span><span class="p">,</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nx">assert</span> <span class="nx">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;recv&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">assert</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s">&#39;received message did not match sent&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how in the test we&rsquo;re including the compiled javascript from <code>lib/</code>
which doesn&rsquo;t exist yet?  If you try running <code>coffee test/test.coffee</code> it
should crash.  Let&rsquo;s make the compiled version.
<code>coffee -o lib -c src/nanomsg.coffee</code></p>

<p>Once the compiled lib exists, we can run our tests with
<code>coffee test/test.coffee</code> and shouldn&rsquo;t see any errors.</p>

<p>Now we should have a little more order, let&rsquo;s
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/3e3e3918971e2eddbe95e91e0c3cf32e7f8becba">commit</a>.
Hold off on adding
<code>lib/</code> to version control, I&rsquo;ll explain why in a bit.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -C -a -I &#39;.git&#39;
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── lib
</span><span class='line'>│   └── nanomsg.js
</span><span class='line'>├── node_modules
</span><span class='line'>│   └── ffi
</span><span class='line'>├── src
</span><span class='line'>│   └── nanomsg.coffee
</span><span class='line'>└── test
</span><span class='line'>    └── test.coffee
</span><span class='line'>
</span><span class='line'>5 directories, 4 files
</span></code></pre></td></tr></table></div></figure>


<p>At this point, if we add features and want to rerun our tests, we need to
execute:</p>

<p><code>coffee -o lib -c src/nanomsg.coffee &amp;&amp; coffee test/test.coffee</code></p>

<p>While this command is simple now and easy to reverse search, anyone else
contributing to you project is going to have to know the commands to run the
tests.  Let&rsquo;s use
<a href="http://gruntjs.com/">Grunt</a>,
the JavaScript task runner, to automate our build and test process.</p>

<h2>Add a Build script</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>npm install -g grunt-cli &amp;&amp; \
</span><span class='line'>npm install grunt-contrib-coffee
</span></code></pre></td></tr></table></div></figure>


<p>Create a simple Gruntfile which can also be written in CoffeeScript:</p>

<figure class='code'><figcaption><span>Gruntfile.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">module.exports = </span><span class="nf">(grunt) -&gt;</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span>
</span><span class='line'>    <span class="nv">coffee:</span>
</span><span class='line'>      <span class="nv">compile:</span>
</span><span class='line'>        <span class="nv">files:</span>
</span><span class='line'>          <span class="s">&#39;lib/nanomsg.js&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s">&#39;src/*.coffee&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span> <span class="s">&#39;grunt-contrib-coffee&#39;</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;coffee&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running <code>grunt</code> builds our lib which is a start, so let&rsquo;s
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/293e7378225c761ec496d9dcd09e1f2d331628a2">commit</a>
that.</p>

<p>But <code>grunt</code> is not running our tests.  And our tests don&rsquo;t have nice output.
Let&rsquo;s change that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>npm install -g mocha &amp;&amp; \
</span><span class='line'>npm install chai grunt-mocha-test
</span></code></pre></td></tr></table></div></figure>


<p>edit test/test.coffee to:</p>

<figure class='code'><figcaption><span>test/test.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">assert = </span><span class="nx">require</span> <span class="s">&#39;assert&#39;</span>
</span><span class='line'><span class="nv">should = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;chai&#39;</span><span class="p">).</span><span class="nx">should</span><span class="p">()</span>
</span><span class='line'><span class="nv">nanomsg = </span><span class="nx">require</span> <span class="s">&#39;../lib/nanomsg.js&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span> <span class="s">&#39;nanomsg&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nx">it</span> <span class="s">&#39;should at least work&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>    <span class="p">{</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">nanomsg</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">s1 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'>    <span class="nx">s1</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">at</span><span class="p">.</span><span class="nx">least</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_bind</span> <span class="nx">s1</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'>    <span class="nx">ret</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">above</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">s2 = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_socket</span> <span class="nx">AF_SP</span><span class="p">,</span> <span class="nx">NN_PAIR</span>
</span><span class='line'>    <span class="nx">s2</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">at</span><span class="p">.</span><span class="nx">least</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_connect</span> <span class="nx">s2</span><span class="p">,</span> <span class="s">&#39;inproc://a&#39;</span>
</span><span class='line'>    <span class="nx">ret</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">above</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">msg = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="s">&#39;hello&#39;</span>
</span><span class='line'>    <span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_send</span> <span class="nx">s2</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nx">ret</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">above</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">recv = </span><span class="k">new</span> <span class="nx">Buffer</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span>
</span><span class='line'>    <span class="nv">ret = </span><span class="nx">nanomsg</span><span class="p">.</span><span class="nx">nn_recv</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">recv</span><span class="p">,</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nx">ret</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">above</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span> <span class="nx">recv</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>and modify your gruntfile to add a testing step:</p>

<figure class='code'><figcaption><span>Gruntfile.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">module.exports = </span><span class="nf">(grunt) -&gt;</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span>
</span><span class='line'>    <span class="nv">coffee:</span>
</span><span class='line'>      <span class="nv">compile:</span>
</span><span class='line'>        <span class="nv">files:</span>
</span><span class='line'>          <span class="s">&#39;lib/nanomsg.js&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s">&#39;src/*.coffee&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="nv">mochaTest:</span>
</span><span class='line'>      <span class="nv">options:</span>
</span><span class='line'>        <span class="nv">reporter: </span><span class="s">&#39;nyan&#39;</span>
</span><span class='line'>      <span class="nv">src: </span><span class="p">[</span><span class="s">&#39;test/test.coffee&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span> <span class="s">&#39;grunt-contrib-coffee&#39;</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span> <span class="s">&#39;grunt-mocha-test&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;coffee&#39;</span><span class="p">,</span> <span class="s">&#39;mochaTest&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when we run <code>grunt</code>, our build process will run, then our test process,
then we should see one incredibly happy
<a href="http://www.nyan.cat/">nyan cat</a>.
The
<a href="http://visionmedia.github.io/mocha/#reporters">nyan cat mocha test reporter</a>
is basically the pinnacle of human intellectual achievement.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>grunt
</span><span class='line'>Running &quot;coffee:compile&quot; (coffee) task
</span><span class='line'>File lib/nanomsg.js created.
</span><span class='line'>
</span><span class='line'>Running &quot;mochaTest:src&quot; (mochaTest) task
</span><span class='line'> 1   -__,------,
</span><span class='line'> 0   -__|  /\_/\
</span><span class='line'> 0   -_~|_( ^ .^)
</span><span class='line'>     -_ &quot;&quot;  &quot;&quot;
</span><span class='line'>
</span><span class='line'>  1 passing (5 ms)
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Done, without errors.
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/nickdesaulniers/node-nanomsg/commit/a43bcb3f69ca20bb1902472ecc954317e5fe0fe3">Commit time</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -C -a -I &#39;.git&#39;
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── Gruntfile.coffee
</span><span class='line'>├── lib
</span><span class='line'>│   └── nanomsg.js
</span><span class='line'>├── node_modules
</span><span class='line'>│   ├── ffi
</span><span class='line'>│   ├── grunt
</span><span class='line'>│   └── grunt-contrib-coffee
</span><span class='line'>├── src
</span><span class='line'>│   └── nanomsg.coffee
</span><span class='line'>└── test
</span><span class='line'>    └── test.coffee
</span><span class='line'>
</span><span class='line'>7 directories, 5 files
</span></code></pre></td></tr></table></div></figure>


<h2>Create node module</h2>

<p>Now that we have a more modular design with build and test logic built in,
let&rsquo;s make this module redistributable.  First, let&rsquo;s talk about ignoring
files.  Create a <code>.npmignore</code> file that will specify what not to include in the
module that is downloaded.  Node Package Manager,
<a href="https://npmjs.org/">npm</a>,
will
<a href="https://npmjs.org/doc/developers.html#Keeping-files-out-of-your-package">ignore a bunch of files by default</a>
for us.</p>

<figure class='code'><figcaption><span>.npmignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Gruntfile.coffee
</span><span class='line'>src/
</span><span class='line'>test/
</span></code></pre></td></tr></table></div></figure>


<p>Here we&rsquo;re ignoring the <code>src/</code> dir, where in our <code>.gitignore</code> we are going to
ignore <code>lib/</code>.</p>

<figure class='code'><figcaption><span>.gitignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>node_modules/
</span><span class='line'>lib/
</span><span class='line'>*.swp
</span></code></pre></td></tr></table></div></figure>


<p>Why are we doing this?  Admittedly, none of this is strictly necessary, but
here&rsquo;s why I think it is useful.  When someone is checking out the source, they
don&rsquo;t need the results of the compilation step, as they can make modifications
and would need to recompile anyways.  Adding <code>lib/nanomsg.js</code> would just be
another thing to download (though its size is relatively insignificant).
Likewise, when someone downloads the module, they most likely just want the
results of the compilation step, not the source, build script, or test suite.
If I was planned on making the compiled JavaScript accessible to a web browser,
I would not add <code>lib/</code> to <code>.gitignore</code>, that way it could be referenced from the
github raw URL.
Again, these are generalizations that are not always true.  To make up for not
having the entire source when installed as a module, we&rsquo;ll make up for it by
adding a link to the repo from of manifest, but first let&rsquo;s
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/61458d964eaaee2ae6501bfbd186a1fe0d03d827">commit</a>!</p>

<p>Time to create a manifest file that has some basic info about our app.  It&rsquo;s a
pretty good idea to run <code>npm search &lt;packagename&gt;</code> before hand to make sure
your planned package name is not taken.  Since we have all of our dependencies
in a row, let&rsquo;s run
<code>npm init</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>This utility will walk you through creating a package.json file.
</span><span class='line'>It only covers the most common items, and tries to guess sane defaults.
</span><span class='line'>
</span><span class='line'>See `npm help json` for definitive documentation on these fields
</span><span class='line'>and exactly what they do.
</span><span class='line'>
</span><span class='line'>Use `npm install &lt;pkg&gt; --save` afterwards to install a package and
</span><span class='line'>save it as a dependency in the package.json file.
</span><span class='line'>
</span><span class='line'>Press ^C at any time to quit.
</span><span class='line'>name: (nanomsg)
</span><span class='line'>version: (0.0.0)
</span><span class='line'>description: nanomsg bindings
</span><span class='line'>entry point: (index.js) lib/nanomsg.js
</span><span class='line'>test command: grunt
</span><span class='line'>git repository: (git://github.com/nickdesaulniers/node-nanomsg.git)
</span><span class='line'>keywords: nanomsg
</span><span class='line'>author: Nick Desaulniers
</span><span class='line'>license: (BSD-2-Clause) Beerware
</span><span class='line'>About to write to /Users/Nicholas/code/c/nanomsg/package.json:
</span><span class='line'>
</span><span class='line'>{
</span><span class='line'>  &quot;name&quot;: &quot;nanomsg&quot;,
</span><span class='line'>  &quot;version&quot;: &quot;0.0.0&quot;,
</span><span class='line'>  &quot;description&quot;: &quot;nanomsg bindings&quot;,
</span><span class='line'>  &quot;main&quot;: &quot;lib/nanomsg.js&quot;,
</span><span class='line'>  &quot;directories&quot;: {
</span><span class='line'>    &quot;test&quot;: &quot;test&quot;
</span><span class='line'>  },
</span><span class='line'>  &quot;dependencies&quot;: {
</span><span class='line'>    &quot;chai&quot;: &quot;~1.7.2&quot;,
</span><span class='line'>    &quot;ffi&quot;: &quot;~1.2.5&quot;,
</span><span class='line'>    &quot;grunt&quot;: &quot;~0.4.1&quot;,
</span><span class='line'>    &quot;grunt-mocha-test&quot;: &quot;~0.6.3&quot;,
</span><span class='line'>    &quot;grunt-contrib-coffee&quot;: &quot;~0.7.0&quot;
</span><span class='line'>  },
</span><span class='line'>  &quot;devDependencies&quot;: {},
</span><span class='line'>  &quot;scripts&quot;: {
</span><span class='line'>    &quot;test&quot;: &quot;grunt&quot;
</span><span class='line'>  },
</span><span class='line'>  &quot;repository&quot;: {
</span><span class='line'>    &quot;type&quot;: &quot;git&quot;,
</span><span class='line'>    &quot;url&quot;: &quot;git://github.com/nickdesaulniers/node-nanomsg.git&quot;
</span><span class='line'>  },
</span><span class='line'>  &quot;keywords&quot;: [
</span><span class='line'>    &quot;nanomsg&quot;
</span><span class='line'>  ],
</span><span class='line'>  &quot;author&quot;: &quot;Nick Desaulniers&quot;,
</span><span class='line'>  &quot;license&quot;: &quot;Beerware&quot;,
</span><span class='line'>  &quot;bugs&quot;: {
</span><span class='line'>    &quot;url&quot;: &quot;https://github.com/nickdesaulniers/node-nanomsg/issues&quot;
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Is this ok? (yes)
</span></code></pre></td></tr></table></div></figure>


<p>That should create for us a nice package.json manifest file for npm.</p>

<p>We can now run our tests with the command <code>npm test</code> in addition to <code>grunt</code>.
Let&rsquo;s hold off on publishing just yet,
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/6ac3425005c69683df85f75c49e27c9cb634ada6">committing</a>
instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -C -a -I &#39;.git&#39;
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── .npmignore
</span><span class='line'>├── Gruntfile.coffee
</span><span class='line'>├── lib
</span><span class='line'>│   └── nanomsg.js
</span><span class='line'>├── node_modules
</span><span class='line'>│   ├── .bin
</span><span class='line'>│   ├── chai
</span><span class='line'>│   ├── ffi
</span><span class='line'>│   ├── grunt
</span><span class='line'>│   ├── grunt-contrib-coffee
</span><span class='line'>│   └── grunt-mocha-test
</span><span class='line'>├── package.json
</span><span class='line'>├── src
</span><span class='line'>│   └── nanomsg.coffee
</span><span class='line'>└── test
</span><span class='line'>    └── test.coffee
</span><span class='line'>
</span><span class='line'>10 directories, 7 files
</span></code></pre></td></tr></table></div></figure>


<h2>Add LICENSE and README</h2>

<p>So we have a module that&rsquo;s almost ready to go.  But how will developers know
how to reuse this code?  As much as I like to
<em><a href="http://bartaz.github.io/impress.js/#/source">view the source, Luke</a></em>,
npm will complain without a readme.  The
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/95e5a7203740f8ab31758f54491d095567accf70">readme</a>
also looks nice on the github repo.</p>

<pre><code># Node-NanoMSG
Node.js binding for [nanomsg](http://nanomsg.org/index.html).

## Usage

`npm install nanomsg`

```javascript
var nanomsg = require('nanomsg');
var assert = require('assert');
var AF_SP = nanomsg.AF_SP;
var NN_PAIR = nanomsg.NN_PAIR;
var msg = new Buffer('hello');
var recv = new Buffer(msg.length);
var s1, s2, ret;

s1 = nanomsg.nn_socket(AF_SP, NN_PAIR);
assert(s1 &gt;= 0, 's1: ' + nanomsg.errno());

ret = nanomsg.nn_bind(s1, 'inproc://a');
assert(ret &gt; 0, 'bind');

s2 = nanomsg.nn_socket(AF_SP, NN_PAIR);
assert(s2 &gt;= 0, 's2: ' + nanomsg.errno());

ret = nanomsg.nn_connect(s2, 'inproc://a');
assert(ret &gt; 0, 'connect');

ret = nanomsg.nn_send(s2, msg, msg.length, 0);
assert(ret &gt; 0, 'send');

ret = nanomsg.recv(s1, recv, recv.length, 0);
assert(ret &gt; 0, 'recv');

assert(msg.toString() === recv.toString(), "didn't receive sent message");
console.log(recv.toString());
</code></pre>

<p>Before we publish, let&rsquo;s create a
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/48a55d0c51099f6b90cae5f190a8eb2b94140eae">license</a>
file, because though we are making
our code publicly viewable,
<a href="https://help.github.com/articles/open-source-licensing#what-happens-if-i-dont-choose-a-license">public source code without an explicit license is still under copyright and cannot be reused</a>.</p>

<figure class='code'><figcaption><span>LICENSE</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>/*
</span><span class='line'> * ----------------------------------------------------------------------------
</span><span class='line'> * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
</span><span class='line'> * &lt;nick@mozilla.com&gt; wrote this file. As long as you retain this notice you
</span><span class='line'> * can do whatever you want with this stuff. If we meet some day, and you think
</span><span class='line'> * this stuff is worth it, you can buy me a beer in return. Nick Desaulniers
</span><span class='line'> * ----------------------------------------------------------------------------
</span><span class='line'> */
</span></code></pre></td></tr></table></div></figure>


<p>If you want to be more serious, maybe instead shoot for an MIT or BSD style
license if you don&rsquo;t care what your repo gets used for or GPL style if you do.
<a href="http://www.tldrlegal.com/">TLDRLegal</a> has a great breakdown on common licenses.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -C -a -I &#39;.git&#39;
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── .npmignore
</span><span class='line'>├── Gruntfile.coffee
</span><span class='line'>├── LICENSE
</span><span class='line'>├── README.md
</span><span class='line'>├── lib
</span><span class='line'>│   └── nanomsg.js
</span><span class='line'>├── node_modules
</span><span class='line'>│   ├── .bin
</span><span class='line'>│   ├── chai
</span><span class='line'>│   ├── ffi
</span><span class='line'>│   ├── grunt
</span><span class='line'>│   ├── grunt-contrib-coffee
</span><span class='line'>│   └── grunt-mocha-test
</span><span class='line'>├── package.json
</span><span class='line'>├── src
</span><span class='line'>│   └── nanomsg.coffee
</span><span class='line'>└── test
</span><span class='line'>    └── test.coffee
</span><span class='line'>
</span><span class='line'>10 directories, 9 files
</span></code></pre></td></tr></table></div></figure>


<h2>Publish</h2>

<p><code>npm publish</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>npm http PUT https://registry.npmjs.org/nanomsg
</span><span class='line'>npm http 201 https://registry.npmjs.org/nanomsg
</span><span class='line'>npm http GET https://registry.npmjs.org/nanomsg
</span><span class='line'>npm http 200 https://registry.npmjs.org/nanomsg
</span><span class='line'>npm http PUT https://registry.npmjs.org/nanomsg/-/nanomsg-0.0.0.tgz/-rev/1-20f1ec5ca2eed51e840feff22479bb5d
</span><span class='line'>npm http 201 https://registry.npmjs.org/nanomsg/-/nanomsg-0.0.0.tgz/-rev/1-20f1ec5ca2eed51e840feff22479bb5d
</span><span class='line'>npm http PUT https://registry.npmjs.org/nanomsg/0.0.0/-tag/latest
</span><span class='line'>npm http 201 https://registry.npmjs.org/nanomsg/0.0.0/-tag/latest
</span><span class='line'>+ nanomsg@0.0.0
</span></code></pre></td></tr></table></div></figure>


<p>Finally as a sanity check, I like to make a new folder elsewhere, and run
through the steps in the readme manually to make sure the package is reuseable.
Which is good, since in the readme I
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/c145d3b3a8e85354f1bfb61d8342531ec6bbaa0a">accidentally forgot</a>
the <code>nn_</code> prefix in
front of errno and recv!</p>

<p>After updating the example in the readme, let&rsquo;s
<a href="https://github.com/nickdesaulniers/node-nanomsg/commit/a6280ca85c4b9cbaac36f5b427bc052961d7e972">bump the version number</a>
and
republish.  Use <code>npm version</code> without arguments to find the current version,
then <code>npm version patch</code> to bump it.  You have to commit the readme changes
before bumping the version.  Finally don&rsquo;t forget to rerun <code>npm publish</code>.</p>

<p>Our
<a href="https://github.com/nickdesaulniers/node-nanomsg/tree/a6280ca85c4b9cbaac36f5b427bc052961d7e972">final directory structure</a>
ends up looking like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>tree -L 2 -C -a -I &#39;.git&#39;
</span><span class='line'>.
</span><span class='line'>├── .gitignore
</span><span class='line'>├── .npmignore
</span><span class='line'>├── Gruntfile.coffee
</span><span class='line'>├── LICENSE
</span><span class='line'>├── README.md
</span><span class='line'>├── lib
</span><span class='line'>│   └── nanomsg.js
</span><span class='line'>├── node_modules
</span><span class='line'>│   ├── .bin
</span><span class='line'>│   ├── chai
</span><span class='line'>│   ├── ffi
</span><span class='line'>│   ├── grunt
</span><span class='line'>│   ├── grunt-contrib-coffee
</span><span class='line'>│   └── grunt-mocha-test
</span><span class='line'>├── package.json
</span><span class='line'>├── src
</span><span class='line'>│   └── nanomsg.coffee
</span><span class='line'>└── test
</span><span class='line'>    └── test.coffee
</span><span class='line'>
</span><span class='line'>10 directories, 9 files
</span></code></pre></td></tr></table></div></figure>


<p>Lastly, I&rsquo;ll
<a href="https://github.com/250bpm/nanomsg/pull/122">reach out to</a>
Martin Sústrik and let him know that nanomsg has a new binding.</p>

<p>The bindings are far from complete, the test coverage could be better, and the
API is very C like and could use some OO syntactic sugar, but we&rsquo;re at a great
starting point and ready to rock and roll.  If you&rsquo;d like to help out, fork
<a href="https://github.com/nickdesaulniers/node-nanomsg.git">https://github.com/nickdesaulniers/node-nanomsg.git</a>.</p>

<p>What are some of your thoughts on build steps, testing, and directory layout of
node module?  This
tutorial was definitely not meant to be an authoritarian guide.  I look forward
to your comments on your experiences!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/25/designated-initialization-with-pointers-in-c/">Designated Initialization With Compound Literals in C</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-25T16:48:00-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/25/designated-initialization-with-pointers-in-c/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just a quick post on something I just discovered and found neat (I always find
obscure C syntax interesting).  I was trying to figure out how to use a C
designated initializer, where a member was a pointer to another designated
initializer.  At this point, you need a compound literal.  Just a quick
background on C initialization:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// verbosely create an array with a known size</span>
</span><span class='line'><span class="kt">int</span> <span class="n">arr</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="c1">// =&gt; [1, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// concisely create an array with a known size</span>
</span><span class='line'><span class="kt">int</span> <span class="n">arr</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span> <span class="c1">// =&gt; [1, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates an array with unspecified values initialized to 0</span>
</span><span class='line'><span class="kt">int</span> <span class="n">arr</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span> <span class="c1">// =&gt; [1, 2, 3, 0]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// truncates declaration</span>
</span><span class='line'><span class="kt">int</span> <span class="n">arr</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span> <span class="c1">// =&gt; [1]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// based on number of initializers</span>
</span><span class='line'><span class="kt">int</span> <span class="n">arr</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span> <span class="c1">// =&gt; [1, 2, 3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at how we might have initialized a struct in C89.  In C89, you are
required to declare local variables at the top of a block.  A previous
initialization of a point struct might have looked like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">point</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>  <span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as we can define array literals in C using the initializer list syntax, we
can use the same concise syntax for initializing structs!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// point a is located at (2, 3)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, this can be bad.  Where would point a be located if say a fellow team
mate came along and modified the definition of the point struct to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span> <span class="c1">// used to be `int x, y;`</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Suddenly point a points to (3, 2), not (2, 3).  It&rsquo;s better if you use
designated initializers to declare the values for members of your struct.  It&rsquo;s
up to the compiler to decide on the order of initialization, but it wont mess
up where the data is intended to go.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// point b is located at (2, 3)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now we have designated initializers, cool.  What about if we want to use the
same syntax to reassign point b?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">};</span>
</span><span class='line'><span class="c1">//    ^</span>
</span><span class='line'><span class="c1">// error: expected expression</span>
</span></code></pre></td></tr></table></div></figure>


<p>While you are being explicit about the shape of the struct that you are trying
to assign to b, the compiler cannot figure out that you&rsquo;re trying to assign a
point struct to another point struct.  A C cast would probably help here and
that&rsquo;s what the concept of compound literals are.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">};</span> <span class="c1">// works!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice: I just combined a compound literal with a designated initializer.  A
compound literal on its own would look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span> <span class="c1">// works!</span>
</span></code></pre></td></tr></table></div></figure>


<p>To recap we can define points like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// C89 (too verbose)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span> <span class="c1">// initializer list (struct member order specific)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">c</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">};</span> <span class="c1">// designated initializer (non struct member order specific)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">};</span> <span class="c1">// compound literal (cast + designated initialization)</span>
</span></code></pre></td></tr></table></div></figure>


<p>My favorite part of compound literals is that you can define values inline of
an argument list.  Say you have a function prototype like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">distance</span> <span class="p">(</span><span class="k">struct</span> <span class="n">point</span><span class="p">,</span> <span class="k">struct</span> <span class="n">point</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// instead of calling it like this</span>
</span><span class='line'><span class="c1">// (creating temp objects just to pass in)</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>
</span><span class='line'><span class="k">struct</span> <span class="n">point</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">};</span>
</span><span class='line'><span class="n">distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we can use compound literals</span>
</span><span class='line'><span class="n">distance</span><span class="p">((</span><span class="k">struct</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span> <span class="p">(</span><span class="k">struct</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>So compound literals help with reassignment of structs, and not storing
temporary variables just to pass as function arguments.  What happens though
when one of your members is a pointer?  C strings are easy because they already
have a literal value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">node</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// just using designated initialization</span>
</span><span class='line'><span class="k">struct</span> <span class="n">node</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">hello</span> <span class="n">world</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>But what happens if we want to initialize node.next?  We could do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">node</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">foo</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">a</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, we have to define b before assigning it to a.next.  That&rsquo;s worthwhile if
you need to reference b later in that scope, but sometimes you don&rsquo;t (just like
how compound literals can help with function arguments)!  But that&rsquo;s where I
was stumped.  How do you nest designated initializers when the a member is a
pointer to another designated initializer?  A first naïve attempt was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">node</span> <span class="n">c</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">bar</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">baz</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'><span class="c1">//  ^</span>
</span><span class='line'><span class="c1">// error: designator in initializer for scalar type &#39;struct node *&#39;</span>
</span><span class='line'>    <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>WTF?  Well, if you go back to the example with nodes a and b, we don&rsquo;t assign
the value of b to a.next, we assign it a pointer to b.  So how can we use
designated initializers to define, say, the first two nodes of a linked list?
Compound literals.  Remember, a compound literal is essentially a designated
initialization + cast.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">node</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">qux</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="n">fred</span><span class="err">”</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that works, but why?  d.next is assigned an address of a
compound literal.  Granted, you probably don&rsquo;t want to be declaring your entire
linked list like this, as nesting gets out of control fast.  I really like this
style because it reminds me of JavaScript&rsquo;s syntax for declaring object
literals.  It would look nicer if all of your nested structs were values and
not references though; then you could just use designated initializers and
wouldn&rsquo;t need compound literals or address of operators.</p>

<p>What&rsquo;s your favorite or most interesting part of C syntax?</p>

<p>Acknowledgements:</p>

<ul>
<li><a href="http://louisstowasser.com/">Louis Stowasser</a></li>
<li><a href="http://fredericiana.com/">Frederic Wenzel</a></li>
<li><a href="http://shop.oreilly.com/product/0636920025108.do">21st Century C</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/03/why-ill-be-marching-this-4th/">Why I&#8217;ll Be Marching This 4th</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-03T22:27:00-07:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/07/03/why-ill-be-marching-this-4th/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>If you&#8217;ve done nothing wrong, then you&#8217;ve got nothing to hide.</p></blockquote>


<p>Wrong.  Nothing ever justifies giving up your
<a href="http://www.un.org/en/documents/udhr/index.shtml#a12">human rights</a>
, especially to
prove lack of wrong doing, and any government that asks you to do so is not
your friend.</p>

<p>Terrorism has become a weapon used against us by those elected to lead to keep
us
compliant, like blinders you&rsquo;d put on a horse.  The threat just keeps growing
and growing instead diminishing, despite the money and lives we throw at
it.  Terrorism is the new Communism, and the
<a href="http://www.guardian.co.uk/world/2013/jun/06/us-tech-giants-nsa-data">NSA PRISM program</a>
and the
<a href="http://www.technologyreview.com/news/515861/nsa-surveillance-reflects-a-broader-interpretation-of-the-patriot-act/">Patriot Act</a>
are the modern day overreactions equivalent to
<a href="https://en.wikipedia.org/wiki/McCarthyism">McCarthyism</a> and
the <a href="https://en.wikipedia.org/wiki/Red_scare">Red Scare</a>.</p>

<p>A captain and crew of a boat would reflect upon the current state of their
vessel and make
corrections.  The cycle of reflection and correction is what keeps the boat
from running ashore, hitting other boats, or making other costly mistakes.
Unfortunately, I feel that NSA, enabled by
<a href="http://www.aclu.org/free-speech-national-security-technology-and-liberty/reform-patriot-act-section-215">section 215 of the Patriot Act</a>,
have become so powerful that they feel they
<a href="http://www.motherjones.com/mojo/2013/06/fisa-court-nsa-spying-opinion-reject-request">don&rsquo;t need to reflect upon their actions anymore</a>.</p>

<p>If
your neighbor was peeking in your window at night, that would probably make you
very angry, and you would probably never trust that neighbor again.  Think
about how all of our fellow countries feel about us right now.
It&rsquo;s really unfortunate that Germany and our allies
<a href="http://www.washingtontimes.com/news/2013/jun/12/germany-decries-nsa-surveillance-stasi-methods/">now severely distrust us</a>.
I apologize to
all non US citizens that my government doesn&rsquo;t respect you enough to extend the
human right to privacy to you, as it supposedly does to its own citizens, and
I&rsquo;m ashamed I have to apologize on behalf of them.  It&rsquo;s troubling that the
NSA <a href="https://www.youtube.com/watch?v=4v7YtTnon90">has trouble</a> telling the
<a href="http://www.techspot.com/news/53031-senators-demand-that-nsa-fix-inaccuracies-in-prism-factsheet.html">truth</a>.
It&rsquo;s awesome but ultimately embarrassing that Ecuador
<a href="http://inserbia.info/news/2013/06/ecuador-offers-to-fund-human-rights-training-in-the-us/">offers to fund Human Rights training to us</a>.</p>

<p>It&rsquo;s hypocritical that we frown upon countries like
<a href="http://en.wikipedia.org/wiki/Golden_Shield_Project">China spying on their citizens</a>,
like the East German Stasi, and yet we are doing it to our
own people!  While this administration may try its best to be benevolent with
this power, who&rsquo;s to say all future administrations will use it for good?
Even without content you can
<a href="https://www.youtube.com/watch?v=raxUNmzgCWE">glean an awful (unacceptable) amount</a>
of <a href="http://www.ted.com/talks/malte_spitz_your_phone_company_is_watching.html">information about somebody</a>.</p>

<p>So how did we get here?  The justification I keep hearing is that
<a href="https://soundcloud.com/madiha-1/students-question-the-nsa-at">this is all legal</a>.
Regardless of whether or not something is legal, we should be asking ourselves
“but is this right?” and “what were the motivations of those that created this
law?  Was it to entrench the privileged or represent the constituents?”
<a href="http://en.wikipedia.org/wiki/First_they_came...">Good people not standing up for the right thing</a>
is what got us here.  Good people
not standing up at the Tech companies accused of handing over data to the NSA.
Good people at the NSA not speaking out about their surveillance programs.
Good people in Congress not speaking out about programs they&rsquo;ve been briefed
on.  Everyone just keeps saying how they&rsquo;re just complying with the law while
looking the other way.
Sounds to me like the crew hasn&rsquo;t been doing enough reflection.  What about the
captain?</p>

<blockquote><p>I think it’s important to recognize that you can’t have 100 percent security<br/>and also then have 100 per cent privacy and zero inconvenience.</p><footer><strong>President Obama</strong> <cite><a href='http://www.youtube.com/watch?v=Xec48sUutuA'>www.youtube.com/&hellip;</a></cite></footer></blockquote>


<p>Hearing the President of our country say that,
<a href="http://www.washingtonpost.com/blogs/wonkblog/wp/2013/07/03/how-ed-snowden-became-a-bigger-story-than-nsa-spying-in-two-charts/">the incompetent media&rsquo;s focus on Snowden</a>,
and
<a href="http://www.usatoday.com/story/news/politics/2013/06/17/americans-say-snowden-should-be-prosecuted-for-nsa-leaks-in-usa-today-poll/2430583/">the American people&rsquo;s fundamental misunderstand of privacy</a>,
literally reminds me of the part in Star Wars where in order to stop a growing
threat and protect the people, a democracy is turned into an authoritarian
empire.</p>

<blockquote><p>So this is how liberty dies&#8230;with thunderous applause?</p><footer><strong>Padme, Star Wars Ep. 3</strong> <cite><a href='http://vimeo.com/57563428'>vimeo.com/57563428/&hellip;</a></cite></footer></blockquote>


<p>Not on my watch.  And not on yours either.  Join us this 4th of July for a
peaceful rally against infringements on our 4th Amendment rights as part of the
national
<a href="http://www.restorethefourth.net/">Restore the Fourth</a>
movement.  Let&rsquo;s ask the NSA to go
back to the drawing board and find a way to uncompromisingly provide security
<strong><em>and</em></strong> privacy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/13/8-months-in-mozilla/">8 Months in Mozilla</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-13T00:54:00-07:00" pubdate data-updated="true">Jun 13<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/06/13/8-months-in-mozilla/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Besides 3 months interrupted to finish degree requirements, and including an
internship, I’ve been at Mozilla for about 8 months now.  After reading a
<a href="http://ahmetalpbalkan.com/blog/8-months-microsoft/">blog post</a>
of another software engineer’s experience at Microsoft, I count my
blessings.  Reading that article set off too many alarms in my
head.  It was well written, and I sugguest you go
<a href="http://ahmetalpbalkan.com/blog/8-months-microsoft/">read it</a>, but my takeaway
was that that any big name corporation people dream about working at is
actually quite dystopian, and I do not feel that that is the case here.</p>

<hr />

<p><del>Expect no documentation in corporations</del></p>

<h2>Expect documentation to be sparse or bit rotted</h2>

<p>When developers are coding at an unhindered pace, writing documentation does
suck.  But once a project reaches a certain size, it cannot sustain growth
without additional support from additional developers.  When a project reaches
this point, it’s worthwhile to step back from unbridled coding to write some
docs for your new devs.  This is really important for open source projects, to
get help from volunteers.  I’ve heard roughly 50% of Mozilla’s code comes
from volunteers; so making their lives easier is a must.  Also,
writing documentation is a great way to start contributing to an open source
code
base.  Documentation is a gift that keeps on giving.  By keeping information to
yourself, you have power over others, but that doesn’t help your organization
move forward as a whole.  Depending on the pace of code development,
documentation tends to bit rot.  I’m all for code that’s clear enough to be
self documenting, but sometimes comment blocks that describe high level
overviews of the code base’s architecture can really help newbies.  When you
update code, you should update the relevant tests and documentation.</p>

<hr />

<p><del>It is not what you do, it is what you sell</del></p>

<h2>It’s all about maintainability</h2>

<p>I’ve had
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744640">nightmare code reviews</a>.
Literally reviews so long I’ve had to print
them out and cross them out one by one as I fixed them to help me keep track
of what I had left to fix.  But by working through them, I learned an awful lot
about professional code development.
It literally taught me to write some bulletproof code.  While it was
embarrassing for me at the time, and even a little now to admit, I’m glad
because it helped me grow professionally at an accelerated pace and I can
appreciate that.  People come and go, but their code lives on.  Think about
this, some day you will die, but code you’ve written will probably outlast you.
You wont be around to defend your coding decisions, so commit it right while
you can.  Imagine the poor bastard who has to maintain your code, why not try
and make their life a little easier?  As an engineer, ethics and morality are
the
<a href="http://courses.cs.vt.edu/cs3604/lib/WorldCodes/Hippocr.Oath.html">Hippocratic Oath</a>
you answer to, not someone with a business title.  If you
think this is wrong, if you’re not allowed to offer feedback or criticize the
decisions made by those above you, then you work for the wrong company.</p>

<hr />

<p><del>Not everbody is passionate for engineering</del></p>

<h2>Everyone here is super passionate about what they do</h2>

<p>While a lot of people here have active family lives, they are all active
Mozillians.  I’ve yet to meet anyone who didn’t have a common ground in web
based software (back end, front end, browser, OS, graphics, etc.) to speak the
same language as me, but also acute knowledge in his or her specialty.  By
being surrounded be so many smart, enthusiastic people I can tell you all about
JavaScript performance, about compiler front ends and back ends, about codecs,
about layout and rendering, about handling billions of hits a day, etc.  If
you’re the smartest in the group, the group is dragging you down.  I frequently
feel like I’m not the smartest when surrounded by most of my peers, and I’m
cool with that.  I am young and naïve and have so much to learn, and Mozilla is
an awesome place to grow.</p>

<hr />

<p><del>2-3 hours of coding a day is great</del></p>

<h2>Contribute at your pace</h2>

<p>There’s no pressure here about time spent coding.  Time spent or number of
lines written is not a benchmark to live by, code quality is.  I’m a five
o’clock developer, but when I go home I’m reading up on various software
topics and expanding my range of knowledge.  I have a big bookshelf I pride
myself in filling with various programming and hardware design related books.
Mozilla provides all kinds of distractions (tech talks, food, pool table, video
games), because comfortable developers are better developers.  I went to a talk
today where the senior employee talking told me that we should not waste our
time in meetings if we feel they are meaningless.  “Just walk out!”</p>

<hr />

<p><del>Not giving back to the public domain is the norm</del></p>

<h2>Giving back to the public domain is the norm</h2>

<p>My very first week as an intern, I had just finished
<a href="https://github.com/nickdesaulniers/Super-Tip-Calculator">my first project</a>.
I approached my manager and said “Hey I’m going to publish this now on
Github.  That’s cool right?”  There was an uncomfortably long pause from my
manager, then “yeah man go for!”  Literally everything I’ve ever worked on
here
<a href="https://github.com/nickdesaulniers?tab=repositories">has been published as open source</a>.
Writing software is about expression.  To be able to publish my
code freely, literally the reason the World Wide Web was created, allows me to
be a
part of someone else’s professional development; my expressions and code
mannerisms living on in theirs.  Probably the coolest story I have about
working here on open source software happened a few weeks ago.  It was a Friday
afternoon and I was assessing issues in our issue tracker, deciding which I was
going to tackle first on Monday.  Monday morning I came in to a pull request
with my name on it.  Literally some person who had never spoken to me, nor any
other core devs.  Someone who didn’t live in the same country as me or possibly
speak my language natively, they just picked up an issue and wrote a patch in a
mutually common language: code.  It didn’t matter that the volunteer was or
wasn’t employed by Mozilla; they understood the problem they faced enough to
fix it for themselves and everyone else. Anyone can partake in the development
process and earn the priviledge and trust to become a core volunteer.</p>

<hr />

<p><del>The world outside is not known here a lot</del></p>

<h2>Everyone here is aware of the outside world</h2>

<p>Seeing as we tend to wind up on HN et al almost daily, many of us frequent HN,
Reddit, Twitter, and /..  It’s always interesting to see coworkers show up in
comment threads.  When you say something hurtful about Mozilla or Mozilla
products in these forums, more than a few people here are going to see this and
get their feelings hurt.  It’s really unfortunate especially since our issue
tracker is public, and it takes a few minutes to fill out a simple bug (and a
few more for steps to reproduce) where we actually look for issues (and not on
Twitter, for instance).  Anyways, being aware of the new hotness has benefits
again in terms of expression.  So much of Rust is based on ideas from various
languages.  So much of ECMAScript 6 comes from CoffeeScript.  So many libraries
have interesting and useful abstractions.  Saying “bah humbug new hotness
bullshit” is naïve; new languages and frameworks became popular because people
found that they made software development marginally better, and by closing
your mind to them you loose out on being able to take those ideas and
incorporate them in your current or favorite language/framework/project.  If
anything, being more informed about your enemy makes your argument stronger.  I
can’t tell you how many times I’ve heard someone talk shit about Ruby, yet when
pressed didn’t have the slightest knowledge of the language. Yet I’ve had
truly great debates with those well versed in Ruby.  Try to only remark on
positives, and lay off negatives unless they have actually bitten you.</p>

<hr />

<p><del>Copy-pasting code can be okay</del></p>

<h2>Measure once, cut twice [is wrong!]</h2>

<p>Stack overflow is great.  There’s no way to know every little bit of C or C++.
JavaScript has some bad parts.  But by copying and pasting code that was
written from another context, you’re probably introducing bugs into your code.
Don’t repeat yourself, and don’t cut corners just to get shit done.</p>

<hr />

<p><del>Code reviews can be skipped</del></p>

<h2>Code reviews are nothing but beneficial</h2>

<p>If they are taking too long to the point where you’re considering cutting them
out, your team is probably understaffed and overworked.  Code reviews allow
others to spot bugs that you may have overlooked.  Seeing as they didn’t write
the code, they can look at the code objectively without the same assumptions
you made that may or may not actually be there.  It also allows you to grow
as a developer, assuming you take the lessons learned to heart.  The reviewer
may learn a thing or two.  This should obviously occur less frequently
(otherwise you have the lesser experienced coder reviewing the more experienced
coder’s code), but you can still teach an old dog new tricks.  If you get to a
point where you’re getting too bogged down in code reviews, you probably
haven’t been delegating enough or haven’t communicated well enough with your
manager or the rest of the team.</p>

<hr />

<p><del>Latest software, meh</del></p>

<h2>Latest software, duh</h2>

<p>Old, unpatched versions of popular software are susceptible to security flaws.
Java especially.  It may involve work to update your code for new environments,
but it’s easier to bite the bullet in small increments frequently than it is to
wait until it’s too late.</p>

<hr />

<p><del>Your specialties usually do not matter</del></p>

<h2>You were hired because of the need for someone on your team to have a certain expertise</h2>

<p>If this is not the case, what the hell is your recruiting department doing?
You know the part where start-ups say speed is everything?  It’s because of the
big established players not optimally allocating resources.  Even if you’re not
happy when you get here, you’re able to move or at least work on something
else.  I’ve had the freedom to work on Rust compiler, something I never would
have dreamed of doing before and not something I’m an expert in but something
that is mentally fulfilling and thought provoking.  Many of the people here are
famous for one thing or another and many of them work on things similar to
what they’re known for, while others are free to start new or tackle existing
projects.  We frequently borrow people from other teams who are able to lend a
hand in various aspects they specialize in.</p>

<p>Besides these responses, there’s just so much about my job that I love.  The
<a href="http://www.mozilla.org/en-US/about/manifesto/">Mozilla Manifesto</a>
is my holy book.  It makes me so happy
to be a part of such an incredible organization.  We have the transparency and
accountability the government could only dream of.  Instead of running from
wrongdoing,
<a href="https://optin.stopwatching.us/">we fight</a>!
We have so many interesting projects that anyone can get
<a href="http://www.whatcanidoformozilla.org/">involved with</a>!
We have so many employees well known for their contributions.
We have so much competition that keeps us humble.  We have so many experienced
and friendly senior software engineers who make great mentors to the new guard.
We have so many people dedicated to users, who don’t compromise privacy for
security (as those who do deserve neither).  We have such an amazing community
of staff, volunteers, reps, advocates, evangelists, users, localizers, testers,
etc. who understand that they have the power to affect the trajectory of their
favorite open source browser, mobile operating system, service, or library.</p>

<p>Again, I’m not making any of these points with your experiences
in mind.  I’m talking about what’s the norm here at my place of employment.</p>

<p>I’ve been told that working at Mozilla out of college spoils you.  If that’s
the case, if life at M$ is the norm, then my next job will have to be one of my
own creation.  I can only hope that a company I [will] create be in the image
of Mozilla.  Even then, I’ll still be a Mozillian; once a Mozillian, always a
Mozillian.  When people complain about their jobs, it’s completely foreign to
me.  You always have the power to change your situation, and I view
disagreement to that point as self-doubt.  I love the work that I do and if
your company does something that you don’t agree with, then I challenge you to
change your situation.  Be that speaking out or moving on.</p>

<hr />

<h2>At the end</h2>

<p>It’s about expressing your legacy; that will have repercussions that will shape
our world.  Chasing paychecks and enduring crappy working conditions is not a
way to live.  So what do you think, world traveler?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/07/rust-pattern-matching-and-the-option-type/">Rust: Pattern Matching and the Option Type</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-07T18:41:00-07:00" pubdate data-updated="true">May 7<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/07/rust-pattern-matching-and-the-option-type/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day I was thinking about the function for performing dynamic memory
allocation in the C standard library, malloc. From the manual pages,
<code>If successful, the malloc() function returns a pointer to allocated memory.
If there is an error, it
returns a NULL pointer and sets errno to ENOMEM.</code> One of the most common errors
when using malloc is not checking for allocation failure.  The allocation is not
guaranteed to succeed and trying to use a NULL reference can lead to program
crashes.</p>

<p>So a common pattern we&rsquo;ll see is:</p>

<figure class='code'><figcaption><span>C</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span><span class="o">*</span> <span class="n">nums</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">nums</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// handle error</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">*</span><span class="n">nums</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// operate on nums</span>
</span><span class='line'>  <span class="n">free</span><span class="p">(</span><span class="n">nums</span><span class="p">);</span>
</span><span class='line'>  <span class="n">nums</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we allocated space for an integer, cast the <code>void*</code> returned from malloc
to an <code>int*</code>, compared it against the <code>NULL</code> pointer, then freed the allocated
memory and removed the reference.</p>

<p>One of the big problems with the null pointer has to do with
safely dereferencing it.  In C, dereferencing the null pointer is undefined
and usually leads to a segfault and program crash.</p>

<p>It can be so unsafe to work with null pointers that
C. A. R. Hoare refers to them as his billion-dollar mistake:</p>

<blockquote><p>I call it my billion-dollar mistake. It was the invention of the null reference in 1965. At that time, I was designing the first comprehensive type system for references in an object oriented language (ALGOL W). My goal was to ensure that all use of references should be absolutely safe, with checking performed automatically by the compiler. But I couldn&#8217;t resist the temptation to put in a null reference, simply because it was so easy to implement. This has led to innumerable errors, vulnerabilities, and system crashes, which have probably caused a billion dollars of pain and damage in the last forty years.</p><footer><strong>C.A.R. Hoare, InfoQ</strong> <cite><a href='http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare'>Null References: The Billion Dollar Mistake</a></cite></footer></blockquote>


<p>So how do we represent the value of nothing?  With an integer, for example, your
first instinct might be to use 0 to refer to no value.  But 0 <em>is</em> a value, so
how do we represent the range of integer values but also whether there is a
value or not?</p>

<p>Rust, a systems programming language with a focus on safety and concurrency,
does not have the concept of a null pointer.  Instead, it has a different
construct to represent the absence of value, a whole other structure called an
<a href="http://static.rust-lang.org/doc/core/option.html">Option<T></a>.  It is an
<a href="http://static.rust-lang.org/doc/core/option.html#enum-option">enumerated type</a> that can
either be None (no value) or Some(T) (a specialization of type T).</p>

<p>So what the heck is an option type and how do we use it?  The option type is
a polymorphic type (generic type that can be specialized) that encapsulates
either an empty constructor or the constructor of the original data type.  Let&rsquo;s
take a trip down the rabbit hole to see how we use one.  First, let&rsquo;s look at
some C++ code, and then translate it to Rust.</p>

<figure class='code'><figcaption><span>option.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;iostream&gt; </span><span class="c1">// cout, endl</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt; </span><span class="c1">// rand</span>
</span><span class='line'><span class="cp">#include &lt;time.h&gt; </span><span class="c1">// time</span>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// If there is a &#39;random error&#39; returns NULL</span>
</span><span class='line'><span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">may_return_null</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// if else</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">x</span> <span class="o">=</span> <span class="n">may_return_null</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// switch</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">777</span><span class="o">:</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lucky Sevens&quot;</span>        <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">666</span><span class="o">:</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of the Beast&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">42</span><span class="o">:</span> <span class="n">cout</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;Meaning of Life&quot;</span>     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span> <span class="n">cout</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;Nothing special&quot;</span>     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No value&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// single if</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">==</span> <span class="mi">666</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Did I mention that Iron Maiden is my favorite band?&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s step through this program line by line, starting in main.</p>

<figure class='code'><figcaption><span>Line 14</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">x</span> <span class="o">=</span> <span class="n">may_return_null</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&rsquo;re calling a function that may return null, just like malloc!</p>

<figure class='code'><figcaption><span>Lines 8-9</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'><span class="k">return</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the body of <code>may_return_null</code> we seed the random number generator, generate a random number, mod it by 2
(so it can either be 0 or 1, 50-50 chance, hopefully), then either return a
pointer pointing to memory allocated on the heap or the null pointer.  We also use the succinct
ternary operator, which gives us the power of a conditional statement in the
form of a concise expression.</p>

<figure class='code'><figcaption><span>Line 15</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>We check if the pointer is valid, that is that it is safe to use, as <code>NULL</code> is
falsy in a C++ conditional.  If it is, then we can safely dereference it.  Let&rsquo;s
switch on the (dereferenced) value.  Notice how we need to break to explicitly
prevent fall through, though
<a href="http://books.google.com/books?id=4vm2xK3yn34C&amp;pg=PA37&amp;lpg=PA38&amp;dq=expert+c+fallthrough&amp;source=bl&amp;ots=Ho98ZhXF9X&amp;sig=PebysT8-3zA_9B2aRkuvnz4mCmY&amp;hl=en&amp;sa=X&amp;ei=j8CJUdeWMerJiwLQmICoDw&amp;ved=0CC4Q6AEwAA#v=onepage&amp;q=expert%20c%20fallthrough&amp;f=false">97% of the time that&rsquo;s what you intend</a>.</p>

<figure class='code'><figcaption><span>Lines 17-22</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">777</span><span class="o">:</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lucky Sevens&quot;</span>        <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">666</span><span class="o">:</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number of the Beast&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">42</span><span class="o">:</span> <span class="n">cout</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;Meaning of Life&quot;</span>     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span> <span class="n">cout</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot;Nothing special&quot;</span>     <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the pointer was null, the else branch of the conditional would execute
printing a different result.</p>

<figure class='code'><figcaption><span>Line 24</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No value&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally in we check the value pointed to.  Did I forget something here?  Save
that thought, we&rsquo;ll come back to it.</p>

<figure class='code'><figcaption><span>Lines 28-30</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">==</span> <span class="mi">666</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Did I mention that Iron Maiden is my favorite band?&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see my rough translation of this program into Rust.</p>

<figure class='code'><figcaption><span>option.rs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">use</span> <span class="n">core</span><span class="o">::</span><span class="n">rand</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">may_return_none</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Option</span><span class="o">&lt;</span><span class="k">int</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">rand</span><span class="o">::</span><span class="n">Rng</span><span class="p">().</span><span class="n">next</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span> <span class="p">{</span> <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">None</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">x</span><span class="o">:</span> <span class="n">Option</span><span class="o">&lt;</span><span class="k">int</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">may_return_none</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">io</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="n">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Some</span><span class="p">(</span><span class="m">777</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Lucky Sevens&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Number of the Beast&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Some</span><span class="p">(</span><span class="m">422</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Meaning of Life&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Nothing special&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">None</span> <span class="o">=&gt;</span> <span class="s">&quot;No value&quot;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">io</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Did I mention that Iron Maiden is my favorite Band?&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">_</span> <span class="o">=&gt;</span> <span class="p">{}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both programs, when compiled <em>should</em> randomly print either:</p>

<figure class='code'><figcaption><span>option.rs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">No</span> <span class="n">Value</span>
</span><span class='line'><span class="c1">// or</span>
</span><span class='line'><span class="n">Number</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Beast</span>
</span><span class='line'><span class="n">Did</span> <span class="n">I</span> <span class="n">mention</span> <span class="n">that</span> <span class="n">Iron</span> <span class="n">Maiden</span> <span class="n">is</span> <span class="n">my</span> <span class="n">favorite</span> <span class="n">Band</span><span class="o">?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s walk through the Rust code, starting at main and compare it to the
equivalent C++ code.</p>

<figure class='code'><figcaption><span>option.rs Line 8</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">let</span> <span class="n">x</span><span class="o">:</span> <span class="n">Option</span><span class="o">&lt;</span><span class="k">int</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">may_return_none</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>option.cpp Line 14</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">x</span> <span class="o">=</span> <span class="n">may_return_null</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>I read this Rust code as &lsquo;let x be type Option,
specialized to type int initialized
to the return value of may_return_none.&rsquo;  I read the C++ as &lsquo;x is a const pointer
to a const integer initialized to the return value of may_return_none.&rsquo;  It&rsquo;s
important to note that values and pointers in Rust default to being immutable,
where as in c++ they default to being mutable, which is why we need to be
explicit about their const&#8217;ness.  In Rust, we could declare x as being explicitly
mutable: <code>let mut x: ... = ...;</code>.  In both, we can also leave the explicit types
to be inferred by the compiler.</p>

<figure class='code'><figcaption><span>option.rs Line 4</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">if</span> <span class="n">rand</span><span class="o">::</span><span class="n">Rng</span><span class="p">().</span><span class="n">next</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span> <span class="p">{</span> <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">None</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>option.cpp Lines 8-9</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'><span class="k">return</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for the body of <code>may_return_none</code>.  Rust does not have a ternary operator,
so a single line <code>if {} else {}</code> block will have to do.  We also don&rsquo;t need
parentheses around the predicate in the conditional statement.  If we add them,
no harm is done, as we&rsquo;d just be being redundant about order of operations.
There
are no semicolons in this expression, nor a return statement in this function.
Rust will return the last expression in a function or method if the semicolon is
left off.  Also there is no such thing as a conditional statement, only
conditional expressions; the if is itself something that can be evaluated and
assigned to a variable!  We see this later in the code where we pass the evaluation
of a match expression directly into a call of <code>io::println</code>.
Rust returns the evaluation of the if expression,
which is the evaluation of the branch&rsquo;s block specified by the predicate,
which will randomly be one of the two enumerated types of <code>Option&lt;int&gt;</code>, either
an encapsulation of a int whose literal value is <code>666</code>, <code>Some&lt;666&gt;</code>, or
the representation of no value, <code>None</code>.  I believe the RNG code has changed in 0.7,
this code was written in 0.6.</p>

<p>In Rust, to get the value out of an option type, we pattern match on it.  Pattern
matching is something I became familiar with through the
<a href="http://learnyouahaskell.com/syntax-in-functions#pattern-matching">Haskell</a> programming language.  Pattern
matching is a powerful language construct that can entirely replace conditionals.
In fact, the one line if expression could have been written using a match
expression:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">if</span> <span class="n">rand</span><span class="o">::</span><span class="n">Rng</span><span class="p">().</span><span class="n">next</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span> <span class="p">{</span> <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">)</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">None</span> <span class="p">}</span>
</span><span class='line'><span class="c1">// or</span>
</span><span class='line'><span class="n">match</span> <span class="n">rand</span><span class="o">::</span><span class="n">Rng</span><span class="p">().</span><span class="n">next</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="p">{</span> <span class="m">1</span> <span class="o">=&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="m">666</span><span class="p">),</span> <span class="n">_</span> <span class="o">=&gt;</span> <span class="n">None</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The basic design pattern
for accessing the value of an option type in Rust looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">match</span> <span class="n">x</span> <span class="p">{</span> <span class="c1">// x: Option&lt;T&gt;</span>
</span><span class='line'>  <span class="n">Some</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="o">*</span><span class="n">y</span> <span class="p">},</span>
</span><span class='line'>  <span class="n">None</span> <span class="o">=&gt;</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The curly braces are optional for one liners (no block needed).
Pattern matches have to be exhaustive.  That means I have to exhaust all
possibilities for what the deconstructed value could be.  You can use a branch
that looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">_</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">everything</span> <span class="k">else</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>to catch everything else.  The underscore here means &ldquo;every other possible case.&rdquo;
So by having to use a match expression (also not a
statement, as opposed to C++&rsquo;s switch statement), which itself must be exhaustive,
Rust forces us to handle the case where the optional type is None!  This will
help us again in the future.
We also don&rsquo;t need parentheses around the predicate for the match expression, which
in this case is just a single variable, <code>x</code>.</p>

<p>In the value
<code>Some(_)</code>, the underscore has an additional meaning here that we would not use a
variable in the corresponding arm&rsquo;s block.  If we declared it as <code>Some(y)</code> we would get the warning:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">option</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">14</span><span class="o">:</span><span class="m">9</span><span class="o">:</span> <span class="m">14</span><span class="o">:</span><span class="m">11</span> <span class="n">warning</span><span class="o">:</span> <span class="n">unused</span> <span class="n">variable</span><span class="o">:</span> <span class="err">`</span><span class="n">y</span><span class="err">`</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">14</span>     <span class="n">Some</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Nothing special&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="o">^~</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope back in my C++ code you spotted the fatal flaw.  On line 28, I just
dereferenced a raw pointer without checking its validity.  This is a violation
of memory safety.</p>

<figure class='code'><figcaption><span>option.cpp Line 28</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">x</span> <span class="o">==</span> <span class="mi">666</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running the C++ code, instead of seeing <code>No value</code> printed to stdout in the
case of no value, a segfault occurs.</p>

<figure class='code'><figcaption><span>option.cpp Line 28</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">No</span> <span class="n">value</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="mi">80265</span> <span class="n">segmentation</span> <span class="n">fault</span>  <span class="p">.</span><span class="o">/</span><span class="n">option</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I should have done is something more like:</p>

<figure class='code'><figcaption><span>Line 28 corrected</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">x</span> <span class="o">==</span> <span class="mi">666</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, the C++ compiler let me get away with not handling the case where the
pointer was invalid (even if doing nothing in the case of &ldquo;handling&rdquo; it).  By
leaving out the check for a valid pointer, I have instructed the machine to
behave the same or follow the same code path with and without a reference to a
valid memory location.  Let&rsquo;s see what happens when I don&rsquo;t handle the None case
by deleting line 15 or option.rs, <code>None =&gt; "No value"</code>:</p>

<figure class='code'><figcaption><span>Line 28 corrected</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">10</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span> <span class="mi">16</span><span class="o">:</span><span class="mi">3</span> <span class="nl">error:</span> <span class="n">non</span><span class="o">-</span><span class="n">exhaustive</span> <span class="nl">patterns:</span> <span class="n">None</span> <span class="n">not</span> <span class="n">covered</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">10</span>   <span class="n">io</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="n">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">11</span>     <span class="n">Some</span><span class="p">(</span><span class="mi">777</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Lucky Sevens&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">12</span>     <span class="n">Some</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Number of the Beast&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">13</span>     <span class="n">Some</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Meaning of Life&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">option</span><span class="p">.</span><span class="nl">rs:</span><span class="mi">14</span>     <span class="n">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s">&quot;Nothing special&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not only did the compiler prevent me from generating an executable, it told me
that a pattern was not exhaustive, explicitly which one, and what case that was
not covered.</p>

<p>Coming back to encoding a lack of value for an int, we had left off that 0 <em>is</em>
a valid value.  For instance, how should we represent any other integer divided
by 0, as an integer?
Signed integers use a single bit to store whether
their value is positive or negative, the tradeoff being the signed integers
represent up to one less power of two than unsigned integers.  Maybe we could use an
additional bit to represent valid or invalid, but this would again cost us in
terms of representable values.
The IEEE 754 floating point representation has encodings for <a href="https://en.wikipedia.org/wiki/IEEE_floating_point#Formats">plus and minus
Infinity, plus and minus 0, and two kinds of NaN</a>.
To solve the validity problem, we can use enumerated types, which in Rust occur
as specializations of the Option type.  It&rsquo;s up to the compiler to implement
either additional information for the type, or use raw null pointers.  And to
get the value back out of the Option type, we <em>must</em> handle the case where there
is no valid value.</p>

<p>The key takeaways that I wish to convey are:</p>

<ol>
<li>In C and C++, I can use NULL to refer to a pointer that has no value.</li>
<li>A C/C++ compiler, such as clang, will allow me to compile code that violates
memory safety, such as dereferencing NULL pointers.</li>
<li>Rust instead uses Option types, an enumeration of a specialized type or None.</li>
<li>Rust forces me to use a match statement to access the possible value of an
Option type.</li>
<li>Pattern matching in Rust must be exhaustive.</li>
<li>The Rust compiler, rustc, forces me to handle the case where the pointer has
no value, whereas the C++ compiler, clang++, did not.</li>
<li>All conditional and switch statements can be replaced with pattern matching.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/29/the-persistence-of-memory/">The Persistence of Memory</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-29T20:35:00-07:00" pubdate data-updated="true">Apr 29<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/04/29/the-persistence-of-memory/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>I would like to die on Mars&#8230;</p><footer><strong>Elon Musk, Bloomberg,</strong> <cite><a href='http://www.businessweek.com/articles/2012-09-13/elon-musk-the-21st-century-industrialist#p5,'>Elon Musk, the 21st Century Industrialist</a></cite></footer></blockquote>


<p>Well, isn&rsquo;t that forward thinking?  Granted, the full quote
<em>I would like to die on Mars, just not on impact</em> is meant to sound hopeful of
his company, <a href="http://www.spacex.com/">SpaceX</a>.  I agree that some day, humans
will be buried on Mars.  But is it forward thinking, enough?  Does it push the
needle to where it needs to be pushed?  Does it strive for innovation and push
our imagination like Star Trek did?  Or is it just a realistic goal for SpaceX?</p>

<blockquote><p>The person with big dreams is more powerful than one with all the facts.</p><footer><strong>Albert Einstein</strong></footer></blockquote>


<p>While Elon would like to die on Mars, I think it would be neat to transfer my &ldquo;soul&rdquo; into a
computer.  We refer to data persistence within a computer as memory, using
transistors and capacitors to store charges, effectively &ldquo;remembering&rdquo; a
particular state.  While neurons, dendrites, and synapses within the human
brain don&rsquo;t quite work the same as RAM, I believe we will find a way to
interface them some day.  If one could transfer to a computer, maybe they could
transfer back, or swap even.  One could
theoretically trade entire bodies.  The jury is still out for me as far my
opinion of Google&rsquo;s Glass, but I see wearable computing as a step in the right
direction towards interfacing with the human body.  I guess it reminds me of the
<a href="http://futurama.wikia.com/wiki/Heads_in_Jars">Heads in Jars from Futurama</a>.
I recognize that the old guard must give way for the new guard, lest the new be
held in place, bound socially by the old.</p>

<p>In database systems, there is this notion of
<a href="http://en.wikipedia.org/wiki/Atomic_transaction">Atomicity</a>, where a set of
operations is guaranteed to either complete as a group, or all fail should
at least one fail.  One of the most popular examples is a bank transfer.  Say
you&rsquo;re transferring $100 from Bank A to Bank B.  Bank A&rsquo;s database should not
dock your account $100 until Bank B has added $100, and vice versa.  Imagine
if the power went out after Bank A docked your account, but before Bank B added
to your account; that money could just disappear.  Bank B may have received it
but not credited your account, or Bank A may have it, just not a record that
it&rsquo;s yours.  You may have just doubled your money, or lost all of it.
The notion of
Atomicity provides for &ldquo;transactions,&rdquo; or sets of instructions that are
guaranteed to all pass or all fail.</p>

<p>Atomicity would be important for a memory transference device.  Once you were
transferred into a machine, would it still be &ldquo;you&rdquo; if you remained in your
body?  A physical clone, is as much <em>you</em>
<del><a href="http://www.dailymail.co.uk/sciencetech/article-2232148/Identical-twins-genetically-different-research-suggests.html">as an identical twin</a></del>,
but will never have the same memories and experiences that shape their mind.  If
you merely copied your mind to a machine rather than transferred it, then you
would still remained trapped in your
<a href="http://www.quotefully.com/q/Jk3y3rG2aP">rotting piece of meat</a>.</p>

<p>This is what I mean by transfer my &ldquo;soul.&rdquo;  An actual atomic transaction moving
all of your memories and experiences from body to machine, all at once, or not
at all.  I probably wouldn&rsquo;t want to
be the first volunteer for such a machine, because if the machine failed at the
atomic transaction, your soul would either be as lost as the $100 from the
earlier example, or you&rsquo;d just be copied, not moved.</p>

<p>In a world where diseases are too profitable to cure, I can imagine a world
where the richest 1% live forever while the poor are forced to die.  Frozen Walt
Disney just sat up.  An abuse of the technology, not too different a world from
the one in <a href="http://en.wikipedia.org/wiki/Surrogates_%28film%29">Surrogates</a>.</p>

<blockquote><p>Have you not done tormenting me with your accursed time! It&#8217;s Abominable! When! When! One day, is that not enough for you, one day he went dumb, one day I went blind, one day we&#8217;ll go deaf, one day we were born, one day we shall die, the same day, the same second, is that not enough for you? They give birth astride a grave, the light gleams an instant, then it&#8217;s night once more.</p><footer><strong>Pozzo</strong> <cite>Waiting for Godot by Samuel Becket</cite></footer></blockquote>




<blockquote><p>They say that it is fear of death and what comes after death that makes men turn to religion.</p><footer><strong>Mustafa Mond</strong> <cite>Brave New World by Alduos Huxley</cite></footer></blockquote>


<p>Ever since my father passed away, I&rsquo;ve occasionally suffered from existential
anxiety attacks.  It usually starts with me thinking about those Discovery
Channel shows about how the old the universe is, and how old it will become.
Then my mind starts to think of all of the really cool technological
advancements that have occurred in my lifetime, and how I wont be around to
experience all future advancements, like a game that others get to play while I
have to sit on the sidelines and watch.  Of course, if I&rsquo;m dead then I guess I
won&rsquo;t care.  Currently, I calm myself down my telling myself that such an event
is a long time away and I will live a long and happy life with many descendants,
though I have no guarantees.  My father only lived to be 48.</p>

<blockquote><p>&#8216;That&#8217;s such a weak excuse,&#8217; said Valentine. &#8216;Everyone dies. Everyone leaves. What matters is the things you build together before they go. What matters is the part of them that continues in you when they&#8217;re gone.&#8217;</p><footer><strong>Valentine</strong> <cite>Children of the Mind by Orson Scott Card</cite></footer></blockquote>




<blockquote><p>Where before they would bloom and wither in the space of a single day, now they hold their blooms for three and four days at a time. Moistened by the dew of night, bathed in the light of the sun, the white flowers strive to live their lives to the fullest, beautifying the town as if striving to live out the portion of life denied to those whose &#8220;tomorrows&#8221; were snatched away from them forever.</p><footer><strong>White Flowers</strong> <cite>Lost Odyssey</cite></footer></blockquote>




<blockquote><p>Human beings, who cannot live forever, daring to take a journey without end. This might be the ultimate tragedy, but it could just as well be the ultimate comedy. Kaim knows one thing, however: one cannot simply dismiss it as an exercise in futility.</p><footer><strong>The Upstreamers</strong> <cite>Lost Odyssey</cite></footer></blockquote>


<p>Randy Pausch&rsquo;s <em>The Last Lecture</em> taught me that legacy is the greatest thing you
can leave behind.  While I haven&rsquo;t yet started the business I&rsquo;ve always wanted,
my first legacy I will leave my kiddos is my collection of Iron Maiden vinyl
records.  They and their children will probably think I was nuts, but there is
the slim chance they might really appreciate my taste in music.  I also want to
write a book someday, that way I can marvel at how
<a href="http://www.goodreads.com/quotes/287093-beneath-this-mask-there-is-more-than-flesh-beneath-this">my ideas will outlast me</a>.</p>

<blockquote><p>I like to think that something survives after you die, it&#8217;s strange to think that you accumulate all this experience, and maybe a little wisdom, and it just goes away.  So I really want to believe that something survives, that maybe your consciousness endures.  But on the other hand, perhaps it&#8217;s like an on-off switch.  &#8220;Click!&#8221; And you&#8217;re gone.</p><footer><strong>Steve Jobs</strong> <cite>Steve Jobs by Walter Isaacson</cite></footer></blockquote>


<p>It terrifies me to no end to think what could possibly drive someone to suicide.
What doom a person would have to be surrounded with to honestly believe that no
matter what they did, that they could not change their current situation.  I
believe the journey is ultimately worth it.  It
terrifies me to think of all of the amazing minds this world has seen, among so
many who choose not to develop their own, that have come and gone.  Those who
could change the world yet are snatched away.</p>

<blockquote><p>This body holding me reminds me of my own mortality. Embrace this moment. Remember. We are eternal. All this pain is an illusion.</p><footer><strong>Parabola</strong> <cite>Tool</cite></footer></blockquote>


<p>I&rsquo;m sorry this post turned a little dark.  By talking about my fears, I hope to
not let them control me.  I believe publishing this will be a relief.  I think
I&rsquo;ll join Elon on Mars, but unlike Elon, I believe I will transcend my physical
being.  It&rsquo;s important therefor, to treasure your body while it lasts.</p>

<blockquote><p>&#8216;But it [life] won&#8217;t have amounted to anything,&#8217; said Grego. &#8216;If your children die, then it was all a waste.&#8217; &#8216;No&#8217; said Olhado quietly. Grego shook his head. &#8216;Yes it does, Olhado. Death undoes everything.&#8217; Olhado shrugged. &#8216;Then why do you bother doing everything, Grego? Because someday you will die. Why should anyone ever have children? Someday they will die, their children will die, all children will die. Someday stars will wind down or blow up. Someday death will cover us all like the water of a lake and perhaps nothing will ever come to the surface to show that we were there. But we were there, and during the time we lived, we were alive. That&#8217;s the truth-what is, what was, what will be-not what could be, what should have been, what never can be. If we die, then our death has meaning to the rest of the universe. Even if our lives are unknown, the fact that someone lived here, and died, that will have repercussions, that will shape the universe.&#8217;</p><footer><strong>Children of the Mind</strong> <cite>Orson Scott Card</cite></footer></blockquote>




<blockquote><p>There will allways be hope, wherever you are, until you yourself abondon it.</p><footer><strong>Old Revolutionary</strong> <cite>Lost Odyssey</cite></footer></blockquote>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/03/basic-jit/">Basic JIT</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-03T00:05:00-07:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/04/03/basic-jit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ever since I learned about
<a href="`http://en.wikipedia.org/wiki/Just-in-time_compilation">Just In Time Compilation</a>
from the various
<a href="http://en.wikipedia.org/wiki/Ruby_%28programming_language%29#Implementations">Ruby VMs</a>
and
<a href="http://www.slideshare.net/newmovie/know-yourengines-velocity2011">JavaScript VMs</a>,
I&rsquo;ve been inspired.  I could tell you all about how just in time (JIT)
compilation worked, and how it could give your interpreted language a speed
boost.  It was so cool.  Well, it still is!  There&rsquo;s a ton of research going on
around JIT compilation.  But the problem for me is that I could never figure
out, let alone guess, how it was being done.  How could you compile code at
runtime, and then execute it?  I asked
<a href="http://pybites.blogspot.com/">Benjamin Peterson</a>
about how he had learned so much about JITs, and he referred me to
<a href="http://pypy.org/">pypy</a> (a Python JIT)&rsquo;s source.  But digging through source
was too much; I just wanted a simple example I could grok quickly.  So I&rsquo;ve
always been left wondering.</p>

<p>Luckily, I have an awesome job where I can meet face to face with the people
who are doing the work on making awesome production JIT compilers.  I spent
part of last week at <a href="http://www.gdconf.com/">GDC</a> demoing
<a href="https://blog.mozilla.org/blog/2013/03/27/mozilla-is-unlocking-the-power-of-the-web-as-a-platform-for-gaming/">Unreal Engine 3</a>
running in the browser.  The demo was actually the hard work of many, and I&rsquo;ll
dive into it more in another post following up the events, but
<a href="https://blog.mozilla.org/luke/">Luke Wagner</a>, a Mozillian working on the
JavaScript engine, added OdinMonkey to SpiderMonkey to allow optimizations of
<a href="https://blog.mozilla.org/luke/2013/03/21/asm-js-in-firefox-nightly/">asm.js</a>.</p>

<p>Luke is super friendly, and just listening to him talk with Dave Herman and
Alon Zakai is a treat.  I asked Luke the basics of JIT&#8217;ing at tonight&rsquo;s Mozilla
Research Party and he explained clearly. <em>Compile a simple object file, use
objdump to get the resulting platform specific assembly, use the mmap system
call to allocate some memory that you can write to <strong>AND</strong> execute, copy the
instructions into that buffer, typecast it to a function pointer and finally
call that.</em></p>

<p>So my goal was to at runtime, create a function that for simplicity&rsquo;s sake
multiplied two integers.  The first thing I did was write up a simple .c file,
then compile that to an object file with the -c flag.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Compile me with: clang -c mul.c -o mul.o</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">mul</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a heads up, I&rsquo;m on 64bit OSX.  So the generated assembly may differ on your
platform.  Obviously, the production JIT maintainers have abstracted away the
platform dependency, taking into account what platform you&rsquo;re on.  My example
doesn&rsquo;t, but that why I&rsquo;m walking you through the steps I took to find out the
x86_64 instructions.  The next step is to grab binutils, which is not installed
by default in OSX.  I used homebrew to install it: <code>brew install binutils</code>.
Homebrew installs gobjdump but it works with the same flags.</p>

<p>Once you have binutils and [g]objdump, the next step is to read out the machine
code from your object file, which is represented in hexadecimal.  By running
<code>gobjdump -j .text -d mul.o -M intel</code> you should get something similar
(remember, architecture dependent).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">gobjdump</span> <span class="o">-</span><span class="n">j</span> <span class="p">.</span><span class="n">text</span> <span class="o">-</span><span class="n">d</span> <span class="n">mul</span><span class="p">.</span><span class="n">o</span> <span class="o">-</span><span class="n">M</span> <span class="n">intel</span>
</span><span class='line'>
</span><span class='line'><span class="n">Disassembly</span> <span class="n">of</span> <span class="n">section</span> <span class="p">.</span><span class="n">text</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'><span class="mo">0000000000000000</span> <span class="o">&lt;</span><span class="n">_mul</span><span class="o">&gt;:</span>
</span><span class='line'><span class="mi">0</span><span class="o">:</span> <span class="mi">55</span> <span class="n">push</span> <span class="n">rbp</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="mi">48</span> <span class="mi">89</span> <span class="n">e5</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span><span class="n">rsp</span>
</span><span class='line'><span class="mi">4</span><span class="o">:</span> <span class="mi">89</span> <span class="mi">7</span><span class="n">d</span> <span class="n">fc</span> <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">],</span><span class="n">edi</span>
</span><span class='line'><span class="mi">7</span><span class="o">:</span> <span class="mi">89</span> <span class="mi">75</span> <span class="n">f8</span> <span class="n">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x8</span><span class="p">],</span><span class="n">esi</span>
</span><span class='line'><span class="nl">a:</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">75</span> <span class="n">fc</span> <span class="n">mov</span> <span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">]</span>
</span><span class='line'><span class="nl">d:</span> <span class="mf">0f</span> <span class="n">af</span> <span class="mi">75</span> <span class="n">f8</span> <span class="n">imul</span> <span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x8</span><span class="p">]</span>
</span><span class='line'><span class="mi">11</span><span class="o">:</span> <span class="mi">89</span> <span class="n">f0</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">esi</span>
</span><span class='line'><span class="mi">13</span><span class="o">:</span> <span class="mi">5</span><span class="n">d</span> <span class="n">pop</span> <span class="n">rbp</span>
</span><span class='line'><span class="mi">14</span><span class="o">:</span> <span class="n">c3</span> <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, so those instructions vary in size.  I don&rsquo;t know any x86 so I can&rsquo;t
comment too much on that particular
<a href="http://en.wikipedia.org/wiki/Instruction_set">Instruction Set Architecture</a>
but they&rsquo;re obviously in pairs of hexadecimal digits.  16<sup>2</sup> == 2<sup>8</sup> meaning that
each pair of hex digits can be represented by a single byte (or char of memory).
So these can all be thrown in an unsigned char [].  The man page for mmap explains
all of the fun flags, but the important point is that this way of allocating
memory makes it executable, so it can do bad things that memory allocated from
malloc can&rsquo;t.  I&rsquo;m sure the JavaScript engine guys have fun with that.  Once
memory is copied in, you can typecast the memory to a function pointer.
Make sure to check out the syntax that reminds me of a function pointer in an
argument list, but being used as an L-value.  Of course, you could just put the
cast right in front of the memory before you use it, but I find this as neat,
not so common C syntax.  I kind of
<a href="http://nickdesaulniers.github.com/blog/2013/01/26/c-function-pointers-alternate-syntax/">have a thing</a>
for stuff like that.  Then we can call it!  The resulting code looks like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt; </span><span class="c1">// printf</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt; </span><span class="c1">// memcpy</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt; </span><span class="c1">// mmap, munmap</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="c1">// Hexadecimal x86_64 machine code for: int mul (int a, int b) { return a * b; }</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="mh">0x55</span><span class="p">,</span> <span class="c1">// push rbp</span>
</span><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="c1">// mov rbp, rsp</span>
</span><span class='line'>  <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="c1">// mov DWORD PTR [rbp-0x4],edi</span>
</span><span class='line'>  <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="c1">// mov DWORD PTR [rbp-0x8],esi</span>
</span><span class='line'>  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="c1">// mov esi,DWORD PTR [rbp-04x]</span>
</span><span class='line'>  <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="c1">// imul esi,DWORD PTR [rbp-0x8]</span>
</span><span class='line'>  <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="c1">// mov eax,esi</span>
</span><span class='line'>  <span class="mh">0x5d</span><span class="p">,</span> <span class="c1">// pop rbp</span>
</span><span class='line'>  <span class="mh">0xc3</span> <span class="c1">// ret</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// allocate executable memory via sys call</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">MAP_ANON</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// copy runtime code into allocated memory</span>
</span><span class='line'>  <span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// typecast allocated memory to a function pointer</span>
</span><span class='line'>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">()</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// call function pointer</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d * %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Free up allocated memory</span>
</span><span class='line'>  <span class="n">munmap</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Voila!  How neat is that!  It works!  Luke&rsquo;s directions, an hour of working on
this, and
<a href="http://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html">this article</a>
in particular, and we have a simple JIT working. Again, this simple example is super
non-portable and dealing with memory in this fashion is generally unsafe.  But
now I know the basics of JIT&#8217;ing code, and now so do you!</p>

<p>Thanks Luke!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/28/commandments-of-a-mobile-web/">Commandments of a Mobile Web</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-28T22:43:00-08:00" pubdate data-updated="true">Feb 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/28/commandments-of-a-mobile-web/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Over the past few years, there&rsquo;s been certain
<a href="http://en.wikipedia.org/wiki/Paradigm_shift">paradigm shifts</a>
in web development. When you think of milestones that really changed how
development on the web was done, the two biggest were
<a href="https://www.ibm.com/developerworks/mydeveloperworks/blogs/BobZurek/entry/the_ajax_paradigm_shift?lang=en">Ajax</a>
and <a href="http://www.html5rocks.com/en/why">HTML5</a>.  Development was identifiably
different before and after such technological advancements.  There were
<a href="http://java.sys-con.com/node/315210">some</a> who initially
<a href="http://blog.tobie.me/post/31366970040/when-im-introspective-about-the-last-few-years-i">doubted</a>
the technologies, but I&rsquo;m sure such doubters eventually
<a href="http://www.sencha.com/blog/the-making-of-fastbook-an-html5-love-story/">saw the light</a>.
After spending time working on applications for Mozilla&rsquo;s upcoming mobile
operating system, Firefox OS, and talking with my fellow employees, I feel that
the mobile web is another one of those shifts in how we
approach web development that looking back will be an identifiable point in
time where we can say that we did things differently before and after.
So in that sense, I want to share some of the insights I&rsquo;ve found to
help other developers wrap their heads around how developing for the mobile web
isn&rsquo;t their traditional cup of tea.</p>

<h1>Internet connectivity is not guaranteed</h1>

<p>This is a fundamental divorce from the World Wide Web and the Internet. I feel
that a lot of people having trouble differentiating the Web from the Internet;
where you&rsquo;ve had one, you&rsquo;ve always had the other. Don&rsquo;t
assume your application will always have a valid connection.  When a user
is on a wifi connection, or hardwired, it&rsquo;s so obvious that if they&rsquo;re on your
website, then they must be connected to the Internet.  Right?  But what happens
now when one of your users loads up your site or app on a mobile device, then enters
a tunnel?  What does it do when offline?  Does it work?  Maybe it
doesn&rsquo;t make sense if you&rsquo;re offering a service that requires data from the
back end, but does that mean that the front end should totally look like crap
or break when the back end can&rsquo;t be reached?  Do your Ajax requests have error
callbacks?  Do you try and reconnect your WebSocket connections after they&rsquo;ve
failed?  Do you cache previous requests or use one of the many forms of offline
storage to show something to the user?  Developing on the loopback is literally
the best case for connectivity, but it gives the developer a false sense of
how latency and connectivity issues affect their application.  It&rsquo;s literally
shocking the first time you encounter your site/application offline if you
didn&rsquo;t think about the user experience up front.</p>

<h1>Bandwidth is not free</h1>

<p>The advent of broadband made it acceptable for sites to utilize massive amounts
of assets.  Seeing sites that load up so much stuff makes my heart sink when
I wonder about viewing such a site on my mobile device.  I only pay for so much
mobile data per month, then I&rsquo;m billed ridiculous amounts as a
<a href="http://forums.att.com/t5/Data-Messaging-Features-Internet/What-does-quot-Data-MB-Overage-quot-mean/td-p/2872883">&ldquo;Data Overage&rdquo;</a>.
Users in other countries frequently have a more pay as you go style plan, so
they&rsquo;re being billed for each bit across the wire.  In countries without the
infrastructure necessary to get broadband Internet to every household, mobile
is more prolific in getting users connected.</p>

<p>Things like minification and gzip certainly help, but deferred loading of
assets until they&rsquo;re necessary is frequently overlooked.
Massive libraries are nice for devs, but may end up giving mobile users more
problems than they are worth. There exist more advanced techniques such as
<a href="http://buildnewgames.com/optimizing-websockets-bandwidth/">WebSocket compression</a>.</p>

<p>How much does your site <a href="http://www.sitepoint.com/minimizing-page-weight-matters/">weigh</a>?</p>

<h1>An expensive website does not make an awesome app</h1>

<blockquote><p>Why doesn&#8217;t my million dollar website make a kick ass web app?</p></blockquote>


<p>This point is brought to you by <a href="http://www.mattbasta.com/">Matt Basta</a>.  The
point is that there is something fundamentally different between a web &ldquo;site&rdquo;
and a web &ldquo;app&rdquo;.  In a web site the usual flow involves loading up a page
and maybe navigating between pages.  An app more often than not will be a
single page that loads data asynchronously and dynamically modifies the content
displayed to the user.  Some web sites make great use of things like Ajax, and
are great example of single page sites.  But not all are.  Some still haven&rsquo;t
come around to loading all data asynchronously on request.  And it&rsquo;s not that
they necessarily even have to, they can be a website and never have to be
anything more.  But you&rsquo;ll find that some sites make better apps than others.</p>

<h2>No chrome</h2>

<p>Not the browser made by Google, Google Chrome; the actual
<a href="https://developer.mozilla.org/en-US/docs/Chrome">controls</a> on the top
of your browser such as the back and reload buttons, and the url bar.  This
point comes from <a href="https://github.com/cvan">Chris Van Wiemeersch</a>.  One of
the things you&rsquo;ll find when evaluating whether a site makes a good app is
whether it relies on chrome to navigate.  If it does, then it&rsquo;s not really
going to cut it as an app.  If you&rsquo;re going to make a single page app, try
making it fullscreen in your browser and try navigating around. Are you
hindered without the chrome?  One thing I
found recently was an error condition where I notified the user that they had
to be online to check for an update.  But when I was developing, I would just
refresh the page to clear the error message and try again.  On a device, as an
app, where there was no chrome, this meant closing and restarting the app.
That sucked, so I made it so the user could click/touch, after figuring out
their connectivity issues, to retry the fetch.  Even better may have
been to listen for online events!</p>

<h2>Traditional forms of input are not fun</h2>

<p>Here&rsquo;s some tips from <a href="http://potch.me/">Matthew &ldquo;Potch&rdquo; Claypotch</a>.</p>

<h3>Fingers aren&rsquo;t as precise as cursors</h3>

<p>Having tiny click
targets is really frustrating.  How many times have you clicked the wrong
thing on a mobile device?  Tiny buttons are not the easiest thing for users
to specify, especially when groups of them are clustered nearby.  Custom
buttons enabled by <a href="http://www.cssbuttongenerator.com/">a little CSS</a> can go a
long way.</p>

<h3>Typing on little keyboards in tedious</h3>

<p>This is an effect of tiny buttons, but requiring the user to type in large
strings gets annoying fast.  Sometimes this can&rsquo;t be avoided, but it should be
when it can.  Just as typing in a long, complex url to a mobile browser is
not enjoyable, neither is doing so in an app.</p>

<h1>Detect features not browser engine (User agent sniffing is a sin)</h1>

<p>Print <a href="http://diveintohtml5.com/everything.html">this</a> and staple it to your
wall above your workspace.  This should be
<a href="http://www.nczonline.net/blog/2009/12/29/feature-detection-is-not-browser-detection/">old</a>
<a href="http://msdn.microsoft.com/en-us/magazine/hh475813.aspx">news</a> at this point.</p>

<h2>Vendor prefixes are meant for browser vendors to test, not production code</h2>

<p>I place a majority of the blame for this on vendors; prefixes should never see
the light of day in release builds.  It&rsquo;s ridiculous to have to write four
copies of the same rule, when you&rsquo;re trying to express one thing.  I should
rewrite this sentence four different ways to prove a point.  -o-Do you understand
what I&rsquo;m getting at?  -ms-It&rsquo;s almost like rambling. -moz-Repetitive department
of repetition. -webkit-This is ridiculous.</p>

<p>But developers need to recognize the habit as an addiction, and not feed it.
If you have, I forgive you.  Now stop doing it.</p>

<p>These two particular articles are just so good, it wouldn&rsquo;t do them justice to
try and summarize them.  Please go read them, I&rsquo;ll wait.
<a href="http://hsivonen.iki.fi/vendor-prefixes/">this</a>
and
<a href="http://www.quirksmode.org/blog/archives/2010/03/css_vendor_pref.html">this</a></p>

<h2>Developing towards WebKit and not HTML5 is a sin</h2>

<p>I understand that Google Chrome is your favorite browser, and I am so happy for
you; but it is not mine.  I&rsquo;ll be the first to admit that Google
caught all of the other browser vendors with their pants down, but when I see
pages that look flawless in Chrome and
not so hot in others, it reminds me of days when sites only worked in IE6.
Surely you remember <em>those</em> days.  I hate when content publishers try and
dictate which browser I should use to view their content.  I understand WebKit
based browsers dominant in mobile, but so did IE6 in desktop share at one point.
It&rsquo;s not unreasonable to expect users to use the most updated version of their
browser, but empower your users to choose their browser.  Don&rsquo;t take that
choice away from them.</p>

<p>A neat <a href="http://robertnyman.com/2013/02/14/webkit-an-objective-view/">point</a> by
<a href="http://robertnyman.com/">Robert Nyman</a> is that WebKit itself already has forks.
Can you imagine if there were eventually vendor prefixes for forks of WebKit?
Continuing with vendor prefixes means that we&rsquo;ll now have seven vendor prefixes:
unprefixed, -moz-, -o-, -ms-, -webkit-o-, -webkit-chrome-, -webkit-safari-.
Awesome!  Maybe I should rewrite this sentence seven different ways to make a
point!</p>

<p>I&rsquo;m also curious if Google, Apple, and the WebKit maintainers are turning a
blind eye to this, or what their opinions are? Being a vendor and wanting an
open web are almost conflicts of interest; you want your browser to &ldquo;win&rdquo; or
dominate in marketshare, but at the same time you don&rsquo;t want any one browser
having too much marketshare.</p>

<h1>Design Responsively</h1>

<p>What is
<a href="http://mashable.com/2012/12/11/responsive-web-design/">responsive design</a>?
<a href="http://www.smashingmagazine.com/responsive-web-design-guidelines-tutorials/">Responsive design</a>
is making a site look great on
any size screen, without duplicating assets or sniffing a user agent string.
Firefox has a neat web dev tool called
<a href="https://developer.mozilla.org/en-US/docs/Tools/Responsive_Design_View">&ldquo;Responsive Design View&rdquo;</a>.
It&rsquo;s great for testing out your site on various screen sizes.
<a href="http://twitter.github.com/bootstrap/index.html">Twitter Bootstrap</a> is an
excellent example of a framework for developing a single app that looks great
on any screen size.  Even if you don&rsquo;t want to use a whole big framework,
simple things like using CSS rules in terms of percentages instead of hard
coded pixels can go a long way.</p>

<p>Sites that are trying to become more app like have trouble with conforming to
responsive design.  Instead of starting with a site and trying to figure out
how to hide
or not display information as the screen gets smaller, you&rsquo;ll find it much
<a href="http://johnpolacek.github.com/scrolldeck.js/decks/responsive/">easier</a> to
start small, and dynamically add content as the screen gets bigger.</p>

<h1>High performance code respects battery life</h1>

<p>In the end of the day, all of the code you write that runs in the browser is
a set of instructions the processor can decode, not necessarily the high level
JavaScript you wrote.  While it&rsquo;s important to avoid premature optimizations,
having a few
<a href="http://christianheilmann.com/2013/01/25/five-things-you-can-do-to-make-html5-perform-better/">rules of thumb</a>
up front will help you write better, faster code.
If the same overall action can be expressed in one instruction or one hundred,
which do you think will use
<a href="http://coding.smashingmagazine.com/2012/11/05/writing-fast-memory-efficient-javascript/">less power</a>?
Keep in mind that transistors leak current while switching.</p>

<h2>Native methods over library methods, CSS over JS</h2>

<p>What do I mean by &ldquo;native methods?&rdquo; Like C++?  Well, yes.  You see under the
hood the DOM bindings that you&rsquo;re calling are probably written in C++.  Call
<code>toSource()</code> on <code>document.getElementById()</code>.  The <code>[native code]</code> statement
in the returned string refers to the implementation.  While type specialized
code emitted by the JIT can match or even beat native code, you can only count
on that for hot loops.  In the same vein, library code is going to be
<a href="http://jsperf.com/getelementbyid-vs-jquery-id/25">slower</a> than any code
written natively.  I&rsquo;m not saying that you shouldn&rsquo;t use libraries, just know
that the use of libraries can incur some overhead.  Things like animations will
also be faster
when handled by natively implemented CSS over JS.  You can use JS to
dynamically add classes to elements to get finer resolution over events, but
then get the performance of CSS.</p>

<h2>Avoid JIT bailout</h2>

<p>The Just In Time (JIT) interpreter is a
<a href="http://www.slideshare.net/amdgigabyte/know-your-javascript-engine">new breed</a>
of VM that most browser
vendors are now using.  The JIT can
<a href="http://s3.mrale.ph/nodecamp.eu/#1">analyze</a> running code, and
<a href="http://en.wikipedia.org/wiki/Code_generation_%28compiler%29#Runtime_code_generation">emit</a>
native code
that is faster than reinterpreting code again, and even higher-optimized code
for type stable JavaScript, as long as certain &ldquo;guard&rdquo; conditions are met.
When a guard fails, the JIT has to
<a href="http://mxr.mozilla.org/mozilla-central/source/js/src/ion/Bailouts.h#19">bailout</a>
the emitted native code and start reinterpreting code again.</p>

<h2>Keep up to date on new APIs</h2>

<p>HTML5 is a big
<a href="http://www.w3.org/html/wg/drafts/html/master/single-page.html">spec</a>, and is
getting bigger.  So big that some recommendations are
being <a href="http://www.websocket.org/aboutwebsocket.html">spun off</a> from the
original HTML5 spec.  As an engineer, I&rsquo;m painfully aware that you need to
<a href="http://bonsaiden.github.com/JavaScript-Garden/">keep up</a>
in whatever industry you work in in order to stay relevant.
The complacent are the most vulnerable.  There&rsquo;s
<a href="http://caniuse.com/">a lot to keep track of</a> with
HTML5 and CSS3, but many new features offer higher performance methods of
skinning the cat.</p>

<h3>requestAnimationFrame</h3>

<p>window.requestAnimation frame is a godsend for animation.  Not too long ago, I
wrote up a quick
<a href="https://github.com/nickdesaulniers/canvas2dcontext/blob/master/examples/sprite.html#L6">example</a>
of various ways of implementing animation loops and their issues; you should
check it out.</p>

<h3>indexedDB over localstorage</h3>

<p>The indexedDB api might not be as simple as localstorage&rsquo;s is, but localstorage
is synchronous and is noticeably slow on mobile.  If you can bite the bullet
and use indexedDB, you&rsquo;ll find you&rsquo;re JS isn&rsquo;t blocking on
serializing/deserializing objects for storage.
<a href="https://twitter.com/fabricedesre">Fabrice Desré</a> shared this with me.</p>

<h3>WebWorkers</h3>

<p>Webworkers can&rsquo;t modify the DOM, but they can do heavy lifting without blocking
the main thread.</p>

<h3>CSS translate over absolute top and left rules</h3>

<p><a href="http://digitarald.de/">Harald Kirschner</a> recommends CSS translates over top
and left rules for absolutely positioning some elements.</p>

<h3>Gradients are expensive</h3>

<p><a href="http://www.backalleycoder.com/">Dan Buchner</a> notes that without beefy graphics
processing units of their desktop counterparts to enable hardware acceleration,
things like gradients will give you noticeable performance hits.</p>

<h3>createDocumentFragment</h3>

<p>Dan also suggests queuing up DOM changes.
Whenever you manipulate items in the DOM, you&rsquo;re going to trigger a reflow,
which may consist of an update to the layout and/or a repaint.  Minimizing these
makes for a faster update to the DOM.  For example, it can be faster to use
document.createDocumentFragment and append child nodes to it, and then append
that to the DOM, instead of appending lots of child nodes in between timer calls.
Surprise, this isn&rsquo;t actually a
<a href="http://ejohn.org/blog/dom-documentfragments/">new</a> DOM binding from HTML5.</p>

<h1>Conclusion</h1>

<p>These are just some tips I have for application developers.  I am by no means
an expert; I&rsquo;m sure if you dig deep enough, you can find plenty of examples of
my past work that contradicts some of my recommendations from this article.  But
I&rsquo;m a little smarter today than I was yesterday, and now so are you!  What are some
tips that you have to share that you&rsquo;ve found helpful developing for the
mobile web?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/26/c-function-pointers-alternate-syntax/">C Function Pointers Alternate Syntax</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-26T17:49:00-08:00" pubdate data-updated="true">Jan 26<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/26/c-function-pointers-alternate-syntax/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>On an interview with <a href="https://squareup.com/">Square</a>, I made the mistake
of stating that one of the benefits of working with JavaScript over C is
that functions are <a href="http://en.wikipedia.org/wiki/First-class_function">first class</a>
in JavaScript, therefore they may be <a href="http://eloquentjavascript.net/chapter6.html">passed around</a>.  To which the
interviewer replied, &ldquo;Well, C can do that, what about function pointers?&rdquo;  What? Luckily, I
was able to get out of that jam by guessing that JavaScript had a nicer
syntax.</p>

<p>While I was taught some C in university, we had never gone over function
pointers or more in depth topics such as <a href="http://en.wikipedia.org/wiki/Static_library">static</a>
or <a href="http://en.wikipedia.org/wiki/Dynamic_library">dynamic</a> <a href="http://www.yolinux.com/TUTORIALS/LibraryArchives-StaticAndDynamic.html">linkage</a>.
I was so embarrassed that my expensive (read <a href="http://online.wsj.com/article/SB10001424127887324442304578231922159602676.html?mod=WSJ_hps_LEFTTopStories">overpriced</a>)
degree had not taught me more about
the C programming language, especially from the Computer Engineering
department that focuses on software <strong>AND</strong> hardware.  On my exit
interview with the dean, I was very opinionated on the amount of C that
was (or wasn&rsquo;t) taught at my university.  His argument was that there
are only so much of so many languages you can cover in a university, which
to some extent is valid.  My problem has been that I&rsquo;ve enjoyed learning
many different programming languages, though I didn&rsquo;t really get it the
first time around (with Java).  I think knowing many different languages
and their respective paradigms makes you a better programmer in other
languages, since you can bring a <a href="http://therubyway.org/">Ruby Way</a> to
<a href="http://www.rust-lang.org/">Rust</a> or a <a href="http://www.ibm.com/developerworks/library/wa-javascript/index.html">JavaScript functional</a>
<a href="http://interglacial.com/hoj/hoj.html">style</a> into C.</p>

<p>I had read two books in the meantime that really flushed out more of the
C language to me and I would definitely recommend them to those who want
to learn more about the language. They are <a href="http://shop.oreilly.com/product/0636920015482.do">Head First C</a> by Dave and Dawn
Griffiths and <a href="http://shop.oreilly.com/product/0636920025108.do">21st Century C</a> by Ben Klemens.
I&rsquo;m also aware that <a href="http://en.wikipedia.org/wiki/The_C_Programming_Language">The C Programming Language</a> by
Brian Kernighan and Dennis Ritchie is also known as the canonical text.
The book is often referred to as &lsquo;K&amp;R&rsquo; after the authors&#8217; initials, and Dennis
Ritchie was the original creators of the C language and co-developer of
Unix.  I&rsquo;d love to get a chance to read it someday.</p>

<p><a href="http://blog.charlescary.com/?p=95">This article</a> appeared on
<a href="http://news.ycombinator.com/">Hacker News</a> and really piqued my
interest.  Defenitely a great read.  What really stuck out to me was one
of the <a href="http://blog.charlescary.com/?p=95#comment-31">comments</a> though.
The author of the comment mentioned a less ugly syntax for function
pointers, with a <a href="http://pastebin.com/MsJLY22j">link to an example</a>.
Now I&rsquo;m not sure what the commenter meant by &ldquo;these params decay
naturally to function pointers&rdquo; but I was skeptical about this different
syntax.  Even the <a href="http://en.wikipedia.org/wiki/Function_pointer#Example_in_C">Wikipedia article</a>
used the syntax that I was familiar with.  So I wrote up a quick example
to try it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// compiled with:</span>
</span><span class='line'><span class="c1">// clang -Wall -Wextra function_pointers.c -o function_pointers</span>
</span><span class='line'><span class="cp">#include &quot;stdio.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">usual_syntax</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;usual syntax start&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">fn</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;usual syntax end&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">other_syntax</span> <span class="p">(</span><span class="kt">void</span> <span class="n">fn</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;other syntax start&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">fn</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;other syntax end&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">hello</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">usual_syntax</span><span class="p">(</span><span class="n">hello</span><span class="p">);</span>
</span><span class='line'>  <span class="n">other_syntax</span><span class="p">(</span><span class="n">hello</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sure enough we get:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">hello</span> <span class="n">world</span>
</span><span class='line'><span class="n">usual</span> <span class="n">syntax</span> <span class="n">start</span>
</span><span class='line'><span class="n">hello</span> <span class="mi">1</span>
</span><span class='line'><span class="n">usual</span> <span class="n">syntax</span> <span class="n">end</span>
</span><span class='line'><span class="n">other</span> <span class="n">syntax</span> <span class="n">start</span>
</span><span class='line'><span class="n">hello</span> <span class="mi">2</span>
</span><span class='line'><span class="n">other</span> <span class="n">syntax</span> <span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the moral to the story I guess is that there&rsquo;s always more to your
favorite language.  From using <a href="https://github.com/nickdesaulniers/21stCenturyC/blob/master/chpt10/variadic_macros.c">variadic macros</a>
with <a href="https://github.com/nickdesaulniers/21stCenturyC/blob/master/chpt10/compound_literal.c">compound literals</a>
to enable a more <a href="https://github.com/nickdesaulniers/21stCenturyC/blob/master/chpt10/foreach.c">functional style</a>
in C to reflecting upon a function&rsquo;s <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Function/length">number of arguments</a>
or <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Function/name">name</a>
or <a href="http://taylodl.wordpress.com/2012/09/03/functional-javascript-memoization-part-ii/">adding attributes to a function</a>
or the
<a href="http://matt.might.net/articles/implementation-of-recursive-fixed-point-y-combinator-in-javascript-for-memoization/">y-combinator</a>
in JavaScript, I learn something new every day.  And I hope that you did
too!  Thanks for reading!  If you have some other recommendations on
good programming books, or design patterns, please leave a comment or
write a reply blog post!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/30/data-models-and-word-size/">Data Models and Word Size</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/15/whats-in-a-word/">What&#8217;s in a Word?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/">Intro to Debugging X86-64 Assembly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/14/my-siggraph-2015-experience/">My SIGGRAPH 2015 Experience</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/23/additional-c-slash-c-plus-plus-tooling/">Additional C/C++ Tooling</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/nickdesaulniers">@nickdesaulniers</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nickdesaulniers',
            count: 20,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Nick Desaulniers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wangstabill';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
