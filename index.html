
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nick Desaulniers</title>
  <meta name="author" content="Nick Desaulniers">

  
  <meta name="description" content="A blog post from a few years ago that really stuck with me was Martin Olsson’s
Browser Engines 2015: Commit Rates and Active Developer Counts,
where &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nickdesaulniers.github.io">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nick Desaulniers" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at https://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36993986-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Nick Desaulniers</a></h1>
  
    <h2>The enemy's gate is down</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:nickdesaulniers.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/publications">Publications</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/05/gcc-vs-llvm-q3-2017-commit-rates-and-active-developer-counts/">GCC vs LLVM Q3 2017: Active Developer Counts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-05T00:20:00-07:00" pubdate data-updated="true">Sep 5<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/09/05/gcc-vs-llvm-q3-2017-commit-rates-and-active-developer-counts/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A blog post from a few years ago that really stuck with me was Martin Olsson’s
<a href="https://mo.github.io/2015/11/04/browser-engines-active-developers-and-commit-rates.html">Browser Engines 2015: Commit Rates and Active Developer Counts</a>,
where he shows information about the number of authors and commits to popular
web browsers.  The graphs and analysis had interesting takeaways like showing
the obvious split in blink and webkit, and relative number of contributors of
the projects.  Martin had data comparing gcc to llvm from Q4 2015, but I wanted
to see what the data looked like now in Q3 2017 and wanted to share my
findings; simply rerunning the numbers.  Luckily Martin
<a href="https://github.com/mo/git-source-metrics">open sourced</a>
the scripts he used for measurements so they could be rerun.</p>

<p>Commit count and active authors in the previous 60 days is a rough estimate for
project health; the scripts don’t/can’t account for unique authors (same author
using different git commit info) and commit frequency is meaningless for
comparing developers that commit early and commit often, but let’s take a look.
Active contributors over 60 days cuts out folks who do commit to either code
bases, just not as often.  Lies, damn lies, and statistics, right? Or torture
the data enough, and it will confess anything&hellip;</p>

<p>Note that LLVM is split into a few repositories (llvm the common base, clang
the C/C++ frontend, libc++ the C++ runtime, compiler-rt the
sanitizers/built-ins/profiler lib, lld the linker, clang-tools-extra the
utility belt, lldb the debugger (there are more, these are the most active LLVM
projects)).  Later, I refer to LLVM as the grouping of these repos.</p>

<p>There’s a lot of caveats with this data.  I suspect that the separate LLVM
repo’s have a lot of overlap and have fewer active contributors when looked at
in aggregate.  That is to say you can’t simply add them else you’d be double
counting a bunch.  Also, the comparison is not quite fair since the overlap in
front-end-language and back-end-target support in these two massive projects
does not overlap in a lot of places.</p>

<p><img class="center" src="/images/gcc_clang_authors.jpg"></p>

<p>LLVM’s 60 day active contributors are ~3x-5x times GCC’s and growing, while
GCC’s 100-count hasn’t changed much since ‘04.  It’s safe to say GCC is not
dying; it’s going steady and chugging away as it has been, but it seems LLVM
has been very strong in attracting active contributors.  Either way, I’m
thankful to have not one, but two high quality open source C/C++ compilers.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/05/31/running-clang-tidy-on-the-linux-kernel/">Running Clang-Tidy on the Linux Kernel</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-05-31T20:25:00-07:00" pubdate data-updated="true">May 31<span>st</span>, 2017</time>
        
         | <a href="/blog/2017/05/31/running-clang-tidy-on-the-linux-kernel/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://clang.llvm.org/extra/clang-tidy/">Clang-Tidy</a> is a linter from the LLVM
ecosystem.  I wanted to try to run it on the Linux kernel to see what kind of
bugs it would find.  The false positive rate seems pretty high (a persistent
bane to static analysis), but some patching in both the tooling and the source
can likely help bring this rate down.</p>

<p>The most straightforward way to invoke Clang-Tidy is with a compilation
database, which is a json based file that for each translation unit records</p>

<ol>
<li>The source file of the translation unit.</li>
<li>The top level directory of the source.</li>
<li>The exact arguments passed to the compiler.</li>
</ol>


<p>The exact arguments are required because <code>-D</code> and <code>-I</code> flags are necessary to
reproduce the exact Abstract Syntax Tree (AST) used to compile your code. Given
a compilation database, it&rsquo;s trivial to parse and recreate a build.  For the
kernel&rsquo;s KBuild, it&rsquo;s a lot like encoding the output of <code>make V=1</code>.</p>

<p>In order to generate a compilation database, we can use an awesome tool called
<a href="https://github.com/rizsotto/Bear">BEAR</a>. BEAR will
<a href="https://github.com/rizsotto/Bear/blob/6b07f5044f30a3070d1dc39801bcdd94395d673e/libear/ear.c#L21">hook</a>
calls to
<a href="https://linux.die.net/man/3/exec">exec</a>
and family, then write out the compilation database (compile_commands.json).</p>

<p>With BEAR installed, we can invoke the kernel&rsquo;s build with <code>bear make -j</code>. When
we&rsquo;re done:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  linux git:<span class="o">(</span>nick<span class="o">)</span> ✗ du -h compile_commands.json
</span><span class='line'>11M compile_commands.json
</span><span class='line'>➜  linux git:<span class="o">(</span>nick<span class="o">)</span> ✗ wc -l compile_commands.json
</span><span class='line'>330296 compile_commands.json
</span><span class='line'>➜  linux git:<span class="o">(</span>nick<span class="o">)</span> ✗ head -n 26 compile_commands.json
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;arguments&quot;</span>: <span class="o">[</span>
</span><span class='line'>            <span class="s2">&quot;cc&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-c&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wp,-MD,arch/x86/boot/tools/.build.d&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wall&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wmissing-prototypes&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wstrict-prototypes&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-O2&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-fomit-frame-pointer&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-std=gnu89&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wno-unused-value&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wno-unused-parameter&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-Wno-missing-field-initializers&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-I./tools/include&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-include&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;include/generated/autoconf.h&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-D__EXPORTED_HEADERS__&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;-o&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;arch/x86/boot/tools/build&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;arch/x86/boot/tools/build.c&quot;</span>
</span><span class='line'>        <span class="o">]</span>,
</span><span class='line'>        <span class="s2">&quot;directory&quot;</span>: <span class="s2">&quot;/home/nick/linux&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;file&quot;</span>: <span class="s2">&quot;arch/x86/boot/tools/build.c&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span></code></pre></td></tr></table></div></figure>


<p>Now with Clang-Tidy (probably worthwhile to build from source, but it&rsquo;s also
available off <code>apt</code>), we want to grab
<a href="https://github.com/llvm-mirror/clang-tools-extra/blob/master/clang-tidy/tool/run-clang-tidy.py">this helper script, run-clang-tidy.py</a>
to help analyze all this code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -O https://raw.githubusercontent.com/llvm-mirror/clang-tools-extra/master/clang-tidy/tool/run-clang-tidy.py
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run it from the same directory as compile_commands.json:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>python run-clang-tidy.py <span class="se">\</span>
</span><span class='line'>  -clang-tidy-binary /usr/bin/clang-tidy-4.0 <span class="se">\</span>
</span><span class='line'>  &gt; clang_tidy_output.txt
</span></code></pre></td></tr></table></div></figure>


<p>This took about 1hr12min on my box. Let&rsquo;s see what the damage is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  linux git:<span class="o">(</span>nick<span class="o">)</span> ✗ cat clang_tidy_output.txt <span class="se">\</span>
</span><span class='line'>  | grep warning: | grep -oE <span class="s1">&#39;[^ ]+$&#39;</span> | sort | uniq -c
</span><span class='line'>
</span><span class='line'>     76 <span class="o">[</span>clang-analyzer-core.CallAndMessage<span class="o">]</span>
</span><span class='line'>     15 <span class="o">[</span>clang-analyzer-core.DivideZero<span class="o">]</span>
</span><span class='line'>      1 <span class="o">[</span>clang-analyzer-core.NonNullParamChecker<span class="o">]</span>
</span><span class='line'>    316 <span class="o">[</span>clang-analyzer-core.NullDereference<span class="o">]</span>
</span><span class='line'>     90 <span class="o">[</span>clang-analyzer-core.UndefinedBinaryOperatorResult<span class="o">]</span>
</span><span class='line'>      1 <span class="o">[</span>clang-analyzer-core.uninitialized.ArraySubscript<span class="o">]</span>
</span><span class='line'>   1410 <span class="o">[</span>clang-analyzer-core.uninitialized.Assign<span class="o">]</span>
</span><span class='line'>     10 <span class="o">[</span>clang-analyzer-core.uninitialized.Branch<span class="o">]</span>
</span><span class='line'>      5 <span class="o">[</span>clang-analyzer-core.uninitialized.UndefReturn<span class="o">]</span>
</span><span class='line'>     11 <span class="o">[</span>clang-analyzer-cplusplus.NewDeleteLeaks<span class="o">]</span>
</span><span class='line'>    694 <span class="o">[</span>clang-analyzer-deadcode.DeadStores<span class="o">]</span>
</span><span class='line'>    342 <span class="o">[</span>clang-analyzer-security.insecureAPI.strcpy<span class="o">]</span>
</span><span class='line'>      2 <span class="o">[</span>clang-analyzer-unix.API<span class="o">]</span>
</span><span class='line'>     11 <span class="o">[</span>clang-analyzer-unix.Malloc<span class="o">]</span>
</span><span class='line'>      4 <span class="o">[</span>clang-diagnostic-address-of-packed-member<span class="o">]</span>
</span><span class='line'>      2 <span class="o">[</span>clang-diagnostic-duplicate-decl-specifier<span class="o">]</span>
</span><span class='line'>     98 <span class="o">[</span>clang-diagnostic-implicit-int<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking through the output, there&rsquo;s seems to be almost nothing but false
positives, but who knows, maybe there&rsquo;s an actual bug or two in there.  Likely
possible patches to LLVM, its checkers, or the Linux kernel could lower the
false positive ratio.</p>

<p>If you&rsquo;re interested in seeing the kinds of warnings/outputs, I&rsquo;ve uploaded my
results run on a 4.12-rc3 based kernel that may or may not have been compiled
with Clang to
<a href="https://github.com/nickdesaulniers/linux/blob/clang_tidy/clang_tidy_output.txt.v2">my clang_tidy branch of the kernel on GitHub</a>.
As in my sorted output, I find it handy to <code>grep</code> for <code>warning:</code>. Maybe you can
find yourself a good first bug to
<a href="blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/">contribute a fix to the kernel</a>?</p>

<p>There&rsquo;s likely also
<a href="http://clang.llvm.org/extra/clang-tidy/checks/list.html">some checks that make sense to disable or enable</a>.
Clang-Tidy also allows you to
<a href="http://clang.llvm.org/extra/clang-tidy/#writing-a-clang-tidy-check">write and use your own checkers</a>.
Who knows, someone may just end up writing static
analyses tailored to the Linux kernel.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/">Submitting Your First Patch to the Linux Kernel and Responding to Feedback</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-05-16T01:02:00-07:00" pubdate data-updated="true">May 16<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After working on the Linux kernel for Nexus and Pixel phones for nearly a year,
and messing around with the
excellent <a href="http://eudyptula-challenge.org/">Eudyptula challenge</a>, I finally
wanted to take a crack at submitting patches upstream to the Linux kernel.</p>

<p>This post is woefully inadequate compared to the existing documentation, which
should be preferred.</p>

<ul>
<li><a href="http://elixir.free-electrons.com/linux/latest/source/Documentation/process">http://elixir.free-electrons.com/linux/latest/source/Documentation/process</a></li>
<li><a href="https://kernelnewbies.org/FirstKernelPatch">https://kernelnewbies.org/FirstKernelPatch</a></li>
</ul>


<p>I figure I’d document my workflow, now that I’ve gotten a few patches accepted
(and so I can refer to this post rather than my shell history&hellip;).  Feedback
welcome
(<a href="https://github.com/nickdesaulniers/nickdesaulniers.github.com/issues">open an issue</a>
or email me).</p>

<h2>Step 1: Setting up an email client</h2>

<p>I mostly use <code>git send-email</code> for sending patch files.  In my <code>~/,gitconfig</code> I
have added:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[sendemail]</span>
</span><span class='line'>  <span class="c1">; setup for using git send-email; prompts for password</span>
</span><span class='line'>  <span class="na">smtpuser</span> <span class="o">=</span> <span class="s">myemailaddr@gmail.com</span>
</span><span class='line'><span class="s">  smtpserver = smtp.googlemail.com</span>
</span><span class='line'><span class="s">  smtpencryption = tls</span>
</span><span class='line'><span class="s">  smtpserverport = 587</span>
</span></code></pre></td></tr></table></div></figure>


<p>To send patches through my gmail account.  I don’t add my password so that I
don’t have to worry about it when I publish my dotfiles.  I simply get prompted
every time I want to send an email.</p>

<p>I use
<a href="https://nickdesaulniers.github.io/blog/2016/06/18/mutt-gmail-ubuntu/">mutt</a>
to respond to threads when I <em>don&rsquo;t</em> have a patch to send.</p>

<h2>Step 2: Make fixes</h2>

<p>How do you find a bug to fix?  My general approach to finding bugs in open
source C/C++ code bases has been using static analysis, a different compiler,
and/or more compiler warnings turned on.  The kernel also has an instance of
<a href="https://bugzilla.kernel.org/describecomponents.cgi">bugzilla</a>
running as an issue tracker.  Work out of a new branch, in case you choose to
abandon it later.  Rebase your branch before submitting (pull early, pull
often).</p>

<h2>Step 3: Thoughtful commit messages</h2>

<p>I always run <code>git log &lt;file I modified&gt;</code> to see some of the previous commit
messages on the file I modified.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log arch/x86/Makefile
</span><span class='line'>
</span><span class='line'>commit a5859c6d7b6114fc0e52be40f7b0f5451c4aba93
</span><span class='line'>...
</span><span class='line'>    x86/build: convert <span class="k">function </span>graph <span class="s1">&#39;-Os&#39;</span> error to warning
</span><span class='line'>commit 3f135e57a4f76d24ae8d8a490314331f0ced40c5
</span><span class='line'>...
</span><span class='line'>    x86/build: Mostly disable <span class="s1">&#39;-maccumulate-outgoing-args&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first words of commit messages in Linux are usually
<code>&lt;subsystem&gt;/&lt;sub-subsystem&gt;: &lt;descriptive comment&gt;</code>.</p>

<p>Let’s commit, <code>git commit &lt;files&gt; -s</code>.  We use the <code>-s</code> flag to <code>git commit</code> to
add our signoff.  Signing your patches is standard and notes your agreement to
the
<a href="https://ltsi.linuxfoundation.org/developers/signed-process">Linux Kernel Certificate of Origin</a>.</p>

<h2>Step 4: Generate Patch file</h2>

<p><code>git format-patch HEAD~</code>.  You can use <code>git format-patch HEAD~&lt;number of
commits to convert to patches&gt;</code> to turn multiple commits into patch files.
These patch files will be emailed to the
<a href="https://lkml.org/">Linux Kernel Mailing List (lkml)</a>.
They can be applied with <code>git am &lt;patchfile&gt;</code>.  I like to back these files up
in another directory for future reference, and cause I still make a lot of
mistakes with git.</p>

<h2>Step 5: checkpatch</h2>

<p>You’re going to want to run the kernel’s linter before submitting.  It will
catch style issues and other potential issues.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./scripts/checkpatch.pl 0001-x86-build-don-t-add-maccumulate-outgoing-args-w-o-co.patch
</span><span class='line'>total: 0 errors, 0 warnings, 9 lines checked
</span><span class='line'>
</span><span class='line'>0001-x86-build-don-t-add-maccumulate-outgoing-args-w-o-co.patch has no obvious style problems and is ready <span class="k">for </span>submission.
</span></code></pre></td></tr></table></div></figure>


<p>If you hit issues here, fix up your changes, update your commit with <code>git
commit --amend &lt;files updated&gt;</code>, rerun format-patch, then rerun checkpatch
until you’re good to go.</p>

<h2>Step 6: email the patch to yourself</h2>

<p>This is good to do when you’re starting off.  While I use
<a href="https://nickdesaulniers.github.io/blog/2016/06/18/mutt-gmail-ubuntu/">mutt</a>
for responding to email, I use <code>git send-email</code> for sending patches.  Once
you’ve gotten a hang of the workflow, this step is optional, more of a sanity
check.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git send-email <span class="se">\</span>
</span><span class='line'>0001-x86-build-require-only-gcc-use-maccumulate-outgoing-.patch
</span></code></pre></td></tr></table></div></figure>


<p>You don’t need to use command line arguments to cc yourself, assuming you set
up git correctly, git send-email should add you to the cc line as the author of
the patch.  Send the patch just to yourself and make sure everything looks ok.</p>

<h2>Step 7: fire off the patch</h2>

<p>Linux is huge, and has a trusted set of maintainers for various subsystems.
The
<a href="http://elixir.free-electrons.com/linux/latest/source/MAINTAINERS">MAINTAINERS file</a>
keeps track of these, but Linux has a tool to help you figure out where to send
your patch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./scripts/get_maintainer.pl 0001-x86-build-don-t-add-maccumulate-outgoing-args-w-o-co.patch
</span><span class='line'>Person A &lt;person@a.com&gt; <span class="o">(</span>maintainer:X86 ARCHITECTURE <span class="o">(</span>32-BIT AND 64-BIT<span class="o">))</span>
</span><span class='line'>Person B &lt;person@b.com&gt; <span class="o">(</span>maintainer:X86 ARCHITECTURE <span class="o">(</span>32-BIT AND 64-BIT<span class="o">))</span>
</span><span class='line'>Person C &lt;person@c.com&gt; <span class="o">(</span>maintainer:X86 ARCHITECTURE <span class="o">(</span>32-BIT AND 64-BIT<span class="o">))</span>
</span><span class='line'>x86@kernel.org <span class="o">(</span>maintainer:X86 ARCHITECTURE <span class="o">(</span>32-BIT AND 64-BIT<span class="o">))</span>
</span><span class='line'>linux-kernel@vger.kernel.org <span class="o">(</span>open list:X86 ARCHITECTURE <span class="o">(</span>32-BIT AND 64-BIT<span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>With some additional flags, we can feed this output directly into
<code>git send-email</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git send-email <span class="se">\</span>
</span><span class='line'>--cc-cmd<span class="o">=</span><span class="s1">&#39;./scripts/get_maintainer.pl --norolestats 0001-my.patch&#39;</span> <span class="se">\</span>
</span><span class='line'>--cc person@a.com <span class="se">\</span>
</span><span class='line'>0001-my.patch
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to cc yourself when prompted.  Otherwise if you don’t subscribe to
LKML, then it will be difficult to reply to feedback.  It’s also a good idea to
cc any other author that has touched this functionality recently.</p>

<h2>Step 8: monitor feedback</h2>

<p><a href="https://patchwork.kernel.org/project/LKML/list/">Patchwork</a>
for the LKML is a great tool for tracking the progress of patches.  You should
register an account there.   I highly recommend bookmarking your submitter
link.  In Patchwork, click any submitter, then Filters (hidden in the top
left), change submitter to your name, click apply, then bookmark it.
<a href="https://patchwork.kernel.org/project/LKML/list/?submitter=Nick+Desaulniers">Here’s what mine looks like</a>.
Not much today, and mostly trivial patches, but hopefully this post won’t age
well in that regard.</p>

<p>Feedback may or may not be swift.  I think my first patch I had to ping a
couple of times, but eventually got a response.</p>

<h2>Step 9: responding to feedback</h2>

<p>Update your file, <code>git commit &lt;changed files&gt; --amend</code> to update your latest
commit, <code>git format-patch -v2 HEAD~</code>, edit the patch
file to put the changes below the dash below the signed off lines
(<a href="https://patchwork.kernel.org/patch/9720097/">example</a>), rerun checkpatch,
rerun get_maintainer if the files you modified changed since V1.  Next, you
need to find the messageID to respond to the thread properly.</p>

<p>In gmail, when viewing the message I want to respond to, you can click “Show
Original” from the dropdown near the reply button.  From there, copy the
MessageID from the top (everything in the angle brackets, but not the brackets
themselves).  Finally, we send the patch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git send-email <span class="se">\</span>
</span><span class='line'>--cc-cmd<span class="o">=</span><span class="s1">&#39;./scripts/get_maintainer.pl --norolestats 0001-my.patch&#39;</span> <span class="se">\</span>
</span><span class='line'>--cc person@a.com <span class="se">\</span>
</span><span class='line'>--in-reply-to 2017datesandletters@somehostname <span class="se">\</span>
</span><span class='line'>0001-my.patch
</span></code></pre></td></tr></table></div></figure>


<p>We make sure to add anyone who may have commented on the patch from the mailing
list to keep them in the loop.  Rinse and repeat 2 through 9 as desired until
patch is signed off/acked or rejected.</p>

<p>I&rsquo;ve added this handy shell function to my <code>~/.zshrc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">function </span>kpatch <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">patch</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>  <span class="nb">shift</span>
</span><span class='line'><span class="nb">  </span>git send-email <span class="se">\</span>
</span><span class='line'>    --cc-cmd<span class="o">=</span><span class="s2">&quot;./scripts/get_maintainer.pl --norolestats $patch&quot;</span> <span class="se">\</span>
</span><span class='line'>    <span class="nv">$@</span> <span class="nv">$patch</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That I can then invoke like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>kpatch 0001-Input-mousedev-fix-implicit-conversion-warning.patch --cc anyone@else.com
</span></code></pre></td></tr></table></div></figure>


<p>where <code>anyone@else.com</code> is anyone I want to add in additon to what
<code>get_maintainer</code> sugguests.</p>

<p>Finding out when your patch gets merged is a little tricky; each subsystem
maintainer seems to do things differently.  My first patch, I didn’t know it
went in until a bot at Google notified me.  The maintainers for the second and
third patches had bots notify me that it got merged into their trees, but when
they send Linus a PR and when that gets merged isn’t immediately obvious.</p>

<p>It’s not like Github where everyone involved gets an email that a PR got merged
and the UI changes.  While there’s pros and cons to having this fairly
decentralized process, and while it is kind of is git’s original designed-for
use case, I’d be remiss not to mention that I really miss Github.  Getting your
first patch acknowledged and even merged is
<a href="https://github.com/nickdesaulniers/What-Open-Source-Means-To-Me#what-open-source-means-to-me">intoxicating and makes you want to contribute more</a>;
radio silence has the opposite effect.</p>

<p>Happy hacking!</p>

<p>(Thanks to Reddit user /u/EliteTK for pointing out that <code>-v2</code> was more concise
than <code>--subject-prefix="Patch vX"</code>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/20/static-and-dynamic-libraries/">Static and Dynamic Libraries</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-20T23:55:00-08:00" pubdate data-updated="true">Nov 20<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/11/20/static-and-dynamic-libraries/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is the second post in a series on memory segmentation.  It covers working
with static and dynamic libraries in Linux and OSX.  Make sure to check out the
<a href="/blog/2016/08/13/object-files-and-symbols/">first on object files and symbols</a>.</p>

<p>Let’s say we wanted to reuse some of the code from our previous project in our
next one.  We could continue to copy around object files, but let’s say we have
a bunch and it’s hard to keep track of all of them.  Let’s combine multiple
object files into an archive or static library.  Similar to a more conventional
zip file or &ldquo;compressed archive,&rdquo; our static library will be an uncompressed
archive.</p>

<p>We can use the <code>ar</code> command to create and manipulate a static archive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang -c x.c y.c
</span><span class='line'><span class="nv">$ </span>ar -rv libhello.a x.o y.o
</span></code></pre></td></tr></table></div></figure>


<p>The <code>-r</code> flag will create the archive named <code>libhello.a</code> and add the files
<code>x.o</code> and <code>y.o</code> to its index.  I like to add the <code>-v</code> flag for verbose output.
Then we can use the familiar <code>nm</code> tool I introduced in the
<a href="/blog/2016/08/13/object-files-and-symbols/">previous post</a>
to examine the content of the archives and their symbols.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>file libhello.a
</span><span class='line'>libhello.a: current ar archive random library
</span><span class='line'><span class="nv">$ </span>nm libhello.a
</span><span class='line'>libhello.a<span class="o">(</span>x.o<span class="o">)</span>:
</span><span class='line'>                 U _puts
</span><span class='line'>0000000000000000 T _x
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>libhello.a<span class="o">(</span>y.o<span class="o">)</span>:
</span><span class='line'>                 U _puts
</span><span class='line'>0000000000000000 T _y
</span></code></pre></td></tr></table></div></figure>


<p>Some other useful flags for <code>ar</code> are <code>-d</code> to delete an object file, ex. <code>ar -d
libhello.a y.o</code> and <code>-u</code> to update existing members of the archive when their
source and object files are updated.  Not only can we run <code>nm</code> on our archive,
<code>otool</code> and <code>objdump</code> both work.</p>

<p>Now that we have our static library, we can statically link it to our program
and see the resulting symbols.  The <code>.a</code> suffix is typical on both OSX and
Linux for archive files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang main.o libhello.a
</span><span class='line'><span class="nv">$ </span>nm a.out
</span><span class='line'>0000000100000f30 T _main
</span><span class='line'>                 U _puts
</span><span class='line'>0000000100000f50 T _x
</span><span class='line'>0000000100000f70 T _y
</span></code></pre></td></tr></table></div></figure>


<p>Our compiler understands how to index into archive files and pull out the
functions it needs to combine into the final executable.  If we use a static
library to statically link all functions required, we can have one binary with
no dependencies.  This can make deployment of binaries simple, but also greatly
increase their size.  Upgrading large binaries incrementally becomes more
costly in terms of space.</p>

<p>While static libraries allowed us to reuse source code, static linkage does not
allow us to reuse memory for executable code between different processes.  I
really want to put off talking about memory benefits until the next post, but
know that the solution to this problem lies in &ldquo;dynamic libraries.&rdquo;</p>

<p>While having a single binary file keeps things simple, it can really hamper
memory sharing and incremental relinking.  For example, if you have multiple
executables that are all built with the same static library, unless your OS is
really smart about copy-on-write page sharing, then you’re likely loading
multiple copies of the same exact code into memory! What a waste!  Also, when
you want to rebuild or update your binary, you spend time performing relocation
again and again with static libraries.  What if we could set aside object files
that we could share amongst multiple instances of the same or even different
processes, and perform relocation at runtime?</p>

<p>The solution is known as dynamic libraries.  If static libraries and static
linkage were Atari controllers, dynamic libraries and dynamic linkage are Steel
Battalion controllers.  We’ll show how to work with them in the rest of this
post, but I’ll prove how memory is saved in a later post.</p>

<p>Let’s say we want to created a shared version of libhello.  Dynamic libraries
typically have different suffixes per OS since each OS has it’s preferred
object file format.  On Linux the .so suffix is common, .dylib on OSX, and .dll
on Windows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang -shared -fpic x.c y.c -o libhello.dylib
</span><span class='line'><span class="nv">$ </span>file libhello.dylib
</span><span class='line'>libhello.dylib: Mach-O 64-bit dynamically linked shared library x86_64
</span><span class='line'><span class="nv">$ </span>nm libhello.dylib
</span><span class='line'>                 U _puts
</span><span class='line'>0000000000000f50 T _x
</span><span class='line'>0000000000000f70 T _y
</span></code></pre></td></tr></table></div></figure>


<p>The <code>-shared</code> flag tells the linker to create a special file called a shared
library.  The <code>-fpic</code> option converts absolute addresses to relative addresses,
which allows for different processes to load the library at different virtual
addresses and share memory.</p>

<p>Now that we have our shared library, let’s dynamically link it into our
executable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang main.c libhello.dylib
</span><span class='line'><span class="nv">$ </span>./a.out
</span><span class='line'>x
</span><span class='line'>y
</span></code></pre></td></tr></table></div></figure>


<p>The dynamic linker essential produces an incomplete binary.  You can verify
with <code>nm</code>.  At runtime, we’ll delay start up to perform some memory mapping
early on in the process start (performed by the dynamic linker) and pay slight
costs for trampolining into position independent code.</p>

<p>Let’s say we want to know what dynamic libraries a binary is using.  You can
either query the executable (most executable object file formats contain a
header the dynamic linker will parse and pull in libs) or observe the
executable while running it.  Because each major OS has its own object file
format, they each have their own tools for these two checks.  Note that
statically linked libraries won’t show up here, since their object code has
already been linked in and thus we’re not able to differentiate between object
code that came from our first party code vs third party static libraries.</p>

<p>On OSX, we can use <code>otool -L &lt;bin&gt;</code> to check which .dylibs will get pulled in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>otool -L a.out
</span><span class='line'>a.out:
</span><span class='line'>           libhello.dylib <span class="o">(</span>compatibility version 0.0.0, current version 0.0.0<span class="o">)</span>
</span><span class='line'>           /usr/lib/libSystem.B.dylib <span class="o">(</span>compatibility version 1.0.0, current version 1226.10.1<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can see that <code>a.out</code> depends on <code>libhello.dylib</code> (and expects to find it
in the same directory as <code>a.out</code>).  It also depends on shared library called
libSystem.B.dylib.  If you run <code>otool -L</code> on libSystem itself, you’ll see it
depends on a bunch of other libraries including a C runtime, malloc
implementation, pthreads implementation, and more.  Let’s say you want to find
the final resting place of where a symbol is defined, without digging with <code>nm</code>
and <code>otool</code>, you can fire up your trusty debugger and ask it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>lldb a.out
</span><span class='line'>...
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> image lookup -r -s puts
</span><span class='line'>...
</span><span class='line'>        Summary: libsystem_c.dylib<span class="sb">`</span>puts        Address: libsystem_c.dylib<span class="o">[</span>0x0000000000085c30<span class="o">]</span> <span class="o">(</span>libsystem_c.dylib.__TEXT.__stubs + 3216<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You’ll see a lot of output since <code>puts</code> is treated as a regex.  You’re looking
for the Summary line that has an address and is <strong>not</strong> a symbol stub.  You can
then check your work with <code>otool</code> and <code>nm</code>.</p>

<p>If we want to observe the dynamic linker in action on OSX, we can use <code>dtruss</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo dtruss ./a.out
</span><span class='line'>...
</span><span class='line'>stat64<span class="o">(</span><span class="s2">&quot;libhello.dylib\0&quot;</span>, 0x7FFF50CEAC68, 0x1<span class="o">)</span>         <span class="o">=</span> 0 0
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;libhello.dylib\0&quot;</span>, 0x0, 0x0<span class="o">)</span>              <span class="o">=</span> 3 0
</span><span class='line'>...
</span><span class='line'>mmap<span class="o">(</span>0x10EF27000, 0x1000, 0x5, 0x12, 0x3, 0x0<span class="o">)</span>          <span class="o">=</span> 0x10EF27000 0
</span><span class='line'>mmap<span class="o">(</span>0x10EF28000, 0x1000, 0x3, 0x12, 0x3, 0x1000<span class="o">)</span>               <span class="o">=</span> 0x10EF28000 0
</span><span class='line'>mmap<span class="o">(</span>0x10EF29000, 0xC0, 0x1, 0x12, 0x3, 0x2000<span class="o">)</span>         <span class="o">=</span> 0x10EF29000 0
</span><span class='line'>...
</span><span class='line'>close<span class="o">(</span>0x3<span class="o">)</span>              <span class="o">=</span> 0 0
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>On Linux, we can simply use <code>ldd</code> or <code>readelf -d</code> to query an executable for a
list of its dynamic libraries.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang -shared -fpic x.c y.c -o libhello.so
</span><span class='line'><span class="nv">$ </span>clang main.c libhello.so
</span><span class='line'><span class="nv">$ </span>ldd a.out
</span><span class='line'>           linux-vdso.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0x00007fff95d43000<span class="o">)</span>
</span><span class='line'>           libhello.so <span class="o">=</span>&gt; not found
</span><span class='line'>           libc.so.6 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span class="o">(</span>0x00007fcc98c5f000<span class="o">)</span>
</span><span class='line'>           /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x0000555993852000<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>readelf -d a.out
</span><span class='line'>Dynamic section at offset 0xe18 contains 25 entries:
</span><span class='line'>  Tag        Type                         Name/Value
</span><span class='line'> 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libhello.so<span class="o">]</span>
</span><span class='line'> 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>We can then use <code>strace</code> to observe the dynamic linker in action on Linux:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ LD_LIBRARY_PATH</span><span class="o">=</span>. strace ./a.out
</span><span class='line'>...
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;./libhello.so&quot;</span>, O_RDONLY|O_CLOEXEC<span class="o">)</span> <span class="o">=</span> 3
</span><span class='line'>...
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\260\5\0\0\0\0\0\0&quot;</span>..., 832<span class="o">)</span> <span class="o">=</span> 832
</span><span class='line'>fstat<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0755, <span class="nv">st_size</span><span class="o">=</span>8216, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>What’s this <code>LD_LIBRARY_PATH</code> thing?  That’s shell syntax for setting an
environmental variable just for the duration of that command (as opposed to
exporting it so it stays set for multiple commands).  As opposed to OSX’s
dynamic linker, which was happy to look in the cwd for libhello.dylib, on Linux
we must supply the cwd if the dynamic library we want to link in is not in the
standard search path.</p>

<p>But what is the standard search path?  Well, there’s another environmental
variable we can set to see this, <code>LD_DEBUG</code>.  For example, on OSX:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ LD_DEBUG</span><span class="o">=</span>libs <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>. ./a.out
</span><span class='line'>     15828:        find <span class="nv">library</span><span class="o">=</span>libhello.so <span class="o">[</span>0<span class="o">]</span>; searching
</span><span class='line'>     15828:         search <span class="nv">path</span><span class="o">=</span>./tls/x86_64:./tls:./x86_64:.             <span class="o">(</span>LD_LIBRARY_PATH<span class="o">)</span>
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./tls/x86_64/libhello.so
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./tls/libhello.so
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./x86_64/libhello.so
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./libhello.so
</span><span class='line'>     15828:
</span><span class='line'>     15828:        find <span class="nv">library</span><span class="o">=</span>libc.so.6 <span class="o">[</span>0<span class="o">]</span>; searching
</span><span class='line'>     15828:         search <span class="nv">path</span><span class="o">=</span>./tls/x86_64:./tls:./x86_64:.             <span class="o">(</span>LD_LIBRARY_PATH<span class="o">)</span>
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./tls/x86_64/libc.so.6
</span><span class='line'>     1earc:          trying <span class="nv">file</span><span class="o">=</span>./tls/libc.so.6
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./x86_64/libc.so.6
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>./libc.so.6
</span><span class='line'>     15828:         search <span class="nv">cache</span><span class="o">=</span>/etc/ld.so.cache
</span><span class='line'>     15828:          trying <span class="nv">file</span><span class="o">=</span>/lib/x86_64-linux-gnu/libc.so.6
</span><span class='line'>     15828:        calling init: /lib/x86_64-linux-gnu/libc.so.6
</span><span class='line'>     15828:        calling init: ./libhello.so
</span><span class='line'>     15828:        initialize program: ./a.out
</span><span class='line'>     15828:        transferring control: ./a.out
</span><span class='line'>x
</span><span class='line'>y
</span><span class='line'>     15828:        calling fini: ./a.out <span class="o">[</span>0<span class="o">]</span>
</span><span class='line'>     15828:        calling fini: ./libhello.so <span class="o">[</span>0<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>LD_DEBUG</code> is pretty useful.  Try:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ LD_DEBUG</span><span class="o">=</span><span class="nb">help</span> ./a.out
</span><span class='line'>Valid options <span class="k">for </span>the LD_DEBUG environment variable are:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  libs        display library search paths
</span><span class='line'>  reloc       display relocation processing
</span><span class='line'>  files       display progress <span class="k">for </span>input file
</span><span class='line'>  symbols     display symbol table processing
</span><span class='line'>  bindings    display information about symbol binding
</span><span class='line'>  versions    display version dependencies
</span><span class='line'>  scopes      display scope information
</span><span class='line'>  all         all previous options combined
</span><span class='line'>  statistics  display relocation statistics
</span><span class='line'>  unused      determined unused DSOs
</span><span class='line'>  <span class="nb">help        </span>display this <span class="nb">help </span>message and <span class="nb">exit</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>To direct the debugging output into a file instead of standard output
</span><span class='line'>a filename can be specified using the LD_DEBUG_OUTPUT environment variable.
</span></code></pre></td></tr></table></div></figure>


<p>For some cool stuff, I recommend checking out <code>LD_DEBUG=symbols</code> and
<code>LD_DEBUG=statistics</code>.</p>

<p>Going back to <code>LD_LIBRARY_PATH</code>, usually libraries you create and want to reuse
between projects go into /usr/local/lib and the headers into
/usr/local/include.  I think of the convention as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>tree -L 2 /usr/
</span><span class='line'>/usr
</span><span class='line'>├── bin <span class="c"># system installed binaries like nm, gcc</span>
</span><span class='line'>├── include <span class="c"># system installed headers like stdio.h</span>
</span><span class='line'>├── lib <span class="c"># system installed libraries, both static and dynamic</span>
</span><span class='line'>└── <span class="nb">local</span>
</span><span class='line'>    ├── bin <span class="c"># user installed binaries like rustc</span>
</span><span class='line'>    ├── include <span class="c"># user installed headers</span>
</span><span class='line'>    └── lib <span class="c"># user installed</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, it’s a loose convention that’s broken down over the years and
things are scattered all over the place.  You can also run into dependency and
versioning issues, that I don’t want to get into here, by placing libraries
here instead of keeping them in-tree or out-of-tree of the source code of a
project.  Just know when you see a library like <code>libc.so.6</code> that the numeric
suffix is a major version number that follows semantic versioning.  For more
information, you should read Michael Kerrisk’s excellent book <em>The Linux
Programming Interface</em>.  This post is based on his chapter’s 41 &amp; 42 (but with
more info on tooling and OSX).</p>

<p>If we were to place our libhello.so into /usr/local/lib (on Linux you need to
then run <code>sudo ldconfig</code>) and move x.h and y.h to /usr/local/include, then we
could then compile with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang main.c -lhello
</span></code></pre></td></tr></table></div></figure>


<p>Note that rather than give a full path to our library, we can use the <code>-l</code> flag
followed by the name of our library with the lib prefix and .so suffix removed.</p>

<p>When working with shared libraries and external code, three flags I use pretty
often:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>* -l&lt;libname to link, no lib prefix or file extension; ex: -lnanomsg to link libnanomsg.so&gt;
</span><span class='line'>* -L &lt;path to search <span class="k">for </span>lib <span class="k">if </span>in non standard directory&gt;
</span><span class='line'>* -I &lt;path to headers <span class="k">for </span>that library, <span class="k">if </span>in non standard directory&gt;
</span></code></pre></td></tr></table></div></figure>


<p>For finding specific flags needed for compilation where dynamic linkage is
required, a tool called <code>pkg-config</code> can be used for finding appropriate flags.
I’ve had less than stellar experiences with the tool as it puts the onus on the
library author to maintain the .pc files, and the user to have them installed
in the right place that <code>pkg-config</code> looks.  When they do exist and are
installed properly, the tool works well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo apt-get install libpng12-dev
</span><span class='line'><span class="nv">$ </span>pkg-config --libs --cflags libpng12
</span><span class='line'>-I/usr/include/libpng12  -lpng12
</span><span class='line'><span class="nv">$ </span>clang program.c <span class="sb">`</span>!!<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using another neat environmental variable, we can hook into the dynamic linkage
process and inject our own shared libraries to be linked instead of the
expected libraries.  Let’s say libgood.so and libmalicous.so both define a
symbol for a function (the same symbol name and function signature).  We can
get a binary that links in libgood.so’s function to instead call
libmalicous.so’s version:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./a.out
</span><span class='line'>hello from libgood
</span><span class='line'><span class="nv">$ LD_PRELOAD</span><span class="o">=</span>./libmalicious.so ./a.out
</span><span class='line'>hello from libmalicious
</span></code></pre></td></tr></table></div></figure>


<p>LD_PRELOAD is not available on OSX, instead you can use
<code>DYLD_INSERT_LIBRARIES</code>, <code>DYLD_LIBRARY_PATH</code>, and recompile the original
executable with <code>-flat_namespace</code>. Having to recompile the original executable
is less than ideal for hooking an existing binary, but I could not hook libc
as in the previous libmalicious example.  I would be interested to know if you
can though!</p>

<p>Manually invoking the dynamic linker from our code,
<a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">we can even man in the middle library calls (call our hooked function first, then invoke the original target)</a>.
We’ll see more of this in the next post on using the dynamic linker.</p>

<p>As you can guess, readjusting the search paths for dynamic libraries is a
security concern as it let’s good and bad folks change the expected execution
paths.  Guarding against the use of these env vars becomes a rabbit hole that
gets pretty tricky to solve without the heavy handed use of statically linking
dependencies.</p>

<p>In the the previous post, I alluded to undefined symbols like <code>puts</code>.  <code>puts</code>
is part of libc, which is probably the most shared dynamic library on most
computing devices since most every program makes use of the C runtime.  (I
think of a “runtime” as implicit code that runs in your program that you didn’t
necessarily write yourself.  Usually a runtime is provided as a library that
gets implicitly linked into your executable when you compile.)  You can
statically link against libc with the <code>-static</code> flag, on Linux at least (OSX
makes this difficult,
<a href="https://developer.apple.com/library/content/qa/qa1118/_index.html">&ldquo;Apple does not support statically linked binaries on Mac OS X&rdquo;</a>).</p>

<p>I’m not sure what the benefit would be to mixing static and dynamic linking,
but after searching the search paths from LD_DEBUG=libs for shared versions of
a library, if any static ones are found, they will get linked in.</p>

<p>There’s also an interesting form of library called a &ldquo;virtual dynamic shared
object&rdquo; on Linux.  I haven’t covered memory mapping yet, but know it exists, is
usually hidden for libc, and that you can read more about it via <code>man 7 vdso</code>.</p>

<p>One thing I find interesting and don’t quite understand how to recreate is that
somehow glibc on Linux is also executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>/lib/x86_64-linux-gnu/libc.so.6
</span><span class='line'>GNU C Library <span class="o">(</span>Ubuntu GLIBC 2.24-3ubuntu1<span class="o">)</span> stable release version 2.24, by Roland McGrath et al.
</span><span class='line'>Copyright <span class="o">(</span>C<span class="o">)</span> 2016 Free Software Foundation, Inc.
</span><span class='line'>This is free software; see the <span class="nb">source </span><span class="k">for </span>copying conditions.
</span><span class='line'>There is NO warranty; not even <span class="k">for </span>MERCHANTABILITY or FITNESS FOR A
</span><span class='line'>PARTICULAR PURPOSE.
</span><span class='line'>Compiled by GNU CC version 6.2.0 20161005.
</span><span class='line'>Available extensions:
</span><span class='line'>    crypt add-on version 2.1 by Michael Glad and others
</span><span class='line'>    GNU Libidn by Simon Josefsson
</span><span class='line'>    Native POSIX Threads Library by Ulrich Drepper et al
</span><span class='line'>    BIND-8.2.3-T5B
</span><span class='line'>libc ABIs: UNIQUE IFUNC
</span><span class='line'>For bug reporting instructions, please see:
</span><span class='line'>&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
</span></code></pre></td></tr></table></div></figure>


<p>Also, note that linking against third party code has licensing implications (of
course) of particular interest when it’s GPL or LGPL.
<a href="http://stackoverflow.com/a/10179181/1027966">Here is a good overview</a>
which I’d summarize as: code that <em>statically</em> links against LGPL code must
also be LGPL, while any form of linkage against GPL code must be GPL’d.</p>

<p>Ok, that was a lot. In the previous post, we covered
<a href="/blog/2016/08/13/object-files-and-symbols/">Object Files and Symbols</a>.
In this post we covered hacking around with static and dynamic linkage.  In the
next post, I hope to talk about manually invoking the dynamic linker at
runtime.</p>

<ul>
<li><a href="/blog/2016/08/13/object-files-and-symbols/">Part 1 &ndash; Object Files and Symbols</a></li>
<li><a href="/blog/2016/11/20/static-and-dynamic-libraries/">Part 2 &ndash; Static and Dynamic Libraries</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/13/object-files-and-symbols/">Object Files and Symbols</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-13T20:46:00-07:00" pubdate data-updated="true">Aug 13<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/08/13/object-files-and-symbols/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>What was supposed to be one blog post about memory segmentation turned into
what will be a series of posts.  As the first in the series, we cover the
extreme basics of object files and symbols.  In follow up posts, I
plan to talk about
<a href="/blog/2016/11/20/static-and-dynamic-libraries/">static libraries, dynamic libraries,</a>
dynamic linkage, memory segments, and finally memory usage accounting.  I also
cover command line tools for working with these notions, both in Linux and OSX.</p>

<p>A quick review of the compilation+execution pipeline (for terminology):</p>

<ol>
<li>Lexing produces tokens</li>
<li>Parsing produces an abstract syntax tree</li>
<li>Analysis produces a code flow graph</li>
<li>Optimization produces a reduced code flow graph</li>
<li>Code gen produces object code</li>
<li>Linkage produces a complete executable</li>
<li>Loader instructs the OS how to start running the executable</li>
</ol>


<p>This series will focus on part #6.</p>

<p>Let&rsquo;s say you have some amazing C/C++ code,  but for separations of concerns,
you want to start moving it out into separate source files.  Whereas previously
in one file you had:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// main.c</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">helper</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;helper&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">helper</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You now have two source files and maybe a header:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// main.c</span>
</span><span class='line'><span class="cp">#include &quot;helper.h&quot;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">helper</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// helper.h</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">helper</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//helper.c</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;helper.h&quot;</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">helper</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;helper&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the single source version, we would have compiled and linked that with
<code>clang main.c</code> and had an executable file.  In the multiple source version, we
first compile our source files to object files, then link them altogether.
That can be done separately:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang -c helper.c     <span class="c"># produces helper.o</span>
</span><span class='line'><span class="nv">$ </span>clang -c main.c       <span class="c"># produces main.o</span>
</span><span class='line'><span class="nv">$ </span>clang main.o helper.o <span class="c"># produces a.out</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also do the compilation and linkage in one step:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang helper.c main.c <span class="c"># produces a.out</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing special thus far; C/C++ 101.  In the first case of separate compilation
and linkage steps, we were left with intermediate object files (.o).  What
exactly are these?</p>

<p><a href="https://en.wikipedia.org/wiki/Object_file">Object files</a>
are almost full executables.  They contain machine code, but that code still
requires a relocation step.  It also contains metadata about the addresses of
its variables and functions (called symbols) in an associative data structure
called a
<a href="https://en.wikipedia.org/wiki/Symbol_table">symbol table</a>.
The addresses may not be the final address of the symbol in the final
executable. They also contain some information for the loader and probably some
other stuff.</p>

<p>Remember that if we fail to specify the helper object file, we&rsquo;ll get an
undefined symbol error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang main.c
</span><span class='line'>Undefined symbols <span class="k">for </span>architecture x86_64:
</span><span class='line'>  <span class="s2">&quot;_helper&quot;</span>, referenced from:
</span><span class='line'>      _main in main-459dde.o
</span><span class='line'>ld: symbol<span class="o">(</span>s<span class="o">)</span> not found <span class="k">for </span>architecture x86_64
</span><span class='line'>clang: error: linker <span class="nb">command </span>failed with <span class="nb">exit </span>code 1 <span class="o">(</span>use -v to see invocation<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem is main.o refers to some symbol called <code>helper</code>, but on it&rsquo;s own
doesn&rsquo;t contain any more information about it.  Let&rsquo;s say we want to know what
symbols an object file contains, or expects to find elsewhere.  Let&rsquo;s introduce
our first tool, <code>nm</code>.  <code>nm</code> will print the name list or symbol table for a
given object or executable file.  On OSX, these are prefixed with an
underscore.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>nm helper.o
</span><span class='line'>0000000000000000 T _helper
</span><span class='line'>                 U _puts
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>nm main.o
</span><span class='line'>                 U _helper
</span><span class='line'>0000000000000000 T _main
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>nm a.out
</span><span class='line'>...
</span><span class='line'>0000000100000f50 T _helper
</span><span class='line'>0000000100000f70 T _main
</span><span class='line'>                 U _puts
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s dissect what&rsquo;s going on here.  The output (as understood by <code>man 1 nm</code>)
is a space separated list of address, type, and symbol name.  We can see that
the addresses are placeholders in object files, and final in executables.  The
name should make sense; it&rsquo;s the name of the function or variable.  While I&rsquo;d
love to get in depth on the various symbol types and talk about sections, I
don&rsquo;t think I could do as great a job as Peter Van Der Linden in his book
&ldquo;Expert C Programming: Deep C Secrets.&rdquo;</p>

<p>For our case, we just care about whether the symbol in a given object file is
defined or not.  The type U (undefined) means that this symbol is referenced or
used in this object code/executable, but it&rsquo;s value wasn&rsquo;t defined here.
When we compiled main.c alone and got the undefined symbol error, it should now
make sense why we got the undefined symbol error for helper.  main.o contains
a symbol for main, and references helper.  helper.o contains a symbol for
helper, and references to puts.  The final executable contains symbols for main
and helper and references to puts.</p>

<p>You might be wondering where puts comes from then, and why didn&rsquo;t we get an
undefined symbol error for puts like we did earlier for helper.  The answer is
the C runtime.  libc is implicitly dynamically linked to all executables
created by the C compiler.  We&rsquo;ll cover dynamic linkage in a later post in
this series.</p>

<p>When the linker performs relocation on the object files, combining them into a
final executable, it goes through placeholders of addresses and fills them in.
We did this manually in our post on
<a href="/blog/2015/05/25/interpreter-compiler-jit/">JIT compilers</a>.</p>

<p>While <code>nm</code> gave us a look into our symbol table, two other tools I use
frequently are <code>objdump</code> on Linux and <code>otool</code> on OSX.  Both of these provide
disassembled assembly instructions and their addresses.  Note how the symbols
for functions get translated into labels of the disassembled functions, and
that their address points to the first instruction in that label.  Since I&rsquo;ve
shown <code>objdump</code>
<a href="/blog/2013/04/03/basic-jit/">numerous times</a>
in
<a href="/blog/2014/04/18/lets-write-some-x86-64/">previous posts</a>,
here&rsquo;s <code>otool</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>otool -tV helper.o
</span><span class='line'>helper.o:
</span><span class='line'><span class="o">(</span>__TEXT,__text<span class="o">)</span> section
</span><span class='line'>_helper:
</span><span class='line'>0000000000000000    pushq    %rbp
</span><span class='line'>0000000000000001    movq    %rsp, %rbp
</span><span class='line'>0000000000000004    subq    <span class="nv">$0x10</span>, %rsp
</span><span class='line'>0000000000000008    leaq    0xe<span class="o">(</span>%rip<span class="o">)</span>, %rdi         <span class="c">## literal pool for: &quot;helper&quot;</span>
</span><span class='line'>000000000000000f    callq    _puts
</span><span class='line'>0000000000000014    movl    %eax, -0x4<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>0000000000000017    addq    <span class="nv">$0x10</span>, %rsp
</span><span class='line'>000000000000001b    popq    %rbp
</span><span class='line'>000000000000001c    retq
</span><span class='line'><span class="nv">$ </span>otool -tV main.o
</span><span class='line'>main.o:
</span><span class='line'><span class="o">(</span>__TEXT,__text<span class="o">)</span> section
</span><span class='line'>_main:
</span><span class='line'>0000000000000000    pushq    %rbp
</span><span class='line'>0000000000000001    movq    %rsp, %rbp
</span><span class='line'>0000000000000004    movb    <span class="nv">$0x0</span>, %al
</span><span class='line'>0000000000000006    callq    _helper
</span><span class='line'>000000000000000b    xorl    %eax, %eax
</span><span class='line'>000000000000000d    popq    %rbp
</span><span class='line'>000000000000000e    retq
</span><span class='line'><span class="nv">$ </span>otool -tV a.out
</span><span class='line'>a.out:
</span><span class='line'><span class="o">(</span>__TEXT,__text<span class="o">)</span> section
</span><span class='line'>_helper:
</span><span class='line'>0000000100000f50    pushq    %rbp
</span><span class='line'>0000000100000f51    movq    %rsp, %rbp
</span><span class='line'>0000000100000f54    subq    <span class="nv">$0x10</span>, %rsp
</span><span class='line'>0000000100000f58    leaq    0x43<span class="o">(</span>%rip<span class="o">)</span>, %rdi        <span class="c">## literal pool for: &quot;helper&quot;</span>
</span><span class='line'>0000000100000f5f    callq    0x100000f80             <span class="c">## symbol stub for: _puts</span>
</span><span class='line'>0000000100000f64    movl    %eax, -0x4<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>0000000100000f67    addq    <span class="nv">$0x10</span>, %rsp
</span><span class='line'>0000000100000f6b    popq    %rbp
</span><span class='line'>0000000100000f6c    retq
</span><span class='line'>0000000100000f6d    nop
</span><span class='line'>0000000100000f6e    nop
</span><span class='line'>0000000100000f6f    nop
</span><span class='line'>_main:
</span><span class='line'>0000000100000f70    pushq    %rbp
</span><span class='line'>0000000100000f71    movq    %rsp, %rbp
</span><span class='line'>0000000100000f74    movb    <span class="nv">$0x0</span>, %al
</span><span class='line'>0000000100000f76    callq    _helper
</span><span class='line'>0000000100000f7b    xorl    %eax, %eax
</span><span class='line'>0000000100000f7d    popq    %rbp
</span><span class='line'>0000000100000f7e    retq
</span></code></pre></td></tr></table></div></figure>


<p><code>readelf -s &lt;object file&gt;</code> will give us a list of symbols on Linux.
<a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a>
is the file format used by the loader on Linux, while OSX uses
<a href="https://en.wikipedia.org/wiki/Mach-O">Mach-O</a>.
Thus <code>readelf</code> and <code>otool</code>, respectively.</p>

<p>Also note that for static linkage, symbols need to be unique*, as they refer to
memory locations to either read/write to in the case of variables or locations
to jump to in the case of functions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat double_define.c
</span><span class='line'>void a <span class="o">()</span> <span class="o">{}</span>
</span><span class='line'>void a <span class="o">()</span> <span class="o">{}</span>
</span><span class='line'>int main <span class="o">()</span> <span class="o">{}</span>
</span><span class='line'><span class="nv">$ </span>clang double_define.c
</span><span class='line'>double_define.c:2:6: error: redefinition of <span class="s1">&#39;a&#39;</span>
</span><span class='line'>void a <span class="o">()</span> <span class="o">{}</span>
</span><span class='line'>     ^
</span><span class='line'>double_define.c:1:6: note: previous definition is here
</span><span class='line'>void a <span class="o">()</span> <span class="o">{}</span>
</span><span class='line'>     ^
</span><span class='line'>1 error generated.
</span></code></pre></td></tr></table></div></figure>


<p>*: there&rsquo;s a notion of weak symbols, and some special things for dynamic
libraries we&rsquo;ll see in a follow up post.</p>

<p>Languages like C++ that support function overloading (functions with the same
name but different arguments, return types, namespaces, or class) must mangle
their function names to make them unique.</p>

<p>Code like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">util</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Widget</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>      <span class="kt">void</span> <span class="n">doSomething</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">save</span><span class="p">);</span>
</span><span class='line'>      <span class="kt">void</span> <span class="n">doSomething</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Will produce symbols like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang class.cpp -std<span class="o">=</span>c++11
</span><span class='line'><span class="nv">$ </span>nm a.out
</span><span class='line'>0000000100000f70 T __ZN4util6Widget11doSomethingEb
</span><span class='line'>0000000100000f60 T __ZN4util6Widget11doSomethingEi
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Note: GNU <code>nm</code> on Linux distros will have a <code>--demangle</code> option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>nm --demangle a.out
</span><span class='line'>...
</span><span class='line'>00000000004006d0 T util::Widget::doSomething<span class="o">(</span>bool<span class="o">)</span>
</span><span class='line'>00000000004006a0 T util::Widget::doSomething<span class="o">(</span>int<span class="o">)</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>On OSX, we can pipe <code>nm</code> into <code>c++filt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>nm a.out | c++filt
</span><span class='line'>0000000100000f70 T util::Widget::doSomething<span class="o">(</span>bool<span class="o">)</span>
</span><span class='line'>0000000100000f60 T util::Widget::doSomething<span class="o">(</span>int<span class="o">)</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Finally, if you don&rsquo;t have an object file, but instead a backtrace that needs
demangling, you can either invoke <code>c++filt</code> manually or use
<a href="http://demangler.com/">demangler.com</a>.</p>

<p>Rust also mangles its function names.  For FFI or interface with C functions,
other languages usually have to look for or expose symbols in a manner suited
to C, the lowest common denominator.
<a href="http://en.cppreference.com/w/cpp/language/language_linkage">C++</a>
has <code>extern "C"</code> blocks and
<a href="https://doc.rust-lang.org/book/ffi.html">Rust</a>
has <code>extern</code> blocks.</p>

<p>We can use <code>strip</code> to remove symbols from a binary.  This can slim down a
binary at the cost of making stack traces unreadable.  If you&rsquo;re following
along at home, try comparing the output from your disassembler and <code>nm</code> before
and after running <code>strip</code> on the executable.  Luckily, you can&rsquo;t strip the
symbols out of object files, otherwise they&rsquo;d be useless as you&rsquo;d no longer be
able to link them.</p>

<p>If we compile with the <code>-g</code> flag, we can create a different kind of symbol;
<a href="https://en.wikipedia.org/wiki/Debug_symbol">debug symbols</a>.
Depending on your compiler+host OS, you&rsquo;ll get another file you can run through
<code>nm</code> to see an entry per symbol.  You&rsquo;ll get more info by using <code>dwarfdump</code> on
this file.  Debug symbols will retain source information such as filename and
line number for all symbols.</p>

<p>This post should have been a simple refresher of some of the basics of working
with C code. Finding symbols to be placed into a final executable and
relocating addresses are the main job of the linker, and will be the main theme
of the posts in this series. Keep your eyes out for more in this series on
memory segmentation.</p>

<ul>
<li><a href="/blog/2016/08/13/object-files-and-symbols/">Part 1 &ndash; Object Files and Symbols</a></li>
<li><a href="/blog/2016/11/20/static-and-dynamic-libraries/">Part 2 &ndash; Static and Dynamic Libraries</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/01/android-cli/">Cross Compiling C/C++ for Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-07-01T22:42:00-07:00" pubdate data-updated="true">Jul 1<span>st</span>, 2016</time>
        
         | <a href="/blog/2016/07/01/android-cli/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let’s say you want to build a hello world command line application in C or C++
and run it on your Android phone.  How would you go about it?  It’s not super
practical; apps visible and distributable to end users must use the framework
(AFAIK), but for folks looking to get into developing on ARM it’s likely they
have an ARM device in their pocket.</p>

<p>This post is for folks who typically invoke their compiler from the command
line, either explicitly, from build scripts, or other forms of automation.</p>

<p>At
<a href="https://twitter.com/LostOracle/status/697859368226697218">work</a>,
when working on Android, we typically checkout the entire Android source code
(<a href="https://twitter.com/LostOracle/status/702569487531249664">which is huge</a>),
use <code>lunch</code> to configure a ton of environmental variables, then use Makefiles
with lots of includes and special vars.  We don’t want to spend the time and
disk space checking out the Android source code just to have a working cross
compiler.  Luckily, the Android tools team has an excellent utility to grab a
prebuilt cross compiler.</p>

<p>This assumes you’re building from a Linux host.  Android is a distribution of
Linux, which is much easier to target from a Linux host.  At home, I’ll usually
develop on my OSX machine, ssh’d into my headless Linux box. (iTerm2 and tmux
both have exclusive features, but I currently prefer iTerm2.)</p>

<p>The first thing we want to do is fetch the
<a href="https://developer.android.com/ndk/downloads/index.html">Android NDK</a>.
Not the SDK, the NDK.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  ~ curl -O <span class="se">\</span>
</span><span class='line'>  http://dl.google.com/android/repository/android-ndk-r12b-linux-x86_64.zip
</span><span class='line'>➜  ~ unzip android-ndk-r12b-linux-x86_64.zip
</span></code></pre></td></tr></table></div></figure>


<p>It would be helpful to install adb and fastboot, too.  This might be different
for your distro’s package manager.  Better yet may be to just build from
source.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  ~ sudo apt-get install android-tools-adb android-tools-fastboot
</span></code></pre></td></tr></table></div></figure>


<p>Now for you Android device that you want to target, you’ll want to know the
ISA.  Let’s say I want to target my Nexus 6P, which has an ARMv8-A ISA (the
first 64b ARM ISA).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  ~ ./android-ndk-r12b/build/tools/make_standalone_toolchain.py --arch arm64 <span class="se">\</span>
</span><span class='line'>  --install-dir ~/arm
</span></code></pre></td></tr></table></div></figure>


<p>This will create a nice standalone bundle in <code>~/arm</code>.  It will contain our
cross compiler, linker, headers, libs, and
<a href="https://twitter.com/LostOracle/status/749297676223598592">sysroot (crt.o and friends)</a>.
Most Android devices are ARMv7-A, so you’d use <code>--arch arm</code>.  See the other
supported architectures for cross compiling under
<a href="https://developer.android.com/ndk/guides/standalone_toolchain.html#itc">table 4</a>.</p>

<p>You might also want to change your install-dir and possible add it to your
<code>$PATH</code>, or set <code>$CC</code> and <code>$CXX</code>.</p>

<p>Now we can compile <code>hello_world.c</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  ~ cat hello_world.c
</span><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'>int main <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  puts<span class="o">(</span><span class="s2">&quot;hello world&quot;</span><span class="o">)</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>➜  ~ ~/arm/bin/clang -pie hello_world.c
</span><span class='line'>➜  ~ file a.out
</span><span class='line'>a.out: ELF 64-bit LSB shared object, ARM aarch64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically
</span><span class='line'>linked, interpreter /system/bin/linker64,
</span><span class='line'>BuildID<span class="o">[</span>sha1<span class="o">]=</span>ecc46648cf2c873253b3b522c0d14b91cf17c70f, not stripped
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://stackoverflow.com/a/30547603">Since Android Lollipop</a>,
Android has required that executables be linked as
position independent (<code>-pie</code>) to help provide
<a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization#Android">ASLR</a>.</p>

<p><code>&lt;install-dir&gt;/bin/</code> also has shell scripts with more full featured names like
<code>aarch64-linux-android-clang</code> if you prefer to have clearer named executables
in your $PATH.</p>

<p>Connect your phone, enable remote debugging, and accept the prompt for remote
debugging.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  ~ adb push a.out /data/local/tmp/.
</span><span class='line'>➜  ~ adb shell <span class="s2">&quot;./data/local/tmp/a.out&quot;</span>
</span><span class='line'>hello world
</span></code></pre></td></tr></table></div></figure>


<p>We’ll use this toolchain in a follow post to start writing some ARMv8-A
assembly.  Stay tuned.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/18/mutt-gmail-ubuntu/">Setting Up Mutt With Gmail on Ubuntu</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-18T16:26:00-07:00" pubdate data-updated="true">Jun 18<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/06/18/mutt-gmail-ubuntu/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was looking to set up the
<a href="http://www.mutt.org/">mutt</a>
email client on my Ubuntu box to go through my gmail account.  Since it took me
a couple of hours to figure out, and I’ll probably forget by the time I need to
know again, I figure I’d post my steps here.</p>

<p>I’m on Ubuntu 16.04 LTS (<code>lsb_release -a</code>)</p>

<p>Install mutt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo apt-get install mutt
</span></code></pre></td></tr></table></div></figure>


<p>In gmail, allow other apps to access gmail:</p>

<p><a href="https://support.google.com/accounts/answer/6010255?hl=en">Allowing less secure apps to access your account</a>
<a href="https://www.google.com/settings/security/lesssecureapps">Less Secure Apps</a></p>

<p>Create the folder</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo touch <span class="nv">$MAIL</span>
</span><span class='line'><span class="nv">$ </span>sudo chmod 660 <span class="nv">$MAIL</span>
</span><span class='line'><span class="nv">$ </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span>:mail <span class="nv">$MAIL</span>
</span></code></pre></td></tr></table></div></figure>


<p>where <code>$MAIL</code> for me was <code>/var/mail/nick</code>.</p>

<p>Create the ~/.muttrc file</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">set </span><span class="nv">realname</span> <span class="o">=</span> <span class="s2">&quot;&lt;first and last name&gt;&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">from</span> <span class="o">=</span> <span class="s2">&quot;&lt;gmail username&gt;@gmail.com&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">use_from</span> <span class="o">=</span> yes
</span><span class='line'><span class="nb">set </span><span class="nv">envelope_from</span> <span class="o">=</span> yes
</span><span class='line'>
</span><span class='line'><span class="nb">set </span><span class="nv">smtp_url</span> <span class="o">=</span> <span class="s2">&quot;smtps://&lt;gmail username&gt;@gmail.com@smtp.gmail.com:465/&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">smtp_pass</span> <span class="o">=</span> <span class="s2">&quot;&lt;gmail password&gt;&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">imap_user</span> <span class="o">=</span> <span class="s2">&quot;&lt;gmail username&gt;@gmail.com&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">imap_pass</span> <span class="o">=</span> <span class="s2">&quot;&lt;gmail password&gt;&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">folder</span> <span class="o">=</span> <span class="s2">&quot;imaps://imap.gmail.com:993&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">spoolfile</span> <span class="o">=</span> <span class="s2">&quot;+INBOX&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">ssl_force_tls</span> <span class="o">=</span> yes
</span><span class='line'>
</span><span class='line'><span class="c"># G to get mail</span>
</span><span class='line'><span class="nb">bind </span>index G imap-fetch-mail
</span><span class='line'><span class="nb">set </span><span class="nv">editor</span> <span class="o">=</span> <span class="s2">&quot;vim&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">charset</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
</span><span class='line'><span class="nb">set </span><span class="nv">record</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I’m sure there’s better/more config options.  Feel free to go wild, this is by
no means a comprehensive setup.</p>

<p>Run mutt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mutt
</span></code></pre></td></tr></table></div></figure>


<p>We should see it connect and download our messages.  <code>m</code> to start sending new
messages. <code>G</code> to fetch new messages.</p>

<p><img class="center" src="/images/mutt.png"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/30/data-models-and-word-size/">Data Models and Word Size</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-30T12:54:00-07:00" pubdate data-updated="true">May 30<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/05/30/data-models-and-word-size/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post is a follow up to
<a href="/blog/2016/05/15/whats-in-a-word/">my previous blog post about word size</a>.</em></p>

<p>Three C/C++ programmers walk into a bar.  One argues that sizeof(void*) is
equivalent to sizeof(long), one argues that sizeof(void*) is equivalent to
sizeof(int), and the third argues it’s sizeof(long long).  Simultaneously,
they’re all right, but they’re also all wrong (and need a lesson about portable
C code).  What the hell is going on?</p>

<p>One of the first few programs a programmer might write after hello world is
something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(int): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(long): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(long long): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(void*): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note the use of the %zu format specifier, a C99 addition that isn’t portable to
older compilers!  (This post is more about considerations when porting older
code to newer machines, not about porting newer code to run on older machines.
Not having a standards compliant C compiler makes writing more portable C code
even trickier, and is a subject for another blog post).</em></p>

<p>When I run that code on my x86-64 OSX machine, I get the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 8
</span></code></pre></td></tr></table></div></figure>


<p>So it looks like I would be the first programmer in the story in the first
paragraph, since on my machine, it looks like sizeof(long) == sizeof(void*).
Also note how sizeof(long long) is equivalent as well.</p>

<p>But what would happen if I compiled my code on a 32 bit machine?  Luckily, my
processor has backwards compatibility with 32b binaries, so I can cross compile
it locally and still run it. Ex:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  clang sizeof.c -Wall -Wextra -Wpedantic
</span><span class='line'>➜  file a.out
</span><span class='line'>a.out: Mach-O 64-bit executable x86_64
</span><span class='line'>➜  clang sizeof.c -Wall -Wextra -Wpedantic -m32
</span><span class='line'>➜  file a.out
</span><span class='line'>a.out: Mach-O executable i386
</span><span class='line'>➜  ./a.out
</span><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 4
</span></code></pre></td></tr></table></div></figure>


<p>Huh, suddenly sizeof(void*) == sizeof(int) == sizeof(long)!  This seems
to be the case of the second programmer from the story.</p>

<p>Both programmer 1 and programmer 2 might agree that the size of a pointer is
equivalent to their machine’s respective
<a href="/blog/2016/05/15/whats-in-a-word/">word size</a>,
but that too would be an incorrect assumption for portable C/C++ code!</p>

<p>Programmer 3 goes through the hellscape that is installing a working compiler
for Windows and building a 64b command line application (to be fair, installing
command line tools for OSX is worse; installing a compiler for most OS’ leaves
much to be desired).  When they run that program, they see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 8
</span></code></pre></td></tr></table></div></figure>


<p>This is yet a third case (the third programmer from the story).  In this case,
only sizeof(long long) is equivalent to sizeof(void*).</p>

<h3>Data Models</h3>

<p>What these programmers are seeing is known as data models.  Programmer 1 one on
a 64b x86-64 OSX machine had an LP64 data model where longs (L), (larger long
longs,) and pointers (P) are 64b, but ints were 32b.  Programmer 2 on a 32b x86
OSX machine had an ILP32 data model where ints (I), longs (L), and pointers (P)
were 32b, but long longs were 64b.  Programmer 3 on a 64b x86-64 Windows
machine had a LLP64 data model, where only long longs (LL) and pointers (P)
were 64b, ints and longs being 32b.</p>

<table>
<thead>
<tr>
<th><strong>Data model</strong> </th>
<th> <strong>sizeof(int)</strong> </th>
<th> <strong>sizeof(long)</strong> </th>
<th> <strong>sizeof(long long)</strong> </th>
<th> <strong>sizeof(void*)</strong> </th>
<th> <strong>example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ILP32 </td>
<td> 32b </td>
<td> 32b </td>
<td> 64b </td>
<td> 32b </td>
<td> Win32, i386 OSX &amp; Linux</td>
</tr>
<tr>
<td>LP64 </td>
<td> 32b </td>
<td> 64b </td>
<td> 64b </td>
<td> 64b </td>
<td> x86-64 OSX &amp; Linux</td>
</tr>
<tr>
<td>LLP64 </td>
<td> 32b </td>
<td> 32b </td>
<td> 64b </td>
<td> 64b </td>
<td> Win64</td>
</tr>
</tbody>
</table>


<p>There are older data models such as LP32 (Windows 3.1, Macintosh, where ints
are 16b), and more exotic ones like ILP64, and SILP64.  Knowing the data model
thus is important for portable C/C++ code.</p>

<h3>Historical Perspective</h3>

<p>Running out of address space is and will continue to be tradition in computing.
Applications become bigger as computer power and memory gets cheaper.
Companies want to sell chips that have larger word sizes to address more
memory, but early adopters don’t want to buy a computer where there favorite
application hasn’t been compiled and thus doesn’t exist on yet.  <strong>Someone from
the back shouts <em>virtual machines</em> then ducks as a chair is thrown.</strong></p>

<p><a href="http://www.unix.org/version2/whatsnew/lp64_wp.html">This document</a>
highlights some reasons why LP64 is preferred to ILP64: ILP64
made portable C code that only needed 32b of precision harder to maintain (on
ILP64 an int was 64b, but a short was 16b!).  It mentions how for data
structures that did not contain pointers, their size would be the same on LLP64
as ILP32, which is the direction Microsoft went.  LLP64 was essentially the
ILP32 model with 64b pointers.</p>

<p><em>Linux also supports an ABI called
<a href="https://en.wikipedia.org/wiki/X32_ABI">x32</a>
which can use x86-64 ISA improvements but uses 32b pointers to reduce the size
of data structures that would otherwise have 64b pointers.</em></p>

<p>For a great historical perspective on the evolution of word size and data
models, as well as the &ldquo;toil and trouble&rdquo; caused,
<a href="https://queue.acm.org/detail.cfm?id=1165766">this paper</a>
was an excellent reference.  It describes Microsoft finally abandoning support
for 16b data models in Windows XP 64.  It mentions that the industry was pretty
split between LP64, LLP64, and ILP64 as porting code from the good old days of
ILP32 would break in different ways.  That the use of long was more prevalent
in Windows applications vs the use of int in unix applications.  It also makes
the key point that a lot of programmers from the ILP32 era made assumptions
that sizeof(int) == sizeof(long) == sizeof(void*) which would not hold true
for the LP64/LLP64 era.</p>

<p>One important point the paper makes makes that’s easily missed is that typedef
wasn’t added to C until 1977 when hardware manufactures still couldn’t agree on
how many bits were in a char (CHAR_BITS) and some machines were using 24b
addressing schemes.  stdint.h and inttypes.h did not exist yet.</p>

<p><a href="/blog/2016/05/15/whats-in-a-word/">This article</a>
talks about two main categories of effects of switching from ILP32 to LP64 and
has excellent examples of problematic code.  That section near the end is worth
the read alone and makes excellent points to look for during code review.</p>

<h3>Conclusion</h3>

<p>Word size or ISA doesn’t tell you anything about sizeof(int), sizeof(long), or
sizeof(long long).  We also saw that one machine can support multiple different
data models (when I compiled and ran the same code with the -m32 flag).</p>

<p>The C standard tells you minimum guaranteed sizes for these types, but the data
model (part of the ABI, external to but abiding by the C standard) is what
tells you about the specifics sizes of standard integers and pointers.</p>

<h3>Further Reading</h3>

<ul>
<li><a href="http://www.unix.org/version2/whatsnew/lp64_wp.html">64-Bit Programming Models: Why LP64?</a></li>
<li><a href="https://queue.acm.org/detail.cfm?id=1165766">The Long Road to 64 Bits</a></li>
<li><a href="http://www.unix.org/whitepapers/64bit.html">The UNIX System &mdash; 64bit and Data Size Neutrality</a></li>
<li><a href="https://en.wikipedia.org/wiki/64-bit_computing#64-bit_data_models">64-bit data models</a></li>
<li><a href="https://docs.oracle.com/cd/E19620-01/805-3024/lp64-1/index.html">C Language Data Type Models: LP64 and ILP32</a></li>
<li><a href="https://blogs.oracle.com/nike/entry/ilp64_lp64_llp64">ILP64, LP64, LLP64</a></li>
<li><a href="https://en.wikipedia.org/wiki/X32_ABI">x32 ABI</a></li>
<li><a href="http://stackoverflow.com/a/9162072">difference between stdint.h and inttypes.h</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384083%28v=vs.85%29.aspx">Abstract Data Models</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384264%28v=vs.85%29.aspx">The New Data Types</a></li>
<li><a href="http://stackoverflow.com/a/13413892">Is there any reason not to use fixed width integer types (e.g. uint8_t)?</a></li>
<li><a href="https://blogs.msdn.microsoft.com/oldnewthing/20050131-00/?p=36563/">Why did the Win64 team choose the LLP64 model?</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/15/whats-in-a-word/">What&#8217;s in a Word?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-15T17:58:00-07:00" pubdate data-updated="true">May 15<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/05/15/whats-in-a-word/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, there some was some confusion between myself and a coworker over the
definition of a &ldquo;word.&rdquo;  I&rsquo;m currently working on a blog post about data
alignment and figured it would be good to clarify some things now, that we can
refer to later.</p>

<p>Having studied computer engineering and being quite fond of processor design,
when I think of a &ldquo;word,&rdquo; I think of the number of bits wide a processor&rsquo;s
general purpose registers are
(aka <a href="https://en.wikipedia.org/wiki/Word_%28computer_architecture%29#Size_families">word size</a>).
This places hard requirements on the largest representable number and address
space.  A 64 bit processor can represent 2<sup>64</sup>-1 (1.8x10<sup>19</sup>) as the largest
unsigned long integer, and address up to 2<sup>64</sup>-1 (16 EiB) different addresses in
memory.</p>

<p>Further, word size limits the possible combinations of operations the processor
can perform, length of immediate values used, inflates the size of binary files
and memory needed to store pointers, and puts pressure on instruction caches.</p>

<p>Word size also has implications on loads and stores based on alignment, as
we&rsquo;ll see in a follow up post.</p>

<p>When I think of 8 bit computers, I think of my first microcontroller: an
Arduino with an Atmel AVR processor.  When I think of 16 bit computers, I think
of my first game console, a Super Nintendo with a Ricoh 5A22.  When I think of
32 bit computers, I think of my first desktop with Intel&rsquo;s Pentium III.  And
when I think of 64 bit computers, I think modern smartphones with ARMv8
instruction sets.  When someone mentions a particular word size, what are the
machines that come to mind for you?</p>

<p>So to me, when someone&rsquo;s talking about a 64b processor, to that machine (and
me) a word is 64b.  When we&rsquo;re referring to a 8b processor, a word is 8b.</p>

<p>Now, some confusion.</p>

<p>Back in my previous blog posts about
<a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 assembly</a>,
<a href="/blog/2015/05/25/interpreter-compiler-jit/">JITs</a>, or
<a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/">debugging</a>,
you might have seen me use instructions that have suffixes of b for byte (8b),
w for word (16b), dw for double word (32b), and qw for quad word (64b) (since
SSE2 there&rsquo;s also double quadwords of 128b).</p>

<p>Wait a minute!  How suddenly does a &ldquo;word&rdquo; refer to 16b on a 64b processor, as
opposed to a 64b &ldquo;word?&rdquo;</p>

<p>In short, historical baggage.  Intel&rsquo;s first hit processor was the
<a href="https://en.wikipedia.org/wiki/Intel_4004">4004</a>,
a 4b processor released in 1971.  It wasn&rsquo;t until 1979 that Intel created the
16b
<a href="https://en.wikipedia.org/wiki/Intel_8086">8086 processor</a>.</p>

<p>The 8086 was created to compete with other 16b processors that beat it to the
market, like the
<a href="https://en.wikipedia.org/wiki/Zilog_Z80">Zilog Z80</a>
(any Gameboy emulator fans out there?  Yes, I know about the Sharp LR35902).
The 8086 was the first design in the
<a href="https://en.wikipedia.org/wiki/X86">x86 family</a>,
and it allowed for the same assembly syntax from the earlier 8008, 8080, and
8085 to be reassembled for it.  The 8086&rsquo;s little brother (8088) would be used
in
<a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer#Open_standards">IBM&rsquo;s PC</a>,
and the rest is history.  x86 would become one of the most successful
ISAs in history.</p>

<p>For backwards compatibility, it seems that both Microsoft&rsquo;s (whose success has
tracked that of x86 since MS-DOS and IBM&rsquo;s PC) and Intel&rsquo;s documentation refers
to words still as being 16b. This allowed 16b PE32+ executables to be run on
32b or even 64b newer versions of Windows, without requiring recompilation of
source or source code modification.</p>

<p>This isn&rsquo;t necessarily wrong to refer to a word based on backwards
compatibility, it&rsquo;s just important to understand the context in which the term
&ldquo;word&rdquo; is being used, and that there might be some confusion if you have a
background with x86 assembly, Windows API programming, or processor design.</p>

<p>So the next time someone asks: why does Intel&rsquo;s documentation commonly refer to
a &ldquo;word&rdquo; as 16b, you can tell them that the x86 and x86-64 ISAs have maintained
the notion of a word being 16b since the first x86 processor, the 8086, which
was a 16b processor.</p>

<p><em>Side Note: for an excellent historical perspective programming early x86
chips, I recommend Michael Abrash&rsquo;s</em>
<a href="http://www.gamedev.net/page/resources/_/technical/graphics-programming-and-theory/graphics-programming-black-book-r1698">Graphics Programming Black Book</a>.
<em>For instance he talks about 8086&rsquo;s little brother, the 8088, being a 16b chip
but only having an 8b bus with which to access memory. This caused a mysterious</em>
<a href="http://downloads.gamedev.net/pdf/gpbb/gpbb4.pdf">&ldquo;cycle eater&rdquo;</a>
<em>to prevent fast access to 16b variables, though they were the processor&rsquo;s
natural size.  Michael also alludes to alignment issues we&rsquo;ll see in a follow
up post.</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/">Intro to Debugging X86-64 Assembly</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-20T20:04:00-08:00" pubdate data-updated="true">Jan 20<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m hacking on an assembly project, and wanted to document some of the tricks I
was using for figuring out what was going on.  This post might seem a little
basic for folks who spend all day heads down in gdb or who do this stuff
professionally, but I just wanted to share a quick intro to some tools that
others may find useful.
(<a href="https://pchiusano.github.io/2014-10-11/defensive-writing.html">oh god, I&rsquo;m doing it</a>)</p>

<p>If your coming from gdb to lldb, there&rsquo;s a few differences in commands.  LLDB
has
<a href="http://lldb.llvm.org/lldb-gdb.html">great documentation</a>
on some of the differences. Everything in this post about LLDB is pretty much
there.</p>

<p>The bread and butter commands when working with gdb or lldb are:</p>

<ul>
<li>r (run the program)</li>
<li>s (step in)</li>
<li>n (step over)</li>
<li>finish (step out)</li>
<li>c (continue)</li>
<li>q (quit the program)</li>
</ul>


<p>You can hit enter if you want to run the last command again, which is really
useful if you want to keep stepping over statements repeatedly.</p>

<p>I&rsquo;ve been using LLDB on OSX.  Let&rsquo;s say I want to debug a program I can build,
but is crashing or something:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo lldb ./asmttpd web_root
</span></code></pre></td></tr></table></div></figure>


<p>Setting a breakpoint on jump to label:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> b sys_write
</span><span class='line'>Breakpoint 3: <span class="nv">where</span> <span class="o">=</span> asmttpd<span class="sb">`</span>sys_write, <span class="nv">address</span> <span class="o">=</span> 0x00000000000029ae
</span></code></pre></td></tr></table></div></figure>


<p>Running the program until breakpoint hit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> r
</span><span class='line'>Process 32236 launched: <span class="s1">&#39;./asmttpd&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>
</span><span class='line'>Process 32236 stopped
</span><span class='line'>* thread <span class="c">#1: tid = 0xe69b9, 0x00000000000029ae asmttpd`sys_write, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1</span>
</span><span class='line'>    frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;: pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;: pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;: pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;: pushq  %r10
</span></code></pre></td></tr></table></div></figure>


<p>Seeing more of the current stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> d
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;:  pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;:  pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;:  pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;:  pushq  %r10
</span><span class='line'>    0x29b3 &lt;+5&gt;:  pushq  %r8
</span><span class='line'>    0x29b5 &lt;+7&gt;:  pushq  %r9
</span><span class='line'>    0x29b7 &lt;+9&gt;:  pushq  %rbx
</span><span class='line'>    0x29b8 &lt;+10&gt;: pushq  %rcx
</span><span class='line'>    0x29b9 &lt;+11&gt;: movq   %rsi, %rdx
</span><span class='line'>    0x29bc &lt;+14&gt;: movq   %rdi, %rsi
</span><span class='line'>    0x29bf &lt;+17&gt;: movq   <span class="nv">$0x1</span>, %rdi
</span><span class='line'>    0x29c6 &lt;+24&gt;: movq   <span class="nv">$0x2000004</span>, %rax
</span><span class='line'>    0x29cd &lt;+31&gt;: syscall
</span><span class='line'>    0x29cf &lt;+33&gt;: popq   %rcx
</span><span class='line'>    0x29d0 &lt;+34&gt;: popq   %rbx
</span><span class='line'>    0x29d1 &lt;+35&gt;: popq   %r9
</span><span class='line'>    0x29d3 &lt;+37&gt;: popq   %r8
</span><span class='line'>    0x29 &lt;+39&gt;: popq   %r10
</span><span class='line'>    0x29d7 &lt;+41&gt;: popq   %rdx
</span><span class='line'>    0x29d8 &lt;+42&gt;: popq   %rsi
</span><span class='line'>    0x29d9 &lt;+43&gt;: popq   %rdi
</span><span class='line'>    0x29da &lt;+44&gt;: retq
</span></code></pre></td></tr></table></div></figure>


<p>Getting a back trace (call stack):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> bt
</span><span class='line'>* thread <span class="c">#1: tid = 0xe69b9, 0x00000000000029ae asmttpd`sys_write, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1</span>
</span><span class='line'>  * frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>    frame <span class="c">#1: 0x00000000000021b6 asmttpd`print_line + 16</span>
</span><span class='line'>    frame <span class="c">#2: 0x0000000000002ab3 asmttpd`start + 35</span>
</span><span class='line'>    frame <span class="c">#3: 0x00007fff9900c5ad libdyld.dylib`start + 1</span>
</span><span class='line'>    frame <span class="c">#4: 0x00007fff9900c5ad libdyld.dylib`start + 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>peeking at the upper stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> up
</span><span class='line'>frame <span class="c">#1: 0x00000000000021b6 asmttpd`print_line + 16</span>
</span><span class='line'>asmttpd<span class="sb">`</span>print_line:
</span><span class='line'>    0x21b6 &lt;+16&gt;: movabsq <span class="nv">$0x30cb</span>, %rdi
</span><span class='line'>    0x21c0 &lt;+26&gt;: movq   <span class="nv">$0x1</span>, %rsi
</span><span class='line'>    0x21c7 &lt;+33&gt;: callq  0x29ae                    ; sys_write
</span><span class='line'>    0x21cc &lt;+38&gt;: popq   %rcx
</span></code></pre></td></tr></table></div></figure>


<p>back down to the breakpoint-halted stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> down
</span><span class='line'>frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;: pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;: pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;: pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;: pushq  %r10
</span></code></pre></td></tr></table></div></figure>


<p>dumping the values of registers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> register <span class="nb">read</span>
</span><span class='line'>General Purpose Registers:
</span><span class='line'>       <span class="nv">rax</span> <span class="o">=</span> 0x0000000000002a90  asmttpd<span class="sb">`</span>start
</span><span class='line'>       <span class="nv">rbx</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">rcx</span> <span class="o">=</span> 0x00007fff5fbffaf8
</span><span class='line'>       <span class="nv">rdx</span> <span class="o">=</span> 0x00007fff5fbffa40
</span><span class='line'>       <span class="nv">rdi</span> <span class="o">=</span> 0x00000000000030cc  start_text
</span><span class='line'>       <span class="nv">rsi</span> <span class="o">=</span> 0x000000000000000f
</span><span class='line'>       <span class="nv">rbp</span> <span class="o">=</span> 0x00007fff5fbffa18
</span><span class='line'>       <span class="nv">rsp</span> <span class="o">=</span> 0x00007fff5fbff9b8
</span><span class='line'>        <span class="nv">r8</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>        <span class="nv">r9</span> <span class="o">=</span> 0x00007fff7b1670c8  atexit_mutex + 24
</span><span class='line'>       <span class="nv">r10</span> <span class="o">=</span> 0x00000000ffffffff
</span><span class='line'>       <span class="nv">r11</span> <span class="o">=</span> 0xffffffff00000000
</span><span class='line'>       <span class="nv">r12</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r13</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r14</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r15</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">rip</span> <span class="o">=</span> 0x00000000000029ae  asmttpd<span class="sb">`</span>sys_write
</span><span class='line'>    <span class="nv">rflags</span> <span class="o">=</span> 0x0000000000000246
</span><span class='line'>        <span class="nv">cs</span> <span class="o">=</span> 0x000000000000002b
</span><span class='line'>        <span class="nv">fs</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>        <span class="nv">gs</span> <span class="o">=</span> 0x0000000000000000
</span></code></pre></td></tr></table></div></figure>


<p>read just one register:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> register <span class="nb">read </span>rdi
</span><span class='line'>     <span class="nv">rdi</span> <span class="o">=</span> 0x00000000000030cc  start_text
</span></code></pre></td></tr></table></div></figure>


<p>When you&rsquo;re trying to figure out what system calls are made by some C code,
using dtruss is very helpful.  dtruss is available on OSX and seems to be some
kind of wrapper around DTrace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat sleep.c
</span><span class='line'><span class="c">#include &lt;time.h&gt;</span>
</span><span class='line'>int main <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  struct timespec <span class="nv">rqtp</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    2,
</span><span class='line'>    0
</span><span class='line'>  <span class="o">}</span>;
</span><span class='line'>
</span><span class='line'>  nanosleep<span class="o">(</span>&amp;rqtp, NULL<span class="o">)</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>clang sleep.c
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo dtruss ./a.out
</span><span class='line'>...all kinds of fun stuff
</span><span class='line'>__semwait_signal<span class="o">(</span>0xB03, 0x0, 0x1<span class="o">)</span>    <span class="o">=</span> -1 Err#60
</span></code></pre></td></tr></table></div></figure>


<p>If you compile with <code>-g</code> to emit debug symbols, you can use lldb&rsquo;s disassemble
command to get the equivalent assembly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang sleep.c -g
</span><span class='line'><span class="nv">$ </span>lldb a.out
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> target create <span class="s2">&quot;a.out&quot;</span>
</span><span class='line'>Current executable <span class="nb">set </span>to <span class="s1">&#39;a.out&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>.
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> b main
</span><span class='line'>Breakpoint 1: <span class="nv">where</span> <span class="o">=</span> a.out<span class="sb">`</span>main + 16 at sleep.c:3, <span class="nv">address</span> <span class="o">=</span> 0x0000000100000f40
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> r
</span><span class='line'>Process 33213 launched: <span class="s1">&#39;/Users/Nicholas/code/assembly/asmttpd/a.out&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>
</span><span class='line'>Process 33213 stopped
</span><span class='line'>* thread <span class="c">#1: tid = 0xeca04, 0x0000000100000f40 a.out`main + 16 at sleep.c:3, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.1</span>
</span><span class='line'>    frame <span class="c">#0: 0x0000000100000f40 a.out`main + 16 at sleep.c:3</span>
</span><span class='line'>   1    <span class="c">#include &lt;time.h&gt;</span>
</span><span class='line'>   2    int main <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>-&gt; 3      struct timespec <span class="nv">rqtp</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>   4        2,
</span><span class='line'>   5        0
</span><span class='line'>   6      <span class="o">}</span>;
</span><span class='line'>   7
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> disassemble
</span><span class='line'>a.out<span class="sb">`</span>main:
</span><span class='line'>    0x100000f30 &lt;+0&gt;:  pushq  %rbp
</span><span class='line'>    0x100000f31 &lt;+1&gt;:  movq   %rsp, %rbp
</span><span class='line'>    0x100000f34 &lt;+4&gt;:  subq   <span class="nv">$0x20</span>, %rsp
</span><span class='line'>    0x100000f38 &lt;+8&gt;:  leaq   -0x10<span class="o">(</span>%rbp<span class="o">)</span>, %rdi
</span><span class='line'>    0x100000f3c &lt;+12&gt;: xorl   %eax, %eax
</span><span class='line'>    0x100000f3e &lt;+14&gt;: movl   %eax, %esi
</span><span class='line'>-&gt;  0x100000f40 &lt;+16&gt;: movq   0x49<span class="o">(</span>%rip<span class="o">)</span>, %rcx
</span><span class='line'>    0x100000f47 &lt;+23&gt;: movq   %rcx, -0x10<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f4b &lt;+27&gt;: movq   0x46<span class="o">(</span>%rip<span class="o">)</span>, %rcx
</span><span class='line'>    0x100000f52 &lt;+34&gt;: movq   %rcx, -0x8<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f56 &lt;+38&gt;: callq  0x100000f68               ; symbol stub <span class="k">for</span>: nanosleep
</span><span class='line'>    0x100000f5b &lt;+43&gt;: xorl   %edx, %edx
</span><span class='line'>    0x100000f5d &lt;+45&gt;: movl   %eax, -0x14<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f60 &lt;+48&gt;: movl   %edx, %eax
</span><span class='line'>    0x100000f62 &lt;+50&gt;: addq   <span class="nv">$0x20</span>, %rsp
</span><span class='line'>    0x100000f66 &lt;+54&gt;: popq   %rbp
</span><span class='line'>    0x100000f67 &lt;+55&gt;: retq
</span></code></pre></td></tr></table></div></figure>


<p>Anyways, I&rsquo;ve been learning some interesting things about OSX that I&rsquo;ll be
sharing soon. If you&rsquo;d like to learn more about x86-64 assembly programming,
you should read my other posts about
<a href="/blog/2014/04/18/lets-write-some-x86-64/">writing x86-64</a>
and a toy
<a href="/blog/2015/05/25/interpreter-compiler-jit/">JIT for Brainfuck</a>
(<a href="https://www.reddit.com/r/programming/comments/377ov9/interpreter_compiler_jit/crkkrz4">the creator of Brainfuck liked it</a>).</p>

<p>I should also do a post on
<a href="http://rr-project.org/">Mozilla&rsquo;s rr</a>,
because it can do amazing things like step backwards.  Another day&hellip;</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/09/05/gcc-vs-llvm-q3-2017-commit-rates-and-active-developer-counts/">GCC vs LLVM Q3 2017: Active Developer Counts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/31/running-clang-tidy-on-the-linux-kernel/">Running Clang-Tidy on the Linux Kernel</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/">Submitting Your First Patch to the Linux Kernel and Responding to Feedback</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/20/static-and-dynamic-libraries/">Static and Dynamic Libraries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/13/object-files-and-symbols/">Object Files and Symbols</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/nickdesaulniers">@nickdesaulniers</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nickdesaulniers',
            count: 20,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Nick Desaulniers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wangstabill';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
